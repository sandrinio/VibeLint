---
id: STORY-007-02
parent_epic: EPIC-007
status: Draft
actor: Backend Developer
complexity: Low (1 file)
---
# STORY-007-02: Freshness Monitor

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a freshness monitor that compares vdoc document timestamps to their source file timestamps,
**So that** the system can determine which documents are fresh, stale, or in an unknown state.

### 1.2 Detailed Requirements
- **Requirement 1**: Implement `checkFreshness(repoPath)` — for each document in the manifest, compare the document file's mtime to the mtimes of all its source files.
- **Requirement 2**: Return `VdocStatus[]` where each entry contains: `{ title, filename, status: 'fresh' | 'stale' | 'unknown', lastUpdated: string, staleReason?: string }`.
- **Requirement 3**: A document is "stale" if any of its source files have an mtime newer than the document file's mtime.
- **Requirement 4**: A document is "unknown" if source files are not found, the source files list is empty, or the manifest is missing source file references.
- **Requirement 5**: A document is "fresh" if all source files have mtimes older than or equal to the document file's mtime.
- **Requirement 6**: Use `fs.stat()` for all timestamp comparisons.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Freshness Monitor

  Scenario: All documents are fresh
    Given a repo with vdocs/ containing 2 documents
    And all source files have mtimes older than the document files
    When I call checkFreshness with the repo path
    Then all VdocStatus entries have status "fresh"
    And lastUpdated reflects each document's mtime

  Scenario: One document is stale
    Given a repo with vdocs/ containing 2 documents
    And one document's source file has an mtime newer than the document
    When I call checkFreshness with the repo path
    Then that document's VdocStatus has status "stale"
    And staleReason mentions the changed source file
    And the other document has status "fresh"

  Scenario: Source files not found
    Given a repo with vdocs/ containing a document
    And the manifest lists source files that do not exist on disk
    When I call checkFreshness with the repo path
    Then that document's VdocStatus has status "unknown"
    And staleReason mentions "source files not found"

  Scenario: No source files listed (inferred docs)
    Given a repo with vdocs/ containing documents inferred without a manifest
    And documents have empty sourceFiles arrays
    When I call checkFreshness with the repo path
    Then those documents have status "unknown"
    And staleReason mentions "no source files listed"

  Scenario: No vdocs directory
    Given a repo with no vdocs/ directory
    When I call checkFreshness with the repo path
    Then an empty array is returned

  Scenario: Mixed freshness states
    Given a repo with 3 documents: one fresh, one stale, one with missing sources
    When I call checkFreshness with the repo path
    Then the result contains one "fresh", one "stale", and one "unknown" entry
```

### 2.2 Verification Steps
- [ ] `checkFreshness` returns `VdocStatus[]` with correct status for each document.
- [ ] "stale" status is set when any source file mtime > document file mtime.
- [ ] "unknown" status is set when source files are missing or not listed.
- [ ] "fresh" status is set when all source file mtimes <= document file mtime.
- [ ] `lastUpdated` is the ISO string of the document file's mtime.
- [ ] Returns an empty array when `vdocs/` does not exist.
- [ ] `staleReason` provides a human-readable explanation.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/vdoc/monitor.ts` (extend with freshness logic)
- **Related Files**: `src/server/vdoc/monitor.ts` (parseManifest from STORY-007-01)
- **New Files Needed**: None (extends existing file from STORY-007-01)

### 3.2 Technical Logic

**Step 1: Define the VdocStatus type**

Add to `src/server/vdoc/monitor.ts`:

```typescript
/** Freshness status for a single vdoc document */
export interface VdocStatus {
  /** Document title */
  title: string;
  /** Filename within vdocs/ */
  filename: string;
  /** Freshness status */
  status: 'fresh' | 'stale' | 'unknown';
  /** ISO timestamp of the document file's last modification */
  lastUpdated: string;
  /** Explanation of why the document is stale or unknown */
  staleReason?: string;
}
```

**Step 2: Implement `checkFreshness`**

```typescript
import fs from 'node:fs';
import path from 'node:path';

/**
 * Check the freshness of all vdoc documents in a repo.
 * Compares document file mtimes to their source file mtimes.
 *
 * @param repoPath - Absolute path to the repo root
 * @returns Array of VdocStatus entries, one per document. Empty array if no vdocs.
 */
export function checkFreshness(repoPath: string): VdocStatus[] {
  const manifest = parseManifest(repoPath);

  if (!manifest || manifest.documents.length === 0) {
    return [];
  }

  const vdocsDir = path.join(repoPath, 'vdocs');
  const results: VdocStatus[] = [];

  for (const doc of manifest.documents) {
    const docPath = path.join(vdocsDir, doc.filename);

    // Get document file stat
    let docStat: fs.Stats;
    try {
      docStat = fs.statSync(docPath);
    } catch {
      // Document file itself doesn't exist — skip or mark unknown
      results.push({
        title: doc.title,
        filename: doc.filename,
        status: 'unknown',
        lastUpdated: doc.generatedAt,
        staleReason: 'Document file not found on disk',
      });
      continue;
    }

    const docMtime = docStat.mtime;
    const lastUpdated = docMtime.toISOString();

    // If no source files listed, status is unknown
    if (!doc.sourceFiles || doc.sourceFiles.length === 0) {
      results.push({
        title: doc.title,
        filename: doc.filename,
        status: 'unknown',
        lastUpdated,
        staleReason: 'No source files listed in manifest',
      });
      continue;
    }

    // Check each source file's mtime against the document's mtime
    const staleFiles: string[] = [];
    let hasUnknownSource = false;
    const missingFiles: string[] = [];

    for (const sourceFile of doc.sourceFiles) {
      const sourcePath = path.join(repoPath, sourceFile);

      let sourceStat: fs.Stats;
      try {
        sourceStat = fs.statSync(sourcePath);
      } catch {
        missingFiles.push(sourceFile);
        hasUnknownSource = true;
        continue;
      }

      if (sourceStat.mtime > docMtime) {
        staleFiles.push(sourceFile);
      }
    }

    // Determine status
    if (staleFiles.length > 0) {
      results.push({
        title: doc.title,
        filename: doc.filename,
        status: 'stale',
        lastUpdated,
        staleReason: `Source files changed since doc was generated: ${staleFiles.join(', ')}`,
      });
    } else if (
      hasUnknownSource &&
      missingFiles.length === doc.sourceFiles.length
    ) {
      // All source files are missing
      results.push({
        title: doc.title,
        filename: doc.filename,
        status: 'unknown',
        lastUpdated,
        staleReason: `Source files not found: ${missingFiles.join(', ')}`,
      });
    } else if (hasUnknownSource) {
      // Some source files missing but others are fresh
      results.push({
        title: doc.title,
        filename: doc.filename,
        status: 'unknown',
        lastUpdated,
        staleReason: `Some source files not found: ${missingFiles.join(', ')}`,
      });
    } else {
      results.push({
        title: doc.title,
        filename: doc.filename,
        status: 'fresh',
        lastUpdated,
      });
    }
  }

  return results;
}
```

**Step 3: Example flow**

```
Given:
  vdocs/PROJECT_OVERVIEW.md — mtime: 2026-02-20 14:30
  src/server/index.ts — mtime: 2026-02-22 09:00 (newer!)
  src/client/App.tsx — mtime: 2026-02-19 10:00 (older)

Result:
  {
    title: "Project Overview",
    filename: "PROJECT_OVERVIEW.md",
    status: "stale",
    lastUpdated: "2026-02-20T14:30:00.000Z",
    staleReason: "Source files changed since doc was generated: src/server/index.ts"
  }
```

**Step 4: Handle edge cases**

- Symlinked source files: `fs.statSync` follows symlinks by default, which is correct.
- Source file paths with `../`: `path.join` resolves these safely within the repo path.
- Very large source file lists (50+): The loop is O(n) with a stat call per file; should be fast enough for typical repos.

### 3.3 API Contract
N/A — this is an internal utility. The API endpoint is covered in STORY-007-03.

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/vdoc/monitor.ts` exports `checkFreshness(repoPath)` function.
- [ ] `VdocStatus` type is exported with `title`, `filename`, `status`, `lastUpdated`, and optional `staleReason`.
- [ ] "stale" is returned when any source file mtime is newer than the document file mtime.
- [ ] "unknown" is returned when source files are missing or not listed.
- [ ] "fresh" is returned when all source file mtimes are older than or equal to the document mtime.
- [ ] `staleReason` provides human-readable details about which files changed.
- [ ] Returns an empty array when no vdocs exist.
- [ ] TypeScript compiles with no errors (`npx tsc --noEmit`).
