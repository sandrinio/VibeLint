---
id: STORY-007-01
parent_epic: EPIC-007
status: Draft
actor: Backend Developer
complexity: Low (1 file)
---
# STORY-007-01: vdoc Manifest Parser

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a manifest parser that reads and validates `vdocs/_manifest.json` from a repository,
**So that** the freshness monitor can determine which documents exist, their source files, and when they were generated.

### 1.2 Detailed Requirements
- **Requirement 1**: Implement `parseManifest(repoPath)` — reads `vdocs/_manifest.json` from the given repo path and returns a parsed `VdocManifest` object.
- **Requirement 2**: Define `VdocManifest` type: `{ documents: Array<{ title: string, filename: string, sourceFiles: string[], generatedAt: string }> }`.
- **Requirement 3**: Handle the case where `_manifest.json` does not exist — return `null`.
- **Requirement 4**: Handle malformed JSON — return `null` and log a warning.
- **Requirement 5**: If no manifest exists, attempt to infer documents by listing `vdocs/*.md` files directly (excluding `_manifest.json` itself).
- **Requirement 6**: Validate the manifest structure: ensure `documents` is an array and each entry has the required fields.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: vdoc Manifest Parser

  Scenario: Valid manifest exists
    Given a repo at "/tmp/test-repo" with vdocs/_manifest.json containing valid JSON
    When I call parseManifest("/tmp/test-repo")
    Then a VdocManifest object is returned
    And documents array contains the entries from the manifest

  Scenario: Manifest does not exist
    Given a repo at "/tmp/test-repo" with no vdocs/ directory
    When I call parseManifest("/tmp/test-repo")
    Then null is returned

  Scenario: Manifest is malformed JSON
    Given a repo at "/tmp/test-repo" with vdocs/_manifest.json containing "{ invalid json"
    When I call parseManifest("/tmp/test-repo")
    Then null is returned
    And a warning is logged about malformed JSON

  Scenario: Manifest missing required fields
    Given a repo with vdocs/_manifest.json containing { "documents": [{ "title": "Foo" }] }
    When I call parseManifest
    Then null is returned because entries are missing required fields

  Scenario: No manifest but vdocs/*.md files exist
    Given a repo with vdocs/ containing "overview.md" and "auth.md" but no _manifest.json
    When I call parseManifest
    Then a VdocManifest is returned with inferred documents
    And each document has filename set and sourceFiles as empty array
    And generatedAt is set from the file's mtime

  Scenario: vdocs/ directory exists but is empty
    Given a repo with an empty vdocs/ directory and no _manifest.json
    When I call parseManifest
    Then null is returned
```

### 2.2 Verification Steps
- [ ] `parseManifest` returns a valid `VdocManifest` for a correctly structured `_manifest.json`.
- [ ] `parseManifest` returns `null` when `vdocs/` does not exist.
- [ ] `parseManifest` returns `null` for malformed JSON with a warning logged.
- [ ] When no manifest exists but `*.md` files are in `vdocs/`, documents are inferred from the file listing.
- [ ] Inferred documents have `sourceFiles` set to an empty array and `generatedAt` set from `fs.stat` mtime.
- [ ] Manifest validation rejects entries missing `title`, `filename`, or `sourceFiles`.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/vdoc/monitor.ts` (partial — this story covers manifest parsing only)
- **Related Files**: None (greenfield module)
- **New Files Needed**:
  - `src/server/vdoc/monitor.ts`

### 3.2 Technical Logic

**Step 1: Define the VdocManifest type**

```typescript
/** A single document entry in the vdoc manifest */
export interface VdocDocument {
  /** Human-readable document title */
  title: string;
  /** Filename within vdocs/, e.g. "PROJECT_OVERVIEW.md" */
  filename: string;
  /** Source files this doc was generated from (relative to repo root) */
  sourceFiles: string[];
  /** ISO timestamp of when this doc was generated */
  generatedAt: string;
}

/** Parsed vdoc manifest structure */
export interface VdocManifest {
  documents: VdocDocument[];
}
```

**Step 2: Implement `parseManifest`**

```typescript
import fs from 'node:fs';
import path from 'node:path';

/**
 * Parse the vdoc manifest file from a repo.
 * Returns null if the manifest doesn't exist, is malformed, or is invalid.
 * Falls back to inferring documents from vdocs/*.md files if no manifest exists.
 *
 * @param repoPath - Absolute path to the repo root
 * @returns Parsed VdocManifest or null
 */
export function parseManifest(repoPath: string): VdocManifest | null {
  const vdocsDir = path.join(repoPath, 'vdocs');
  const manifestPath = path.join(vdocsDir, '_manifest.json');

  // Check if vdocs/ directory exists at all
  if (!fs.existsSync(vdocsDir) || !fs.statSync(vdocsDir).isDirectory()) {
    return null;
  }

  // Try reading the manifest file
  if (fs.existsSync(manifestPath)) {
    return parseManifestFile(manifestPath);
  }

  // No manifest — try to infer from file listing
  return inferFromFiles(vdocsDir);
}

/**
 * Parse and validate the _manifest.json file.
 */
function parseManifestFile(manifestPath: string): VdocManifest | null {
  let raw: string;
  try {
    raw = fs.readFileSync(manifestPath, 'utf-8');
  } catch (err) {
    console.warn(
      `[vdoc] Could not read manifest: ${manifestPath}`,
      err
    );
    return null;
  }

  let parsed: unknown;
  try {
    parsed = JSON.parse(raw);
  } catch {
    console.warn(
      `[vdoc] Malformed JSON in manifest: ${manifestPath}`
    );
    return null;
  }

  // Validate structure
  if (!isValidManifest(parsed)) {
    console.warn(
      `[vdoc] Invalid manifest structure: ${manifestPath}`
    );
    return null;
  }

  return parsed as VdocManifest;
}

/**
 * Validate that the parsed object matches the VdocManifest shape.
 */
function isValidManifest(obj: unknown): boolean {
  if (typeof obj !== 'object' || obj === null) return false;

  const manifest = obj as Record<string, unknown>;
  if (!Array.isArray(manifest.documents)) return false;

  for (const doc of manifest.documents) {
    if (typeof doc !== 'object' || doc === null) return false;

    const d = doc as Record<string, unknown>;
    if (typeof d.title !== 'string') return false;
    if (typeof d.filename !== 'string') return false;
    if (!Array.isArray(d.sourceFiles)) return false;
    if (typeof d.generatedAt !== 'string') return false;

    // Validate sourceFiles are all strings
    for (const sf of d.sourceFiles) {
      if (typeof sf !== 'string') return false;
    }
  }

  return true;
}

/**
 * Infer documents from vdocs/*.md files when no manifest exists.
 * Sets sourceFiles to empty (unknown) and generatedAt from file mtime.
 */
function inferFromFiles(vdocsDir: string): VdocManifest | null {
  let entries: fs.Dirent[];
  try {
    entries = fs.readdirSync(vdocsDir, { withFileTypes: true });
  } catch {
    return null;
  }

  const mdFiles = entries.filter(
    (e) =>
      e.isFile() &&
      e.name.endsWith('.md') &&
      e.name !== '_manifest.json'
  );

  if (mdFiles.length === 0) {
    return null;
  }

  const documents: VdocDocument[] = mdFiles.map((entry) => {
    const filePath = path.join(vdocsDir, entry.name);
    const stat = fs.statSync(filePath);

    return {
      title: entry.name
        .replace('.md', '')
        .replace(/_/g, ' ')
        .replace(/\b\w/g, (c) => c.toUpperCase()),
      filename: entry.name,
      sourceFiles: [], // Unknown without manifest
      generatedAt: stat.mtime.toISOString(),
    };
  });

  return { documents };
}
```

**Step 3: Example _manifest.json for reference**

This is what vdoc generates; VibeLint only reads it:

```json
{
  "documents": [
    {
      "title": "Project Overview",
      "filename": "PROJECT_OVERVIEW.md",
      "sourceFiles": [
        "src/server/index.ts",
        "src/client/App.tsx",
        "package.json"
      ],
      "generatedAt": "2026-02-20T14:30:00Z"
    },
    {
      "title": "Authentication",
      "filename": "AUTHENTICATION.md",
      "sourceFiles": [
        "src/server/auth/login.ts",
        "src/server/auth/middleware.ts"
      ],
      "generatedAt": "2026-02-18T10:00:00Z"
    }
  ]
}
```

### 3.3 API Contract
N/A — this is an internal utility. The API endpoint is covered in STORY-007-03.

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/vdoc/monitor.ts` exports `parseManifest(repoPath)` function.
- [ ] `VdocManifest` and `VdocDocument` types are exported.
- [ ] Returns a valid `VdocManifest` for well-formed `_manifest.json`.
- [ ] Returns `null` for missing `vdocs/` directory.
- [ ] Returns `null` with a console warning for malformed JSON.
- [ ] Falls back to file inference when `_manifest.json` is absent but `*.md` files exist.
- [ ] Manifest validation checks all required fields on each document entry.
- [ ] TypeScript compiles with no errors (`npx tsc --noEmit`).
