---
id: STORY-007-03
parent_epic: EPIC-007
status: Draft
actor: Backend Developer
complexity: Low (1 file)
---
# STORY-007-03: Docs Status API

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a REST API endpoint that returns the vdoc documentation status for a repo,
**So that** the frontend Docs Status page can display which documents are fresh, stale, or unknown.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/server/api/docs.ts` as a Fastify route plugin.
- **Requirement 2**: Implement `GET /api/repos/:repoId/docs` â€” returns the documentation status including `hasVdocs`, `documents`, and `summary`.
- **Requirement 3**: The response shape is `{ hasVdocs: boolean, documents: VdocStatus[], summary: { total: number, fresh: number, stale: number, unknown: number } }`.
- **Requirement 4**: If `vdocs/` does not exist in the repo, return `{ hasVdocs: false, documents: [], summary: { total: 0, fresh: 0, stale: 0, unknown: 0 } }`.
- **Requirement 5**: Internally call `checkFreshness` to compute the status.
- **Requirement 6**: Return 404 if the repo ID is not found in the database.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Docs Status API

  Scenario: Repo has vdocs with mixed freshness
    Given a repo "repo-1" with vdocs/ containing 3 documents (1 fresh, 1 stale, 1 unknown)
    When I send GET /api/repos/repo-1/docs
    Then the response status is 200
    And "hasVdocs" is true
    And "documents" contains 3 VdocStatus objects
    And "summary" is { total: 3, fresh: 1, stale: 1, unknown: 1 }

  Scenario: Repo has no vdocs directory
    Given a repo "repo-2" with no vdocs/ directory
    When I send GET /api/repos/repo-2/docs
    Then the response status is 200
    And "hasVdocs" is false
    And "documents" is an empty array
    And "summary" is { total: 0, fresh: 0, stale: 0, unknown: 0 }

  Scenario: Repo not found
    Given no repo exists with ID "nonexistent"
    When I send GET /api/repos/nonexistent/docs
    Then the response status is 404
    And the body contains an error message "Repo not found"

  Scenario: All docs are fresh
    Given a repo "repo-3" with vdocs/ containing 2 fresh documents
    When I send GET /api/repos/repo-3/docs
    Then "hasVdocs" is true
    And "summary.fresh" is 2
    And "summary.stale" is 0

  Scenario: Repo path is invalid
    Given a repo "repo-4" whose path no longer exists on disk
    When I send GET /api/repos/repo-4/docs
    Then the response status is 200
    And "hasVdocs" is false
```

### 2.2 Verification Steps
- [ ] `GET /api/repos/:repoId/docs` returns 200 with the correct response shape.
- [ ] `hasVdocs` is `true` when `vdocs/` exists and contains documents, `false` otherwise.
- [ ] `documents` array contains `VdocStatus` objects with title, filename, status, lastUpdated, and optional staleReason.
- [ ] `summary` accurately counts fresh, stale, and unknown documents.
- [ ] Returns 404 when the repo ID is not found.
- [ ] Handles invalid repo paths gracefully (returns hasVdocs: false).

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/api/docs.ts`
- **Related Files**: `src/server/vdoc/monitor.ts` (checkFreshness, parseManifest), `src/server/index.ts` (register plugin), `src/server/db/queries.ts` (repo lookup)
- **New Files Needed**:
  - `src/server/api/docs.ts`

### 3.2 Technical Logic

**Step 1: Create the Fastify route plugin**

```typescript
import type { FastifyInstance } from 'fastify';
import fs from 'node:fs';
import path from 'node:path';
import { checkFreshness } from '../vdoc/monitor.js';
import type { VdocStatus } from '../vdoc/monitor.js';

/** Params schema for routes with :repoId */
interface RepoParams {
  repoId: string;
}

/** Response shape for GET /api/repos/:repoId/docs */
interface DocsStatusResponse {
  hasVdocs: boolean;
  documents: VdocStatus[];
  summary: {
    total: number;
    fresh: number;
    stale: number;
    unknown: number;
  };
}

/**
 * Fastify plugin that registers docs status routes.
 */
export default async function docsRoutes(
  fastify: FastifyInstance
): Promise<void> {
  /**
   * GET /api/repos/:repoId/docs
   *
   * Returns vdoc documentation status for a repo.
   */
  fastify.get<{ Params: RepoParams }>(
    '/api/repos/:repoId/docs',
    async (request, reply) => {
      const { repoId } = request.params;
      const db = (fastify as any).db;

      // Look up repo from database
      const repo = db
        .prepare('SELECT id, path FROM repos WHERE id = ?')
        .get(repoId) as
        | { id: string; path: string }
        | undefined;

      if (!repo) {
        return reply.status(404).send({ error: 'Repo not found' });
      }

      // Check if repo path and vdocs/ exist
      const vdocsDir = path.join(repo.path, 'vdocs');
      const vdocsExist =
        fs.existsSync(repo.path) &&
        fs.existsSync(vdocsDir) &&
        fs.statSync(vdocsDir).isDirectory();

      if (!vdocsExist) {
        const emptyResponse: DocsStatusResponse = {
          hasVdocs: false,
          documents: [],
          summary: { total: 0, fresh: 0, stale: 0, unknown: 0 },
        };
        return reply.status(200).send(emptyResponse);
      }

      // Get freshness status
      const documents = checkFreshness(repo.path);

      // Compute summary
      const summary = {
        total: documents.length,
        fresh: documents.filter((d) => d.status === 'fresh').length,
        stale: documents.filter((d) => d.status === 'stale').length,
        unknown: documents.filter((d) => d.status === 'unknown')
          .length,
      };

      const response: DocsStatusResponse = {
        hasVdocs: documents.length > 0,
        documents,
        summary,
      };

      return reply.status(200).send(response);
    }
  );
}
```

**Step 2: Register the plugin in the Fastify server**

In `src/server/index.ts`:

```typescript
import docsRoutes from './api/docs.js';

// Inside server setup:
await fastify.register(docsRoutes);
```

**Step 3: Edge case handling**

- If `vdocs/` exists but is empty and no manifest exists: `checkFreshness` returns `[]`, so `hasVdocs` will be `false`.
- If `vdocs/` exists with only `_manifest.json` but no `.md` files: depends on manifest content; if manifest lists documents, those will be checked (possibly returning "unknown" if the `.md` files are missing).
- If repo path no longer exists: the `fs.existsSync(repo.path)` check catches this and returns `hasVdocs: false`.

### 3.3 API Contract

| Method | Path | Request Body | Response (200) | Error Responses |
|--------|------|--------------|----------------|-----------------|
| `GET` | `/api/repos/:repoId/docs` | None | `DocsStatusResponse` (see below) | 404: `{ error: "Repo not found" }` |

**DocsStatusResponse:**
```typescript
{
  hasVdocs: boolean;
  documents: Array<{
    title: string;
    filename: string;
    status: 'fresh' | 'stale' | 'unknown';
    lastUpdated: string;     // ISO timestamp
    staleReason?: string;    // Present for stale/unknown
  }>;
  summary: {
    total: number;
    fresh: number;
    stale: number;
    unknown: number;
  };
}
```

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/api/docs.ts` exports a Fastify plugin with `GET /api/repos/:repoId/docs`.
- [ ] Response includes `hasVdocs`, `documents` (VdocStatus[]), and `summary` with counts.
- [ ] Returns `hasVdocs: false` with empty documents when `vdocs/` does not exist.
- [ ] Returns 404 when the repo ID is not found in the database.
- [ ] `summary` accurately counts fresh, stale, and unknown documents.
- [ ] Plugin is registered in `src/server/index.ts`.
- [ ] Handles invalid/missing repo paths gracefully.
- [ ] TypeScript compiles with no errors (`npx tsc --noEmit`).
