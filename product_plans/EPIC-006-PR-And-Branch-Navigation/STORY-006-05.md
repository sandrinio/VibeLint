---
id: STORY-006-05
parent_epic: EPIC-006
status: Draft
actor: Backend Developer
complexity: Low (1 file)
---
# STORY-006-05: Review File Reader

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a module that reads AI-generated review markdown files from `.vibelint/reviews/` in a repository,
**So that** the PR Navigator can display agent-written reviews alongside branch analysis results.

### 1.2 Detailed Requirements
- **Requirement 1**: Implement `getReviews(repoPath: string): Promise<ReviewFile[]>` that lists all `.md` files in `{repoPath}/.vibelint/reviews/` and returns metadata for each.
- **Requirement 2**: Implement `getReview(repoPath: string, reviewName: string): Promise<ReviewFile>` that reads a specific review file's full content.
- **Requirement 3**: Match review files to branches by filename convention: `feature-auth.md` maps to branch `feature/auth` (replace hyphens with slashes). If the filename contains no hyphens, the branch name equals the filename without extension.
- **Requirement 4**: Return `ReviewFile` objects containing: filename, inferred branch name, content (full markdown text), and lastModified (file mtime as ISO 8601).
- **Requirement 5**: Handle missing `.vibelint/reviews/` directory gracefully — return an empty array without throwing.
- **Requirement 6**: Handle empty reviews directory — return an empty array.
- **Requirement 7**: Handle malformed filenames (non-.md files, hidden files) — skip them silently.
- **Requirement 8**: Add a `GET /api/repos/:repoId/reviews` endpoint that returns all reviews, and `GET /api/repos/:repoId/reviews/:filename` that returns a specific review.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Review File Reader

  Scenario: List reviews in a repo
    Given repo "/projects/myapp" has .vibelint/reviews/ containing "feature-auth.md" and "fix-typo.md"
    When I call getReviews("/projects/myapp")
    Then the result contains 2 ReviewFile entries
    And "feature-auth.md" maps to branch "feature/auth"
    And "fix-typo.md" maps to branch "fix/typo"

  Scenario: Read a specific review
    Given "feature-auth.md" contains "## Code Review\nLooks good overall."
    When I call getReview("/projects/myapp", "feature-auth.md")
    Then the result has content "## Code Review\nLooks good overall."
    And the result has a valid lastModified timestamp

  Scenario: No reviews directory
    Given repo "/projects/newapp" has no .vibelint/reviews/ directory
    When I call getReviews("/projects/newapp")
    Then the result is an empty array

  Scenario: Empty reviews directory
    Given repo "/projects/myapp" has an empty .vibelint/reviews/ directory
    When I call getReviews("/projects/myapp")
    Then the result is an empty array

  Scenario: Non-markdown files are skipped
    Given .vibelint/reviews/ contains "notes.txt" and "feature-auth.md"
    When I call getReviews("/projects/myapp")
    Then the result contains only 1 entry for "feature-auth.md"

  Scenario: Simple branch name (no slashes)
    Given .vibelint/reviews/ contains "hotfix.md"
    When I call getReviews
    Then the "hotfix.md" entry maps to branch "hotfix"

  Scenario: API endpoint returns reviews
    Given repo "repo-1" has 2 review files
    When I GET /api/repos/repo-1/reviews
    Then the response status is 200
    And the body contains 2 review objects
```

### 2.2 Verification Steps
- [ ] `getReviews` returns correct metadata for all `.md` files in `.vibelint/reviews/`.
- [ ] Branch name inference from filename is correct (hyphens to slashes).
- [ ] `getReview` returns full file content and lastModified timestamp.
- [ ] Missing `.vibelint/reviews/` directory returns empty array (no error).
- [ ] Empty directory returns empty array.
- [ ] Non-`.md` files and hidden files are skipped.
- [ ] API endpoints return correct responses.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/git/reviews.ts` (create)
- **Related Files**:
  - `src/server/api/branches.ts` (add review endpoints)
  - `src/server/db/queries.ts` (existing — `getRepoById`)
- **New Files Needed**:
  - `src/server/git/reviews.ts`
  - `tests/server/git/reviews.test.ts` (unit tests)

### 3.2 Technical Logic

**Step 1: Define types**

```typescript
// src/server/git/reviews.ts

export interface ReviewFile {
  filename: string;          // e.g., "feature-auth.md"
  branch: string;            // Inferred: "feature/auth"
  content: string;           // Full markdown content (empty for list calls)
  lastModified: string;      // ISO 8601 timestamp
}
```

**Step 2: Implement branch name inference**

```typescript
const REVIEWS_DIR = '.vibelint/reviews';

/**
 * Convert review filename to branch name.
 * Convention: hyphens in filename map to slashes in branch name.
 * "feature-auth.md" -> "feature/auth"
 * "hotfix.md" -> "hotfix"
 * "feature-auth-login.md" -> "feature/auth/login"
 */
function filenameToBranch(filename: string): string {
  // Remove .md extension
  const stem = filename.replace(/\.md$/i, '');
  // Replace hyphens with slashes
  return stem.replace(/-/g, '/');
}
```

**Step 3: Implement `getReviews`**

```typescript
import { readdir, readFile, stat } from 'node:fs/promises';
import { join, extname } from 'node:path';

export async function getReviews(repoPath: string): Promise<ReviewFile[]> {
  const reviewsDir = join(repoPath, REVIEWS_DIR);

  let entries;
  try {
    entries = await readdir(reviewsDir, { withFileTypes: true });
  } catch {
    // Directory doesn't exist or can't be read — return empty
    return [];
  }

  const reviews: ReviewFile[] = [];

  for (const entry of entries) {
    // Skip directories, hidden files, and non-.md files
    if (!entry.isFile()) continue;
    if (entry.name.startsWith('.')) continue;
    if (extname(entry.name).toLowerCase() !== '.md') continue;

    const filePath = join(reviewsDir, entry.name);

    let fileStat;
    try {
      fileStat = await stat(filePath);
    } catch {
      continue; // Skip unreadable files
    }

    reviews.push({
      filename: entry.name,
      branch: filenameToBranch(entry.name),
      content: '',  // Empty for list — use getReview() for full content
      lastModified: fileStat.mtime.toISOString(),
    });
  }

  // Sort by lastModified descending (most recent first)
  reviews.sort(
    (a, b) => new Date(b.lastModified).getTime() - new Date(a.lastModified).getTime()
  );

  return reviews;
}
```

**Step 4: Implement `getReview`**

```typescript
export async function getReview(
  repoPath: string,
  reviewName: string
): Promise<ReviewFile | null> {
  const filePath = join(repoPath, REVIEWS_DIR, reviewName);

  // Security: ensure the resolved path stays within the reviews directory
  const reviewsDir = join(repoPath, REVIEWS_DIR);
  if (!filePath.startsWith(reviewsDir)) {
    return null; // Path traversal attempt
  }

  try {
    const [content, fileStat] = await Promise.all([
      readFile(filePath, 'utf-8'),
      stat(filePath),
    ]);

    return {
      filename: reviewName,
      branch: filenameToBranch(reviewName),
      content,
      lastModified: fileStat.mtime.toISOString(),
    };
  } catch {
    return null; // File not found or unreadable
  }
}
```

**Step 5: Add API endpoints in branches.ts**

```typescript
// Add to src/server/api/branches.ts
import { getReviews, getReview } from '../git/reviews.js';

// GET /api/repos/:repoId/reviews
fastify.get<{ Params: RepoParams }>(
  '/api/repos/:repoId/reviews',
  async (request, reply) => {
    const { repoId } = request.params;

    const repo = getRepoById(repoId);
    if (!repo) {
      return reply.status(404).send({
        error: 'Repository not found',
        code: 'REPO_NOT_FOUND',
      });
    }

    const reviews = await getReviews(repo.path);
    return reply.send(reviews);
  }
);

// GET /api/repos/:repoId/reviews/:filename
fastify.get<{ Params: RepoParams & { filename: string } }>(
  '/api/repos/:repoId/reviews/:filename',
  async (request, reply) => {
    const { repoId, filename } = request.params;

    const repo = getRepoById(repoId);
    if (!repo) {
      return reply.status(404).send({
        error: 'Repository not found',
        code: 'REPO_NOT_FOUND',
      });
    }

    const review = await getReview(repo.path, filename);
    if (!review) {
      return reply.status(404).send({
        error: `Review not found: ${filename}`,
        code: 'REVIEW_NOT_FOUND',
      });
    }

    return reply.send(review);
  }
);
```

### 3.3 API Contract

**GET `/api/repos/:repoId/reviews`**

Response `200`:
```json
[
  {
    "filename": "feature-auth.md",
    "branch": "feature/auth",
    "content": "",
    "lastModified": "2026-02-22T16:00:00.000Z"
  },
  {
    "filename": "fix-typo.md",
    "branch": "fix/typo",
    "content": "",
    "lastModified": "2026-02-21T10:30:00.000Z"
  }
]
```

**GET `/api/repos/:repoId/reviews/:filename`**

Response `200`:
```json
{
  "filename": "feature-auth.md",
  "branch": "feature/auth",
  "content": "## Code Review\n\nThe authentication module looks solid...",
  "lastModified": "2026-02-22T16:00:00.000Z"
}
```

Response `404`:
```json
{ "error": "Review not found: nonexistent.md", "code": "REVIEW_NOT_FOUND" }
```

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/git/reviews.ts` exists and exports `getReviews`, `getReview`, `ReviewFile`.
- [ ] `getReviews` lists all `.md` files in `.vibelint/reviews/` with correct metadata.
- [ ] Branch name inference converts hyphens to slashes correctly.
- [ ] `getReview` returns full content and lastModified for a specific file.
- [ ] Missing or empty `.vibelint/reviews/` directory returns empty array without throwing.
- [ ] Non-`.md` files and hidden files are skipped silently.
- [ ] Path traversal attempts are prevented in `getReview`.
- [ ] API endpoints `GET /api/repos/:repoId/reviews` and `GET /api/repos/:repoId/reviews/:filename` work correctly.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
