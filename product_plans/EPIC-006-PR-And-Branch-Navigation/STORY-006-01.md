---
id: STORY-006-01
parent_epic: EPIC-006
status: Draft
actor: Backend Developer
complexity: Low (1 file)
---
# STORY-006-01: Git Diff Parser

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a git diff parser module that compares two branches and extracts per-file change statistics,
**So that** the branch listing API and PR Navigator UI can display meaningful diff summaries without manually parsing raw git output.

### 1.2 Detailed Requirements
- **Requirement 1**: Implement `getBranchDiff(repoPath: string, branch: string, baseBranch: string): Promise<BranchDiffSummary>` that runs `git diff --stat {baseBranch}...{branch}` and parses the output into structured data.
- **Requirement 2**: Parse each line of `--stat` output to extract: file path, number of insertions, number of deletions, and file status (added, modified, deleted).
- **Requirement 3**: Implement `getFileDiff(repoPath: string, filePath: string, baseBranch: string, branch: string): Promise<string>` that returns the unified diff for a specific file between two branches using `git diff {baseBranch}...{branch} -- {filePath}`.
- **Requirement 4**: Return a `BranchDiffSummary` object containing: branch name, base branch name, total files changed, total insertions, total deletions, and a per-file array with path, insertions, deletions, and status.
- **Requirement 5**: Handle error cases gracefully: branch does not exist (throw `BranchNotFoundError`), no common ancestor between branches (throw `NoCommonAncestorError`), path is not a git repo (throw `NotAGitRepoError`).
- **Requirement 6**: Use the shared `exec` utility from `src/server/utils/exec.ts` to run git commands (consistent with how other git modules execute shell commands).
- **Requirement 7**: Export all types (`BranchDiffSummary`, `FileDiffEntry`) so they can be imported by API routes and frontend types.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Git Diff Parser

  Scenario: Parse diff stats between two branches
    Given a git repo at "/tmp/test-repo" with branches "main" and "feature/auth"
    And "feature/auth" has 3 changed files vs "main"
    When I call getBranchDiff("/tmp/test-repo", "feature/auth", "main")
    Then the result has filesChanged equal to 3
    And totalInsertions and totalDeletions reflect the actual line changes
    And each file entry has a valid path, insertions count, deletions count, and status

  Scenario: Detect file statuses correctly
    Given "feature/auth" added "src/auth.ts", modified "src/index.ts", deleted "src/old.ts"
    When I call getBranchDiff for "feature/auth" vs "main"
    Then "src/auth.ts" has status "added"
    And "src/index.ts" has status "modified"
    And "src/old.ts" has status "deleted"

  Scenario: Get unified diff for a specific file
    Given "feature/auth" modified "src/index.ts" with 5 new lines
    When I call getFileDiff("/tmp/test-repo", "src/index.ts", "main", "feature/auth")
    Then the result is a non-empty string containing unified diff markers (@@)

  Scenario: Branch does not exist
    Given the repo has no branch named "nonexistent"
    When I call getBranchDiff("/tmp/test-repo", "nonexistent", "main")
    Then a BranchNotFoundError is thrown with the branch name in the message

  Scenario: Not a git repository
    Given the path "/tmp/not-a-repo" is not a git repository
    When I call getBranchDiff("/tmp/not-a-repo", "feature", "main")
    Then a NotAGitRepoError is thrown

  Scenario: No changes between branches
    Given "feature/empty" is identical to "main"
    When I call getBranchDiff("/tmp/test-repo", "feature/empty", "main")
    Then the result has filesChanged equal to 0
    And files array is empty
```

### 2.2 Verification Steps
- [ ] `getBranchDiff` returns correct file counts for a fixture repo with known changes.
- [ ] Per-file insertions and deletions match actual `git diff --stat` output.
- [ ] File status detection (added/modified/deleted) is accurate.
- [ ] `getFileDiff` returns valid unified diff output for a changed file.
- [ ] `BranchNotFoundError` is thrown when branch does not exist.
- [ ] `NotAGitRepoError` is thrown when path is not a git repository.
- [ ] Empty diffs return `filesChanged: 0` with an empty files array.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/git/diff.ts` (create)
- **Related Files**: `src/server/utils/exec.ts` (existing — shared shell exec utility)
- **New Files Needed**:
  - `src/server/git/diff.ts`
  - `tests/server/git/diff.test.ts` (unit tests)

### 3.2 Technical Logic

**Step 1: Define types**

```typescript
// src/server/git/diff.ts

export interface FileDiffEntry {
  path: string;
  insertions: number;
  deletions: number;
  status: 'added' | 'modified' | 'deleted';
}

export interface BranchDiffSummary {
  branch: string;
  baseBranch: string;
  filesChanged: number;
  totalInsertions: number;
  totalDeletions: number;
  files: FileDiffEntry[];
}

export class BranchNotFoundError extends Error {
  constructor(branch: string) {
    super(`Branch not found: ${branch}`);
    this.name = 'BranchNotFoundError';
  }
}

export class NoCommonAncestorError extends Error {
  constructor(branch: string, baseBranch: string) {
    super(`No common ancestor between '${branch}' and '${baseBranch}'`);
    this.name = 'NoCommonAncestorError';
  }
}

export class NotAGitRepoError extends Error {
  constructor(path: string) {
    super(`Not a git repository: ${path}`);
    this.name = 'NotAGitRepoError';
  }
}
```

**Step 2: Implement `getBranchDiff`**

```typescript
import { execCommand } from '../utils/exec.js';

export async function getBranchDiff(
  repoPath: string,
  branch: string,
  baseBranch: string
): Promise<BranchDiffSummary> {
  // Validate it's a git repo
  try {
    await execCommand('git rev-parse --git-dir', { cwd: repoPath });
  } catch {
    throw new NotAGitRepoError(repoPath);
  }

  // Validate branches exist
  try {
    await execCommand(`git rev-parse --verify ${branch}`, { cwd: repoPath });
  } catch {
    throw new BranchNotFoundError(branch);
  }

  try {
    await execCommand(`git rev-parse --verify ${baseBranch}`, { cwd: repoPath });
  } catch {
    throw new BranchNotFoundError(baseBranch);
  }

  // Get diff --stat output
  // The triple-dot syntax shows changes on branch since it diverged from baseBranch
  let statOutput: string;
  try {
    const result = await execCommand(
      `git diff --stat ${baseBranch}...${branch}`,
      { cwd: repoPath }
    );
    statOutput = result.stdout.trim();
  } catch (err: any) {
    if (err.stderr?.includes('no merge base')) {
      throw new NoCommonAncestorError(branch, baseBranch);
    }
    throw err;
  }

  // Also get --numstat for precise numbers (--stat truncates long filenames)
  let numstatOutput: string;
  try {
    const result = await execCommand(
      `git diff --numstat ${baseBranch}...${branch}`,
      { cwd: repoPath }
    );
    numstatOutput = result.stdout.trim();
  } catch {
    numstatOutput = '';
  }

  // Also get --name-status for file status (A/M/D)
  let nameStatusOutput: string;
  try {
    const result = await execCommand(
      `git diff --name-status ${baseBranch}...${branch}`,
      { cwd: repoPath }
    );
    nameStatusOutput = result.stdout.trim();
  } catch {
    nameStatusOutput = '';
  }

  const files = parseDiffOutput(numstatOutput, nameStatusOutput);

  const totalInsertions = files.reduce((sum, f) => sum + f.insertions, 0);
  const totalDeletions = files.reduce((sum, f) => sum + f.deletions, 0);

  return {
    branch,
    baseBranch,
    filesChanged: files.length,
    totalInsertions,
    totalDeletions,
    files,
  };
}
```

**Step 3: Parse git output**

```typescript
function parseDiffOutput(
  numstatOutput: string,
  nameStatusOutput: string
): FileDiffEntry[] {
  if (!numstatOutput && !nameStatusOutput) return [];

  // Build status map from --name-status output
  // Format: "M\tsrc/index.ts" or "A\tsrc/new.ts" or "D\tsrc/old.ts"
  const statusMap = new Map<string, 'added' | 'modified' | 'deleted'>();
  if (nameStatusOutput) {
    for (const line of nameStatusOutput.split('\n')) {
      const parts = line.split('\t');
      if (parts.length >= 2) {
        const statusChar = parts[0].trim();
        const filePath = parts[1].trim();
        statusMap.set(filePath, mapGitStatus(statusChar));
      }
    }
  }

  // Parse --numstat output
  // Format: "insertions\tdeletions\tfilepath"
  // Binary files show "-" for insertions/deletions
  const files: FileDiffEntry[] = [];
  if (numstatOutput) {
    for (const line of numstatOutput.split('\n')) {
      const parts = line.split('\t');
      if (parts.length >= 3) {
        const insertions = parts[0] === '-' ? 0 : parseInt(parts[0], 10);
        const deletions = parts[1] === '-' ? 0 : parseInt(parts[1], 10);
        const filePath = parts[2].trim();
        const status = statusMap.get(filePath) ?? 'modified';

        files.push({ path: filePath, insertions, deletions, status });
      }
    }
  }

  return files;
}

function mapGitStatus(statusChar: string): 'added' | 'modified' | 'deleted' {
  switch (statusChar.charAt(0)) {
    case 'A': return 'added';
    case 'D': return 'deleted';
    case 'M': return 'modified';
    case 'R': return 'modified'; // renamed — treat as modified
    case 'C': return 'added';    // copied — treat as added
    default:  return 'modified';
  }
}
```

**Step 4: Implement `getFileDiff`**

```typescript
export async function getFileDiff(
  repoPath: string,
  filePath: string,
  baseBranch: string,
  branch: string
): Promise<string> {
  try {
    await execCommand('git rev-parse --git-dir', { cwd: repoPath });
  } catch {
    throw new NotAGitRepoError(repoPath);
  }

  try {
    const result = await execCommand(
      `git diff ${baseBranch}...${branch} -- "${filePath}"`,
      { cwd: repoPath }
    );
    return result.stdout;
  } catch (err: any) {
    if (err.stderr?.includes('unknown revision')) {
      throw new BranchNotFoundError(branch);
    }
    throw err;
  }
}
```

### 3.3 API Contract
N/A — this is an internal module consumed by `src/server/api/branches.ts` (STORY-006-03). No HTTP endpoints.

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/git/diff.ts` exists and exports `getBranchDiff`, `getFileDiff`, `BranchDiffSummary`, `FileDiffEntry`.
- [ ] `getBranchDiff` correctly runs `git diff --numstat` and `git diff --name-status` and returns structured results.
- [ ] Per-file insertions, deletions, and status are accurately parsed.
- [ ] `getFileDiff` returns unified diff output for a specific file.
- [ ] `BranchNotFoundError` is thrown for non-existent branches.
- [ ] `NotAGitRepoError` is thrown for invalid repo paths.
- [ ] `NoCommonAncestorError` is thrown when branches have no merge base.
- [ ] Empty diffs (identical branches) return `filesChanged: 0` and empty files array.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
