---
id: STORY-006-06
parent_epic: EPIC-006
status: Draft
actor: Frontend Developer
complexity: High (4+ files)
---
# STORY-006-06: PR Navigator Page

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Frontend Developer,
**I want** a PR Navigator page that lists all branches with diff stats, shows analysis results and AI reviews for a selected branch, and allows triggering per-branch analysis,
**So that** developers can navigate branches, understand code changes, and review quality before opening pull requests.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/client/pages/PRNavigator.tsx` as a full page component routed at `/pr`.
- **Requirement 2**: Display a repo selector dropdown at the top that fetches from `GET /api/repos` and defaults to the first repo.
- **Requirement 3**: Render a left panel with a scrollable branch list fetched from `GET /api/repos/:repoId/branches`. Show each branch with: name, diff stat badges (files changed, +insertions/-deletions), and a "current" indicator.
- **Requirement 4**: Highlight the current branch (where `isCurrent` is true) with a distinct visual style.
- **Requirement 5**: Clicking a branch loads the right panel with three sections: (a) diff summary using the DiffViewer component, (b) analysis results if available, (c) review content if available.
- **Requirement 6**: Display an "Analyze Branch" button that triggers `POST /api/repos/:repoId/branches/:branch/analyze` and refreshes the analysis section on completion.
- **Requirement 7**: Show appropriate empty states: "No analysis yet -- click Analyze Branch" and "No AI review yet -- use /review in your coding agent".
- **Requirement 8**: Include a search/filter input above the branch list that filters branches by name as the user types.
- **Requirement 9**: Show loading spinners during API fetches and disable the Analyze button while analysis is running.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: PR Navigator Page

  Scenario: Page loads with branch list
    Given the user navigates to /pr
    And repo "repo-1" has 5 branches
    When the page loads
    Then the repo selector shows "repo-1" selected
    And the left panel lists all 5 branches with diff badges

  Scenario: Current branch is highlighted
    Given branch "feature/auth" is the current branch
    When the branch list renders
    Then "feature/auth" has a distinct highlight style
    And other branches do not have the highlight

  Scenario: Select a branch to view details
    Given the branch list shows "feature/auth"
    When the user clicks "feature/auth"
    Then the right panel loads diff summary from GET /api/repos/:repoId/branches/feature%2Fauth/diff
    And the right panel shows analysis results from GET /api/repos/:repoId/branches/feature%2Fauth/analysis
    And the right panel shows review content from GET /api/repos/:repoId/reviews

  Scenario: No analysis exists for branch
    Given "feature/new" has no analysis results
    When the user selects "feature/new"
    Then the analysis section shows "No analysis yet" with an Analyze Branch button

  Scenario: Trigger branch analysis
    Given the user is viewing "feature/auth" with no analysis
    When the user clicks "Analyze Branch"
    Then a loading spinner appears on the button
    And POST /api/repos/:repoId/branches/feature%2Fauth/analyze is called
    And upon success the analysis section updates with results

  Scenario: No review exists for branch
    Given no review file matches "feature/auth"
    When the user selects "feature/auth"
    Then the review section shows "No AI review yet. Use /review in your coding agent."

  Scenario: Review exists for branch
    Given "feature-auth.md" exists in .vibelint/reviews/
    When the user selects "feature/auth"
    Then the review section renders the markdown content

  Scenario: Filter branches by name
    Given branches "main", "feature/auth", "feature/payments", "fix/typo"
    When the user types "feature" in the search box
    Then only "feature/auth" and "feature/payments" are shown

  Scenario: Switch repos
    Given repos "repo-1" and "repo-2" exist
    When the user switches the dropdown to "repo-2"
    Then the branch list refreshes with branches from "repo-2"
```

### 2.2 Verification Steps
- [ ] Page loads at `/pr` route without errors.
- [ ] Repo selector dropdown populates from API and defaults to first repo.
- [ ] Branch list renders with correct names and diff stat badges.
- [ ] Current branch is visually highlighted.
- [ ] Clicking a branch populates the right panel with diff, analysis, and review data.
- [ ] "Analyze Branch" button triggers POST and updates the UI on success.
- [ ] Empty states display correct messages for missing analysis and reviews.
- [ ] Branch filter/search works with partial name matching.
- [ ] Loading states appear during API fetches.
- [ ] Switching repos refreshes the branch list.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/client/pages/PRNavigator.tsx` (create)
- **Related Files**:
  - `src/client/components/DiffViewer.tsx` (STORY-006-07 — used for diff display)
  - `src/client/lib/api.ts` (existing — API client utility)
  - `src/client/App.tsx` (existing — route already defined as placeholder)
  - `src/client/components/Layout.tsx` (existing — sidebar nav already has /pr link)
- **New Files Needed**:
  - `src/client/pages/PRNavigator.tsx`

### 3.2 Technical Logic

**Step 1: Define TypeScript interfaces for API responses**

```typescript
// At the top of PRNavigator.tsx (or in a shared types file)

interface BranchInfo {
  name: string;
  isCurrent: boolean;
  lastCommitDate: string;
  lastCommitHash: string;
  ahead: number;
  behind: number;
}

interface BranchDiffSummary {
  branch: string;
  baseBranch: string;
  filesChanged: number;
  totalInsertions: number;
  totalDeletions: number;
  files: Array<{
    path: string;
    insertions: number;
    deletions: number;
    status: 'added' | 'modified' | 'deleted';
  }>;
}

interface AnalysisResult {
  id: number;
  branch: string;
  baseBranch: string;
  diffStats: BranchDiffSummary;
  analysisData: Record<string, unknown>;
  createdAt: string;
}

interface ReviewFile {
  filename: string;
  branch: string;
  content: string;
  lastModified: string;
}

interface Repo {
  id: string;
  name: string;
  path: string;
}
```

**Step 2: Build the page component with state management**

```tsx
import React, { useState, useEffect, useMemo } from 'react';
import DiffViewer from '../components/DiffViewer';

export default function PRNavigator() {
  // State
  const [repos, setRepos] = useState<Repo[]>([]);
  const [selectedRepoId, setSelectedRepoId] = useState<string>('');
  const [branches, setBranches] = useState<BranchInfo[]>([]);
  const [selectedBranch, setSelectedBranch] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [diffSummary, setDiffSummary] = useState<BranchDiffSummary | null>(null);
  const [analysis, setAnalysis] = useState<AnalysisResult | null>(null);
  const [review, setReview] = useState<ReviewFile | null>(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [loadingBranches, setLoadingBranches] = useState(false);
  const [loadingDetails, setLoadingDetails] = useState(false);

  // Filtered branches
  const filteredBranches = useMemo(() => {
    if (!searchQuery) return branches;
    const q = searchQuery.toLowerCase();
    return branches.filter(b => b.name.toLowerCase().includes(q));
  }, [branches, searchQuery]);

  // Fetch repos on mount
  useEffect(() => {
    fetch('/api/repos')
      .then(res => res.json())
      .then((data: Repo[]) => {
        setRepos(data);
        if (data.length > 0) setSelectedRepoId(data[0].id);
      });
  }, []);

  // Fetch branches when repo changes
  useEffect(() => {
    if (!selectedRepoId) return;
    setLoadingBranches(true);
    setSelectedBranch(null);
    fetch(`/api/repos/${selectedRepoId}/branches`)
      .then(res => res.json())
      .then((data: BranchInfo[]) => {
        setBranches(data);
        // Auto-select current branch
        const current = data.find(b => b.isCurrent);
        if (current) setSelectedBranch(current.name);
      })
      .finally(() => setLoadingBranches(false));
  }, [selectedRepoId]);

  // Fetch details when branch is selected
  useEffect(() => {
    if (!selectedRepoId || !selectedBranch) return;
    setLoadingDetails(true);
    setDiffSummary(null);
    setAnalysis(null);
    setReview(null);

    const encodedBranch = encodeURIComponent(selectedBranch);

    // Fetch diff, analysis, and reviews in parallel
    Promise.all([
      fetch(`/api/repos/${selectedRepoId}/branches/${encodedBranch}/diff`)
        .then(r => r.ok ? r.json() : null),
      fetch(`/api/repos/${selectedRepoId}/branches/${encodedBranch}/analysis`)
        .then(r => r.ok ? r.json() : null),
      fetch(`/api/repos/${selectedRepoId}/reviews`)
        .then(r => r.ok ? r.json() : []),
    ]).then(([diff, analysisData, reviews]) => {
      setDiffSummary(diff);
      setAnalysis(analysisData);
      // Match review to selected branch
      const matchingReview = (reviews as ReviewFile[])
        .find(r => r.branch === selectedBranch);
      if (matchingReview) {
        // Fetch full content
        fetch(`/api/repos/${selectedRepoId}/reviews/${matchingReview.filename}`)
          .then(r => r.ok ? r.json() : null)
          .then(setReview);
      }
    }).finally(() => setLoadingDetails(false));
  }, [selectedRepoId, selectedBranch]);

  // Handle analyze button
  const handleAnalyze = async () => {
    if (!selectedRepoId || !selectedBranch) return;
    setIsAnalyzing(true);
    try {
      const encodedBranch = encodeURIComponent(selectedBranch);
      const res = await fetch(
        `/api/repos/${selectedRepoId}/branches/${encodedBranch}/analyze`,
        { method: 'POST' }
      );
      if (res.ok) {
        const data = await res.json();
        setAnalysis(data);
      }
    } finally {
      setIsAnalyzing(false);
    }
  };

  return (/* JSX — see Step 3 */);
}
```

**Step 3: Build the JSX layout**

```tsx
return (
  <div className="h-full flex flex-col">
    {/* Header: Repo selector */}
    <div className="flex items-center gap-4 mb-4">
      <h1 className="text-2xl font-bold">PR Navigator</h1>
      <select
        className="border rounded px-3 py-1.5 text-sm bg-white"
        value={selectedRepoId}
        onChange={e => setSelectedRepoId(e.target.value)}
      >
        {repos.map(r => (
          <option key={r.id} value={r.id}>{r.name}</option>
        ))}
      </select>
    </div>

    {/* Main content: two-panel layout */}
    <div className="flex flex-1 gap-4 min-h-0">
      {/* Left panel: branch list */}
      <div className="w-80 flex-shrink-0 border rounded-lg bg-white flex flex-col">
        <div className="p-3 border-b">
          <input
            type="text"
            placeholder="Filter branches..."
            className="w-full border rounded px-3 py-1.5 text-sm"
            value={searchQuery}
            onChange={e => setSearchQuery(e.target.value)}
          />
        </div>
        <div className="flex-1 overflow-y-auto">
          {loadingBranches ? (
            <div className="p-4 text-center text-gray-400">Loading branches...</div>
          ) : filteredBranches.length === 0 ? (
            <div className="p-4 text-center text-gray-400">No branches found</div>
          ) : (
            filteredBranches.map(branch => (
              <button
                key={branch.name}
                className={`w-full text-left px-3 py-2 border-b text-sm hover:bg-gray-50 ${
                  selectedBranch === branch.name ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''
                } ${branch.isCurrent ? 'font-semibold' : ''}`}
                onClick={() => setSelectedBranch(branch.name)}
              >
                <div className="flex items-center justify-between">
                  <span className="truncate">{branch.name}</span>
                  {branch.isCurrent && (
                    <span className="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">
                      current
                    </span>
                  )}
                </div>
                <div className="text-xs text-gray-400 mt-0.5">
                  {branch.lastCommitHash} &middot; {new Date(branch.lastCommitDate).toLocaleDateString()}
                </div>
              </button>
            ))
          )}
        </div>
      </div>

      {/* Right panel: branch details */}
      <div className="flex-1 overflow-y-auto space-y-4">
        {!selectedBranch ? (
          <div className="text-center text-gray-400 mt-20">
            Select a branch to view details
          </div>
        ) : loadingDetails ? (
          <div className="text-center text-gray-400 mt-20">Loading...</div>
        ) : (
          <>
            {/* Diff summary section */}
            {diffSummary && <DiffViewer diffSummary={diffSummary} />}

            {/* Analysis section */}
            <div className="border rounded-lg bg-white p-4">
              <div className="flex items-center justify-between mb-3">
                <h2 className="font-semibold">Analysis</h2>
                <button
                  className="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 disabled:opacity-50"
                  onClick={handleAnalyze}
                  disabled={isAnalyzing}
                >
                  {isAnalyzing ? 'Analyzing...' : 'Analyze Branch'}
                </button>
              </div>
              {analysis ? (
                <div>
                  <p className="text-xs text-gray-400 mb-2">
                    Last analyzed: {new Date(analysis.createdAt).toLocaleString()}
                  </p>
                  <pre className="text-sm bg-gray-50 p-3 rounded overflow-x-auto">
                    {JSON.stringify(analysis.analysisData, null, 2)}
                  </pre>
                </div>
              ) : (
                <p className="text-gray-400 text-sm">
                  No analysis yet &mdash; click Analyze Branch to run analysis on this branch's changes.
                </p>
              )}
            </div>

            {/* Review section */}
            <div className="border rounded-lg bg-white p-4">
              <h2 className="font-semibold mb-3">AI Review</h2>
              {review ? (
                <div className="prose prose-sm max-w-none">
                  <pre className="whitespace-pre-wrap text-sm">{review.content}</pre>
                </div>
              ) : (
                <p className="text-gray-400 text-sm">
                  No AI review yet. Use <code>/review</code> in your coding agent to generate one.
                </p>
              )}
            </div>
          </>
        )}
      </div>
    </div>
  </div>
);
```

**Step 4: Update App.tsx to use the real component**

```tsx
// In src/client/App.tsx, replace the placeholder:
import PRNavigator from './pages/PRNavigator';

// In the routes:
<Route path="/pr" element={<PRNavigator />} />
```

### 3.3 API Contract
This story consumes the following endpoints (no new endpoints created):

| Method | Endpoint | Source Story |
|--------|----------|-------------|
| GET | `/api/repos` | EPIC-002 |
| GET | `/api/repos/:repoId/branches` | STORY-006-03 |
| GET | `/api/repos/:repoId/branches/:branch/diff` | STORY-006-03 |
| GET | `/api/repos/:repoId/branches/:branch/analysis` | STORY-006-04 |
| POST | `/api/repos/:repoId/branches/:branch/analyze` | STORY-006-04 |
| GET | `/api/repos/:repoId/reviews` | STORY-006-05 |
| GET | `/api/repos/:repoId/reviews/:filename` | STORY-006-05 |

---

## 4. Definition of Done (The Gate)
- [ ] `src/client/pages/PRNavigator.tsx` exists and renders at the `/pr` route.
- [ ] Repo selector dropdown populates from API and triggers branch list refresh.
- [ ] Branch list renders with names, diff stat indicators, and current branch highlight.
- [ ] Clicking a branch loads diff summary, analysis results, and review content in the right panel.
- [ ] "Analyze Branch" button triggers POST and updates analysis section.
- [ ] Empty states display correct messages for missing analysis and reviews.
- [ ] Branch search/filter input works with partial name matching.
- [ ] Loading spinners appear during API fetches.
- [ ] Analyze button is disabled while analysis is running.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
- [ ] No console errors when navigating the page.
