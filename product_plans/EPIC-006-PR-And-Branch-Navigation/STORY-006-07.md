---
id: STORY-006-07
parent_epic: EPIC-006
status: Draft
actor: Frontend Developer
complexity: Medium (2-3 files)
---
# STORY-006-07: DiffViewer Component

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Frontend Developer,
**I want** a reusable DiffViewer component that renders branch diff summaries with per-file change bars and expandable file details,
**So that** the PR Navigator page (and potentially other pages) can display diff statistics in an intuitive, visual format.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/client/components/DiffViewer.tsx` that accepts a `diffSummary` prop of type `BranchDiffSummary`.
- **Requirement 2**: Display a summary header showing: "X files changed, +Y insertions, -Z deletions" with green/red coloring.
- **Requirement 3**: Render a file list where each file shows: file path, status badge (added=green, modified=yellow, deleted=red), and an insertion/deletion bar visualization.
- **Requirement 4**: The insertion/deletion bar should be a proportional horizontal bar with green (insertions) and red (deletions) segments, scaled relative to the file with the most changes.
- **Requirement 5**: Clicking a file row expands it to show: exact line counts ("+X insertions, -Y deletions"), full file path, and status.
- **Requirement 6**: Group files by directory path (collapsible groups). Example: `src/auth/login.ts` and `src/auth/session.ts` appear under a `src/auth/` group.
- **Requirement 7**: All file groups start collapsed by default. Clicking a group header toggles expand/collapse.
- **Requirement 8**: If the diff summary has zero files changed, show a "No changes between branches" message.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: DiffViewer Component

  Scenario: Render summary header
    Given a diffSummary with 5 filesChanged, 120 totalInsertions, 30 totalDeletions
    When the DiffViewer renders
    Then the header shows "5 files changed, +120 insertions, -30 deletions"

  Scenario: File list with status badges
    Given files include an "added" file, a "modified" file, and a "deleted" file
    When the DiffViewer renders
    Then each file has a colored status badge: green for added, yellow for modified, red for deleted

  Scenario: Proportional change bars
    Given file A has 100 insertions and file B has 50 insertions
    When the DiffViewer renders
    Then file A's green bar is twice as wide as file B's green bar

  Scenario: Expand file details
    Given the file "src/auth.ts" has 45 insertions and 10 deletions
    When the user clicks on "src/auth.ts"
    Then it expands to show "+45 insertions, -10 deletions" and status "added"

  Scenario: Directory grouping
    Given files "src/auth/login.ts" and "src/auth/session.ts" exist in the diff
    When the DiffViewer renders
    Then they appear under a "src/auth/" group header
    And the group is collapsed by default

  Scenario: Toggle group collapse
    Given the "src/auth/" group is collapsed
    When the user clicks the group header
    Then the group expands showing its files
    When the user clicks the group header again
    Then the group collapses hiding its files

  Scenario: No changes
    Given a diffSummary with 0 filesChanged
    When the DiffViewer renders
    Then it shows "No changes between branches"
```

### 2.2 Verification Steps
- [ ] Summary header displays correct counts with green/red coloring.
- [ ] Each file row shows path, status badge, and proportional change bar.
- [ ] Status badges use correct colors: green (added), yellow (modified), red (deleted).
- [ ] Change bars are proportional to the maximum change count across all files.
- [ ] Clicking a file row expands it to show detailed line counts.
- [ ] Files are grouped by directory path.
- [ ] Groups are collapsed by default and toggleable.
- [ ] Zero-change diffs show "No changes between branches" message.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/client/components/DiffViewer.tsx` (create)
- **Related Files**:
  - `src/client/pages/PRNavigator.tsx` (STORY-006-06 — consumes this component)
- **New Files Needed**:
  - `src/client/components/DiffViewer.tsx`

### 3.2 Technical Logic

**Step 1: Define props interface and helper types**

```typescript
// src/client/components/DiffViewer.tsx

import React, { useState, useMemo } from 'react';

interface FileDiffEntry {
  path: string;
  insertions: number;
  deletions: number;
  status: 'added' | 'modified' | 'deleted';
}

interface BranchDiffSummary {
  branch: string;
  baseBranch: string;
  filesChanged: number;
  totalInsertions: number;
  totalDeletions: number;
  files: FileDiffEntry[];
}

interface DiffViewerProps {
  diffSummary: BranchDiffSummary;
}

interface FileGroup {
  directory: string;
  files: FileDiffEntry[];
}
```

**Step 2: Implement directory grouping logic**

```typescript
function groupFilesByDirectory(files: FileDiffEntry[]): FileGroup[] {
  const groups = new Map<string, FileDiffEntry[]>();

  for (const file of files) {
    const lastSlash = file.path.lastIndexOf('/');
    const directory = lastSlash === -1 ? '.' : file.path.substring(0, lastSlash + 1);

    if (!groups.has(directory)) {
      groups.set(directory, []);
    }
    groups.get(directory)!.push(file);
  }

  // Sort groups alphabetically, with root (".") first
  return Array.from(groups.entries())
    .sort(([a], [b]) => {
      if (a === '.') return -1;
      if (b === '.') return 1;
      return a.localeCompare(b);
    })
    .map(([directory, files]) => ({
      directory,
      files: files.sort((a, b) => a.path.localeCompare(b.path)),
    }));
}
```

**Step 3: Build status badge sub-component**

```typescript
function StatusBadge({ status }: { status: 'added' | 'modified' | 'deleted' }) {
  const styles: Record<string, string> = {
    added: 'bg-green-100 text-green-700',
    modified: 'bg-yellow-100 text-yellow-700',
    deleted: 'bg-red-100 text-red-700',
  };
  return (
    <span className={`text-xs px-1.5 py-0.5 rounded font-medium ${styles[status]}`}>
      {status}
    </span>
  );
}
```

**Step 4: Build change bar sub-component**

```typescript
function ChangeBar({
  insertions,
  deletions,
  maxChanges,
}: {
  insertions: number;
  deletions: number;
  maxChanges: number;
}) {
  if (maxChanges === 0) return null;

  const total = insertions + deletions;
  const widthPercent = (total / maxChanges) * 100;
  const insertPercent = total > 0 ? (insertions / total) * 100 : 0;

  return (
    <div className="w-32 h-2 bg-gray-100 rounded-full overflow-hidden flex-shrink-0">
      <div
        className="h-full flex rounded-full overflow-hidden"
        style={{ width: `${Math.max(widthPercent, 2)}%` }}
      >
        <div
          className="bg-green-500 h-full"
          style={{ width: `${insertPercent}%` }}
        />
        <div
          className="bg-red-500 h-full"
          style={{ width: `${100 - insertPercent}%` }}
        />
      </div>
    </div>
  );
}
```

**Step 5: Build the main DiffViewer component**

```tsx
export default function DiffViewer({ diffSummary }: DiffViewerProps) {
  const [expandedFiles, setExpandedFiles] = useState<Set<string>>(new Set());
  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(new Set());

  const fileGroups = useMemo(
    () => groupFilesByDirectory(diffSummary.files),
    [diffSummary.files]
  );

  // Find max changes for proportional bars
  const maxChanges = useMemo(
    () => Math.max(...diffSummary.files.map(f => f.insertions + f.deletions), 1),
    [diffSummary.files]
  );

  const toggleFile = (path: string) => {
    setExpandedFiles(prev => {
      const next = new Set(prev);
      if (next.has(path)) next.delete(path);
      else next.add(path);
      return next;
    });
  };

  const toggleGroup = (dir: string) => {
    setExpandedGroups(prev => {
      const next = new Set(prev);
      if (next.has(dir)) next.delete(dir);
      else next.add(dir);
      return next;
    });
  };

  // Empty state
  if (diffSummary.filesChanged === 0) {
    return (
      <div className="border rounded-lg bg-white p-4 text-center text-gray-400">
        No changes between branches
      </div>
    );
  }

  return (
    <div className="border rounded-lg bg-white">
      {/* Summary header */}
      <div className="px-4 py-3 border-b bg-gray-50 rounded-t-lg">
        <span className="font-semibold">{diffSummary.filesChanged} files changed</span>
        <span className="ml-3 text-green-600 font-medium">
          +{diffSummary.totalInsertions}
        </span>
        <span className="ml-2 text-red-600 font-medium">
          -{diffSummary.totalDeletions}
        </span>
      </div>

      {/* Grouped file list */}
      <div>
        {fileGroups.map(group => {
          const isGroupExpanded = expandedGroups.has(group.directory);

          return (
            <div key={group.directory}>
              {/* Group header (skip for root files) */}
              {group.directory !== '.' && (
                <button
                  className="w-full text-left px-4 py-2 bg-gray-50 border-b text-sm font-medium text-gray-600 hover:bg-gray-100 flex items-center gap-2"
                  onClick={() => toggleGroup(group.directory)}
                >
                  <span className="text-xs">{isGroupExpanded ? '\u25BC' : '\u25B6'}</span>
                  <span>{group.directory}</span>
                  <span className="text-gray-400">({group.files.length} files)</span>
                </button>
              )}

              {/* Files in group (show if root or group is expanded) */}
              {(group.directory === '.' || isGroupExpanded) && (
                group.files.map(file => {
                  const fileName = file.path.split('/').pop() || file.path;
                  const isExpanded = expandedFiles.has(file.path);

                  return (
                    <div key={file.path} className="border-b last:border-b-0">
                      <button
                        className="w-full text-left px-4 py-2 text-sm hover:bg-gray-50 flex items-center gap-3"
                        onClick={() => toggleFile(file.path)}
                      >
                        <StatusBadge status={file.status} />
                        <span className="flex-1 truncate font-mono text-xs">
                          {group.directory === '.' ? file.path : fileName}
                        </span>
                        <span className="text-xs text-green-600">+{file.insertions}</span>
                        <span className="text-xs text-red-600">-{file.deletions}</span>
                        <ChangeBar
                          insertions={file.insertions}
                          deletions={file.deletions}
                          maxChanges={maxChanges}
                        />
                      </button>

                      {/* Expanded details */}
                      {isExpanded && (
                        <div className="px-4 py-2 bg-gray-50 border-t text-xs text-gray-600">
                          <div className="font-mono mb-1">{file.path}</div>
                          <div>
                            <span className="text-green-600 font-medium">
                              +{file.insertions} insertions
                            </span>
                            {', '}
                            <span className="text-red-600 font-medium">
                              -{file.deletions} deletions
                            </span>
                            {' | Status: '}
                            <StatusBadge status={file.status} />
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}
```

### 3.3 API Contract
N/A — this is a presentational component. It receives data via props; it does not make API calls directly.

---

## 4. Definition of Done (The Gate)
- [ ] `src/client/components/DiffViewer.tsx` exists and exports a default React component.
- [ ] Component accepts a `diffSummary` prop of type `BranchDiffSummary`.
- [ ] Summary header shows file count, insertions (green), and deletions (red).
- [ ] File list renders with path, status badge, and proportional green/red change bar.
- [ ] Status badges use correct colors: green (added), yellow (modified), red (deleted).
- [ ] Clicking a file row toggles expanded details (line counts, full path, status).
- [ ] Files are grouped by directory with collapsible group headers.
- [ ] Groups start collapsed by default.
- [ ] Zero-change diffs render "No changes between branches" message.
- [ ] Component renders without console errors or TypeScript warnings.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
