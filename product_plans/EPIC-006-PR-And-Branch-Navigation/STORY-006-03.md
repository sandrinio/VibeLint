---
id: STORY-006-03
parent_epic: EPIC-006
status: Draft
actor: Backend Developer
complexity: Medium (2-3 files)
---
# STORY-006-03: Branch Listing API

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** REST API endpoints that expose branch listings and diff summaries for a connected repository,
**So that** the PR Navigator frontend can fetch branch data and display diff stats without directly invoking git commands.

### 1.2 Detailed Requirements
- **Requirement 1**: Create a Fastify route plugin at `src/server/api/branches.ts` that registers branch-related routes under `/api/repos/:repoId/branches`.
- **Requirement 2**: Implement `GET /api/repos/:repoId/branches` that returns all branches with metadata (name, isCurrent, lastCommitDate, lastCommitHash, ahead, behind).
- **Requirement 3**: Implement `GET /api/repos/:repoId/branches/:branch/diff` that returns a `BranchDiffSummary` for the specified branch vs a base branch.
- **Requirement 4**: Accept a `base` query parameter on the diff endpoint (default: auto-detect `main` or `master`, whichever exists).
- **Requirement 5**: Look up the repository path from the `repos` table using `repoId`, and return 404 if the repo is not found.
- **Requirement 6**: Handle URL-encoded branch names (e.g., `feature%2Fauth` decodes to `feature/auth`).
- **Requirement 7**: Return consistent JSON error responses with `{ error: string, code: string }` for all error cases.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Branch Listing API

  Scenario: List branches for a repo
    Given a repo with id "repo-1" exists in the database with path "/projects/myapp"
    And the repo has branches "main", "feature/auth", "fix/typo"
    When I GET /api/repos/repo-1/branches
    Then the response status is 200
    And the body contains an array of 3 branch objects
    And each object has name, isCurrent, lastCommitDate, lastCommitHash, ahead, behind

  Scenario: Get diff summary for a branch
    Given repo "repo-1" has branch "feature/auth" with 5 files changed vs "main"
    When I GET /api/repos/repo-1/branches/feature%2Fauth/diff
    Then the response status is 200
    And the body contains filesChanged equal to 5
    And the body contains files array with per-file stats

  Scenario: Specify a custom base branch
    Given repo "repo-1" has branches "develop" and "feature/auth"
    When I GET /api/repos/repo-1/branches/feature%2Fauth/diff?base=develop
    Then the diff is computed against "develop" instead of "main"

  Scenario: Auto-detect base branch
    Given repo "repo-1" has "master" but not "main"
    When I GET /api/repos/repo-1/branches/feature%2Fauth/diff
    Then the diff is computed against "master"

  Scenario: Repo not found
    Given no repo with id "nonexistent" exists
    When I GET /api/repos/nonexistent/branches
    Then the response status is 404
    And the body contains { error: "Repository not found", code: "REPO_NOT_FOUND" }

  Scenario: Branch not found
    Given repo "repo-1" exists but has no branch "nonexistent"
    When I GET /api/repos/repo-1/branches/nonexistent/diff
    Then the response status is 404
    And the body contains { error: "Branch not found: nonexistent", code: "BRANCH_NOT_FOUND" }
```

### 2.2 Verification Steps
- [ ] `GET /api/repos/:repoId/branches` returns 200 with correct branch array.
- [ ] `GET /api/repos/:repoId/branches/:branch/diff` returns 200 with valid `BranchDiffSummary`.
- [ ] `base` query parameter overrides the default base branch.
- [ ] Auto-detection picks `main` first, falls back to `master`.
- [ ] URL-encoded branch names (slashes as `%2F`) are decoded correctly.
- [ ] 404 returned for unknown repoId or unknown branch.
- [ ] Error responses use consistent `{ error, code }` structure.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/api/branches.ts` (create)
- **Related Files**:
  - `src/server/git/history.ts` (STORY-006-02 — `listBranches`, `getCurrentBranch`)
  - `src/server/git/diff.ts` (STORY-006-01 — `getBranchDiff`)
  - `src/server/db/queries.ts` (existing — `getRepoById`)
  - `src/server/index.ts` (existing — register the plugin)
- **New Files Needed**:
  - `src/server/api/branches.ts`

### 3.2 Technical Logic

**Step 1: Create Fastify plugin structure**

```typescript
// src/server/api/branches.ts
import { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import { listBranches } from '../git/history.js';
import { getBranchDiff, BranchNotFoundError, NotAGitRepoError } from '../git/diff.js';
import { getRepoById } from '../db/queries.js';

interface RepoParams {
  repoId: string;
}

interface BranchParams extends RepoParams {
  branch: string;
}

interface DiffQuery {
  base?: string;
}

export default async function branchRoutes(fastify: FastifyInstance) {
  // GET /api/repos/:repoId/branches
  fastify.get<{ Params: RepoParams }>(
    '/api/repos/:repoId/branches',
    async (request, reply) => {
      const { repoId } = request.params;

      const repo = getRepoById(repoId);
      if (!repo) {
        return reply.status(404).send({
          error: 'Repository not found',
          code: 'REPO_NOT_FOUND',
        });
      }

      try {
        const branches = await listBranches(repo.path);
        return reply.send(branches);
      } catch (err) {
        return reply.status(500).send({
          error: 'Failed to list branches',
          code: 'GIT_ERROR',
        });
      }
    }
  );

  // GET /api/repos/:repoId/branches/:branch/diff
  fastify.get<{ Params: BranchParams; Querystring: DiffQuery }>(
    '/api/repos/:repoId/branches/:branch/diff',
    async (request, reply) => {
      const { repoId, branch } = request.params;
      const { base } = request.query;

      const repo = getRepoById(repoId);
      if (!repo) {
        return reply.status(404).send({
          error: 'Repository not found',
          code: 'REPO_NOT_FOUND',
        });
      }

      // Auto-detect base branch if not specified
      const baseBranch = base ?? await detectDefaultBranch(repo.path);

      try {
        const diffSummary = await getBranchDiff(repo.path, branch, baseBranch);
        return reply.send(diffSummary);
      } catch (err) {
        if (err instanceof BranchNotFoundError) {
          return reply.status(404).send({
            error: err.message,
            code: 'BRANCH_NOT_FOUND',
          });
        }
        if (err instanceof NotAGitRepoError) {
          return reply.status(400).send({
            error: err.message,
            code: 'NOT_A_GIT_REPO',
          });
        }
        return reply.status(500).send({
          error: 'Failed to compute diff',
          code: 'DIFF_ERROR',
        });
      }
    }
  );
}
```

**Step 2: Implement base branch auto-detection**

```typescript
import { execCommand } from '../utils/exec.js';

async function detectDefaultBranch(repoPath: string): Promise<string> {
  // Check if 'main' exists
  try {
    await execCommand('git rev-parse --verify main', { cwd: repoPath });
    return 'main';
  } catch {
    // 'main' doesn't exist
  }

  // Check if 'master' exists
  try {
    await execCommand('git rev-parse --verify master', { cwd: repoPath });
    return 'master';
  } catch {
    // 'master' doesn't exist
  }

  // Fallback: use the first branch from git branch output
  try {
    const result = await execCommand('git branch --format="%(refname:short)"', { cwd: repoPath });
    const firstBranch = result.stdout.trim().split('\n')[0]?.trim();
    if (firstBranch) return firstBranch;
  } catch {
    // ignore
  }

  // Final fallback
  return 'main';
}
```

**Step 3: Register the plugin in the Fastify server**

```typescript
// In src/server/index.ts — add to the existing plugin registrations:
import branchRoutes from './api/branches.js';

// Inside the server setup function:
await server.register(branchRoutes);
```

### 3.3 API Contract

**GET `/api/repos/:repoId/branches`**

Response `200`:
```json
[
  {
    "name": "feature/auth",
    "isCurrent": true,
    "lastCommitDate": "2026-02-20T14:30:00-05:00",
    "lastCommitHash": "a1b2c3d",
    "ahead": 3,
    "behind": 0
  },
  {
    "name": "main",
    "isCurrent": false,
    "lastCommitDate": "2026-02-18T10:00:00-05:00",
    "lastCommitHash": "e4f5g6h",
    "ahead": 0,
    "behind": 0
  }
]
```

**GET `/api/repos/:repoId/branches/:branch/diff?base=main`**

Response `200`:
```json
{
  "branch": "feature/auth",
  "baseBranch": "main",
  "filesChanged": 5,
  "totalInsertions": 120,
  "totalDeletions": 30,
  "files": [
    {
      "path": "src/auth/login.ts",
      "insertions": 45,
      "deletions": 0,
      "status": "added"
    },
    {
      "path": "src/index.ts",
      "insertions": 5,
      "deletions": 2,
      "status": "modified"
    }
  ]
}
```

**Error responses** (all endpoints):
```json
{ "error": "Repository not found", "code": "REPO_NOT_FOUND" }
{ "error": "Branch not found: nonexistent", "code": "BRANCH_NOT_FOUND" }
{ "error": "Not a git repository: /path", "code": "NOT_A_GIT_REPO" }
```

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/api/branches.ts` exists and exports a Fastify plugin with branch routes.
- [ ] `GET /api/repos/:repoId/branches` returns branch list with metadata from git history.
- [ ] `GET /api/repos/:repoId/branches/:branch/diff` returns `BranchDiffSummary` JSON.
- [ ] `base` query parameter overrides auto-detected default branch.
- [ ] Auto-detection tries `main`, then `master`, then first branch.
- [ ] URL-encoded branch names are decoded correctly.
- [ ] 404 returned for unknown repos and unknown branches with `{ error, code }` format.
- [ ] Plugin is registered in `src/server/index.ts`.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
