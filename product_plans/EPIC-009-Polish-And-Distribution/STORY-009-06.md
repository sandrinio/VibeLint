---
id: STORY-009-06
parent_epic: EPIC-009
status: Draft
actor: Frontend Developer
complexity: High (4+ files)
---
# STORY-009-06: Settings Page

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Frontend Developer,
**I want** a comprehensive Settings page where users can configure their platform, API keys, analysis thresholds, pre-commit hooks, connected repositories, and view app information,
**So that** all VibeLint configuration is accessible from a single, well-organized page instead of being scattered or hardcoded.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/client/pages/Settings.tsx` with the following sections, each as a collapsible or tabbed section:
  - **General**: Selected platform (dropdown: Claude Code, Cursor, Windsurf, Gemini CLI, Antigravity, Other), data directory path (read-only display).
  - **API Keys**: AI provider dropdown (Anthropic, OpenAI, Google) + API key text input (masked with `type="password"`). Save and Clear buttons. Show saved status indicator.
  - **Analysis Thresholds**: Number inputs for: complexity limit (default 15), duplication percentage (default 5), file size limit in lines (default 500), function size limit in lines (default 50). Save button.
  - **Pre-commit Hooks**: List of connected repos, each with a toggle switch (on/off) and Install/Remove buttons. Toggle calls the hook API from STORY-009-05.
  - **Repositories**: List of all connected repos with name, path, and a "Remove" button. No ability to add repos here (that's in the Setup Wizard).
  - **About**: VibeLint version number (read from package.json), link to documentation, link to GitHub issues.
- **Requirement 2**: All settings are persisted via the config API: `PUT /api/config/:key` to save, `GET /api/config/:key` to read. Keys: `platform`, `apiProvider`, `apiKey` (stored encrypted or hashed), `thresholds`.
- **Requirement 3**: Settings should load their current values from the API on mount. Show a loading state while fetching.
- **Requirement 4**: After saving any setting, show a success toast ("Settings saved") or error toast if the save fails.
- **Requirement 5**: API key input must be masked. When a key is already saved, display `"sk-...****"` (first 3 chars + masked). The Clear button removes the stored key entirely.
- **Requirement 6**: Add a route `/settings` in the app router pointing to this page. Add "Settings" to the navigation sidebar/header.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Settings Page

  Scenario: Settings page loads with current values
    Given the user has previously saved platform as "Claude Code"
    When the user navigates to /settings
    Then the platform dropdown shows "Claude Code" as selected
    And all threshold inputs show their saved values

  Scenario: Change platform setting
    Given the user is on the Settings page
    When the user selects "Cursor" from the platform dropdown
    And clicks "Save"
    Then PUT /api/config/platform is called with { "value": "cursor" }
    And a success toast appears

  Scenario: Save API key
    Given the user is on the Settings page
    When the user selects "Anthropic" as the provider
    And enters an API key "sk-ant-api03-abc123..."
    And clicks "Save"
    Then PUT /api/config/apiKey is called
    And the key input shows "sk-...****"

  Scenario: Clear API key
    Given an API key is saved
    When the user clicks "Clear"
    Then the API key is removed from the config
    And the input shows placeholder text

  Scenario: Save analysis thresholds
    Given the user is on the Settings page
    When the user changes the complexity limit to 20
    And clicks "Save" in the thresholds section
    Then PUT /api/config/thresholds is called with the updated values
    And a success toast appears

  Scenario: Toggle pre-commit hook
    Given the user is on the Settings page
    And repo "my-app" is listed under Pre-commit Hooks
    When the user toggles the pre-commit switch ON for "my-app"
    Then POST /api/repos/my-app-id/hooks/install is called
    And the toggle shows as enabled

  Scenario: Remove repository
    Given the user is on the Settings page
    And repo "my-app" is listed under Repositories
    When the user clicks "Remove" for "my-app"
    And confirms the removal
    Then DELETE /api/repos/my-app-id is called
    And the repo is removed from the list

  Scenario: About section shows version
    Given the user is on the Settings page
    When they scroll to the About section
    Then the VibeLint version number is displayed
```

### 2.2 Verification Steps
- [ ] `/settings` route renders the Settings page.
- [ ] "Settings" link is visible in the navigation.
- [ ] General section: platform dropdown works, data directory is read-only.
- [ ] API Keys section: masked input, save, clear, status indicator.
- [ ] Thresholds section: all 4 number inputs with save.
- [ ] Pre-commit Hooks section: toggle per repo, calls hook API.
- [ ] Repositories section: lists repos with remove buttons.
- [ ] About section: version number, doc links.
- [ ] All saves trigger toast notifications.
- [ ] Settings load from API on mount.
- [ ] No TypeScript compilation errors.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**:
  - `src/client/pages/Settings.tsx` (create)
- **Related Files**:
  - `src/client/App.tsx` (add route)
  - `src/client/lib/api.ts` (add settings API helpers)
  - `src/client/components/Toast.tsx` (use existing toast system from STORY-009-01)
  - `src/server/api/config.ts` (existing config endpoints)
  - `src/server/api/hooks.ts` (hook endpoints from STORY-009-05)
- **New Files Needed**:
  - `src/client/pages/Settings.tsx`
  - `src/client/components/SettingsSection.tsx` (optional — reusable collapsible section)

### 3.2 Technical Logic

**Step 1: Add settings API helper functions**

```typescript
// src/client/lib/api.ts — add settings helpers

export async function getConfig(key: string): Promise<any> {
  return apiFetch(`/api/config/${key}`);
}

export async function setConfig(key: string, value: any): Promise<any> {
  return apiFetch(`/api/config/${key}`, {
    method: 'PUT',
    body: JSON.stringify({ value }),
  });
}

export async function deleteConfig(key: string): Promise<any> {
  return apiFetch(`/api/config/${key}`, { method: 'DELETE' });
}

export async function listRepos(): Promise<any[]> {
  return apiFetch('/api/repos');
}

export async function removeRepo(repoId: string): Promise<void> {
  return apiFetch(`/api/repos/${repoId}`, { method: 'DELETE' });
}

export async function getHookStatus(repoId: string): Promise<{ installed: boolean }> {
  return apiFetch(`/api/repos/${repoId}/hooks/status`);
}

export async function installHook(repoId: string): Promise<any> {
  return apiFetch(`/api/repos/${repoId}/hooks/install`, { method: 'POST' });
}

export async function removeHook(repoId: string): Promise<any> {
  return apiFetch(`/api/repos/${repoId}/hooks/install`, { method: 'DELETE' });
}
```

**Step 2: Create a reusable collapsible section component**

```tsx
// src/client/components/SettingsSection.tsx
import React, { useState, ReactNode } from 'react';

interface SettingsSectionProps {
  title: string;
  description?: string;
  children: ReactNode;
  defaultOpen?: boolean;
}

export function SettingsSection({
  title,
  description,
  children,
  defaultOpen = true,
}: SettingsSectionProps) {
  const [isOpen, setIsOpen] = useState(defaultOpen);

  return (
    <div className="bg-white rounded-lg shadow mb-4">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="w-full px-6 py-4 flex items-center justify-between text-left"
      >
        <div>
          <h2 className="text-lg font-semibold text-gray-900">{title}</h2>
          {description && (
            <p className="text-sm text-gray-500 mt-1">{description}</p>
          )}
        </div>
        <svg
          className={`w-5 h-5 text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none" stroke="currentColor" viewBox="0 0 24 24"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      {isOpen && <div className="px-6 pb-6">{children}</div>}
    </div>
  );
}
```

**Step 3: Create the Settings page**

```tsx
// src/client/pages/Settings.tsx
import React, { useState, useEffect } from 'react';
import { SettingsSection } from '../components/SettingsSection';
import { useToast } from '../components/Toast';
import {
  getConfig, setConfig, deleteConfig,
  listRepos, removeRepo,
  getHookStatus, installHook, removeHook,
} from '../lib/api';
import { Spinner } from '../components/Spinner';

const PLATFORMS = [
  { value: 'claude-code', label: 'Claude Code' },
  { value: 'cursor', label: 'Cursor' },
  { value: 'windsurf', label: 'Windsurf' },
  { value: 'gemini-cli', label: 'Gemini CLI' },
  { value: 'antigravity', label: 'Antigravity' },
  { value: 'other', label: 'Other' },
];

const AI_PROVIDERS = [
  { value: 'anthropic', label: 'Anthropic' },
  { value: 'openai', label: 'OpenAI' },
  { value: 'google', label: 'Google' },
];

interface Thresholds {
  complexityLimit: number;
  duplicationPercent: number;
  fileSizeLimit: number;
  functionSizeLimit: number;
}

const DEFAULT_THRESHOLDS: Thresholds = {
  complexityLimit: 15,
  duplicationPercent: 5,
  fileSizeLimit: 500,
  functionSizeLimit: 50,
};

export default function Settings() {
  const { addToast } = useToast();
  const [loading, setLoading] = useState(true);

  // General
  const [platform, setPlatform] = useState('claude-code');
  const [dataDir, setDataDir] = useState('');

  // API Keys
  const [apiProvider, setApiProvider] = useState('anthropic');
  const [apiKey, setApiKey] = useState('');
  const [apiKeyMasked, setApiKeyMasked] = useState('');
  const [hasApiKey, setHasApiKey] = useState(false);

  // Thresholds
  const [thresholds, setThresholds] = useState<Thresholds>(DEFAULT_THRESHOLDS);

  // Repos + Hooks
  const [repos, setRepos] = useState<any[]>([]);
  const [hookStatus, setHookStatus] = useState<Record<string, boolean>>({});

  useEffect(() => {
    loadSettings();
  }, []);

  async function loadSettings() {
    try {
      setLoading(true);
      const [platformConfig, providerConfig, keyConfig, threshConfig, dataConfig, repoList] =
        await Promise.all([
          getConfig('platform').catch(() => null),
          getConfig('apiProvider').catch(() => null),
          getConfig('apiKey').catch(() => null),
          getConfig('thresholds').catch(() => null),
          getConfig('dataDir').catch(() => null),
          listRepos().catch(() => []),
        ]);

      if (platformConfig?.value) setPlatform(platformConfig.value);
      if (providerConfig?.value) setApiProvider(providerConfig.value);
      if (keyConfig?.value) {
        setHasApiKey(true);
        // Show masked version: first 3 chars + ****
        const key = keyConfig.value;
        setApiKeyMasked(key.slice(0, 5) + '****');
      }
      if (threshConfig?.value) {
        setThresholds({ ...DEFAULT_THRESHOLDS, ...JSON.parse(threshConfig.value) });
      }
      if (dataConfig?.value) setDataDir(dataConfig.value);

      setRepos(repoList);

      // Load hook status for each repo
      const statuses: Record<string, boolean> = {};
      await Promise.all(
        repoList.map(async (repo: any) => {
          try {
            const status = await getHookStatus(repo.id);
            statuses[repo.id] = status.installed;
          } catch {
            statuses[repo.id] = false;
          }
        })
      );
      setHookStatus(statuses);
    } finally {
      setLoading(false);
    }
  }

  async function savePlatform() {
    try {
      await setConfig('platform', platform);
      addToast('Platform setting saved', 'success');
    } catch {
      addToast('Failed to save platform setting', 'error');
    }
  }

  async function saveApiKey() {
    try {
      await setConfig('apiProvider', apiProvider);
      await setConfig('apiKey', apiKey);
      setHasApiKey(true);
      setApiKeyMasked(apiKey.slice(0, 5) + '****');
      setApiKey('');
      addToast('API key saved', 'success');
    } catch {
      addToast('Failed to save API key', 'error');
    }
  }

  async function clearApiKey() {
    try {
      await deleteConfig('apiKey');
      setHasApiKey(false);
      setApiKeyMasked('');
      setApiKey('');
      addToast('API key removed', 'success');
    } catch {
      addToast('Failed to remove API key', 'error');
    }
  }

  async function saveThresholds() {
    try {
      await setConfig('thresholds', JSON.stringify(thresholds));
      addToast('Thresholds saved', 'success');
    } catch {
      addToast('Failed to save thresholds', 'error');
    }
  }

  async function toggleHook(repoId: string) {
    const isInstalled = hookStatus[repoId];
    try {
      if (isInstalled) {
        await removeHook(repoId);
        setHookStatus((prev) => ({ ...prev, [repoId]: false }));
        addToast('Pre-commit hook removed', 'success');
      } else {
        await installHook(repoId);
        setHookStatus((prev) => ({ ...prev, [repoId]: true }));
        addToast('Pre-commit hook installed', 'success');
      }
    } catch {
      addToast('Failed to update hook', 'error');
    }
  }

  async function handleRemoveRepo(repoId: string, repoName: string) {
    if (!confirm(`Remove "${repoName}" from VibeLint? This won't delete the repo itself.`)) {
      return;
    }
    try {
      await removeRepo(repoId);
      setRepos((prev) => prev.filter((r) => r.id !== repoId));
      addToast(`Removed ${repoName}`, 'success');
    } catch {
      addToast('Failed to remove repository', 'error');
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Spinner size="lg" />
      </div>
    );
  }

  return (
    <div className="max-w-3xl mx-auto p-6">
      <h1 className="text-3xl font-bold text-gray-900 mb-6">Settings</h1>

      {/* General */}
      <SettingsSection title="General" description="Platform and data directory configuration">
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              AI Coding Platform
            </label>
            <div className="flex gap-2">
              <select
                value={platform}
                onChange={(e) => setPlatform(e.target.value)}
                className="flex-1 rounded-md border border-gray-300 px-3 py-2"
              >
                {PLATFORMS.map((p) => (
                  <option key={p.value} value={p.value}>{p.label}</option>
                ))}
              </select>
              <button onClick={savePlatform}
                className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Save
              </button>
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Data Directory
            </label>
            <input type="text" value={dataDir || '~/.vibelint'} readOnly
              className="w-full rounded-md border border-gray-300 px-3 py-2 bg-gray-50 text-gray-500" />
          </div>
        </div>
      </SettingsSection>

      {/* API Keys */}
      <SettingsSection title="API Keys" description="Configure AI provider API keys for dashboard features">
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              AI Provider
            </label>
            <select value={apiProvider} onChange={(e) => setApiProvider(e.target.value)}
              className="w-full rounded-md border border-gray-300 px-3 py-2">
              {AI_PROVIDERS.map((p) => (
                <option key={p.value} value={p.value}>{p.label}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              API Key {hasApiKey && <span className="text-green-600 text-xs ml-2">Saved</span>}
            </label>
            <input
              type="password"
              value={apiKey}
              onChange={(e) => setApiKey(e.target.value)}
              placeholder={hasApiKey ? apiKeyMasked : 'Enter your API key'}
              className="w-full rounded-md border border-gray-300 px-3 py-2"
            />
          </div>
          <div className="flex gap-2">
            <button onClick={saveApiKey} disabled={!apiKey}
              className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50">
              Save Key
            </button>
            {hasApiKey && (
              <button onClick={clearApiKey}
                className="px-4 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200">
                Clear Key
              </button>
            )}
          </div>
        </div>
      </SettingsSection>

      {/* Analysis Thresholds */}
      <SettingsSection title="Analysis Thresholds" description="Configure quality gates for analysis checks">
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Complexity Limit
            </label>
            <input type="number" value={thresholds.complexityLimit}
              onChange={(e) => setThresholds((t) => ({ ...t, complexityLimit: parseInt(e.target.value) || 0 }))}
              className="w-full rounded-md border border-gray-300 px-3 py-2" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Duplication % Limit
            </label>
            <input type="number" value={thresholds.duplicationPercent}
              onChange={(e) => setThresholds((t) => ({ ...t, duplicationPercent: parseInt(e.target.value) || 0 }))}
              className="w-full rounded-md border border-gray-300 px-3 py-2" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              File Size Limit (lines)
            </label>
            <input type="number" value={thresholds.fileSizeLimit}
              onChange={(e) => setThresholds((t) => ({ ...t, fileSizeLimit: parseInt(e.target.value) || 0 }))}
              className="w-full rounded-md border border-gray-300 px-3 py-2" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Function Size Limit (lines)
            </label>
            <input type="number" value={thresholds.functionSizeLimit}
              onChange={(e) => setThresholds((t) => ({ ...t, functionSizeLimit: parseInt(e.target.value) || 0 }))}
              className="w-full rounded-md border border-gray-300 px-3 py-2" />
          </div>
        </div>
        <button onClick={saveThresholds}
          className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
          Save Thresholds
        </button>
      </SettingsSection>

      {/* Pre-commit Hooks */}
      <SettingsSection title="Pre-commit Hooks" description="Auto-run VibeLint analysis before git commits">
        {repos.length === 0 ? (
          <p className="text-gray-500 text-sm">No repositories connected.</p>
        ) : (
          <div className="space-y-3">
            {repos.map((repo) => (
              <div key={repo.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                <div>
                  <span className="font-medium text-gray-900">{repo.name}</span>
                  <span className="text-sm text-gray-500 ml-2">{repo.path}</span>
                </div>
                <button
                  onClick={() => toggleHook(repo.id)}
                  className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                    hookStatus[repo.id] ? 'bg-blue-600' : 'bg-gray-300'
                  }`}
                >
                  <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                    hookStatus[repo.id] ? 'translate-x-6' : 'translate-x-1'
                  }`} />
                </button>
              </div>
            ))}
          </div>
        )}
      </SettingsSection>

      {/* Repositories */}
      <SettingsSection title="Repositories" description="Manage connected repositories">
        {repos.length === 0 ? (
          <p className="text-gray-500 text-sm">No repositories connected. Use the Setup Wizard to add repos.</p>
        ) : (
          <div className="space-y-2">
            {repos.map((repo) => (
              <div key={repo.id} className="flex items-center justify-between p-3 border border-gray-200 rounded-md">
                <div>
                  <div className="font-medium text-gray-900">{repo.name}</div>
                  <div className="text-sm text-gray-500">{repo.path}</div>
                </div>
                <button onClick={() => handleRemoveRepo(repo.id, repo.name)}
                  className="px-3 py-1 text-sm text-red-600 hover:bg-red-50 rounded-md">
                  Remove
                </button>
              </div>
            ))}
          </div>
        )}
      </SettingsSection>

      {/* About */}
      <SettingsSection title="About" description="VibeLint application information">
        <div className="space-y-2 text-sm text-gray-600">
          <p><span className="font-medium">Version:</span> 0.1.0</p>
          <p>
            <a href="https://github.com/vibelint/vibelint" target="_blank" rel="noopener noreferrer"
              className="text-blue-600 hover:underline">Documentation</a>
          </p>
          <p>
            <a href="https://github.com/vibelint/vibelint/issues" target="_blank" rel="noopener noreferrer"
              className="text-blue-600 hover:underline">Report an Issue</a>
          </p>
        </div>
      </SettingsSection>
    </div>
  );
}
```

**Step 4: Add the Settings route to App.tsx**

```tsx
// src/client/App.tsx — add lazy import and route

const Settings = lazy(() => import('./pages/Settings'));

// In Routes:
<Route path="/settings" element={<Settings />} />
```

**Step 5: Add Settings to the navigation**

```tsx
// In the navigation component (sidebar or header), add:
<NavLink to="/settings" className={/* ... */}>
  Settings
</NavLink>
```

### 3.3 API Contract

This story uses existing config endpoints. Recap of the config API:

```
GET /api/config/:key
Response (200): { "key": "platform", "value": "claude-code" }
Response (404): { "error": "Config 'xyz' not found", "code": "NOT_FOUND" }

PUT /api/config/:key
Body: { "value": "cursor" }
Response (200): { "key": "platform", "value": "cursor" }

DELETE /api/config/:key
Response (200): { "success": true }
```

Also uses repo and hook endpoints from their respective stories.

---

## 4. Definition of Done (The Gate)
- [ ] `src/client/pages/Settings.tsx` exists and renders all 6 sections.
- [ ] `/settings` route is registered in `App.tsx`.
- [ ] "Settings" link appears in the navigation.
- [ ] General section: platform dropdown saves via config API, data directory is read-only.
- [ ] API Keys section: masked input, save, clear, and saved indicator all work.
- [ ] Thresholds section: 4 number inputs save as JSON to config API.
- [ ] Pre-commit Hooks section: toggle per repo calls hook install/remove API.
- [ ] Repositories section: lists repos with working remove button (with confirmation).
- [ ] About section: shows version, documentation link, issues link.
- [ ] All save/toggle actions show success or error toasts.
- [ ] Settings load from API on page mount with loading state.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
