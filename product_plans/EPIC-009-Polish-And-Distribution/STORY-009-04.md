---
id: STORY-009-04
parent_epic: EPIC-009
status: Draft
actor: Full-Stack Developer
complexity: Medium (2-3 files)
---
# STORY-009-04: Export Analysis Reports

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Full-Stack Developer,
**I want** to export analysis reports as downloadable Markdown or JSON files from both the API and the UI,
**So that** users can share analysis results with teammates, archive them, or use them in external tools and CI pipelines.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `GET /api/repos/:repoId/analysis/:id/export?format=md|json` endpoint.
- **Requirement 2**: Markdown export (`format=md`): read the generated report from `.vibelint/reports/latest.md` in the repo (or regenerate from the stored analysis data if the file doesn't exist). Return as a downloadable file with `Content-Disposition: attachment; filename="vibelint-report-{repoName}-{date}.md"` and `Content-Type: text/markdown`.
- **Requirement 3**: JSON export (`format=json`): return the full structured analysis data from the database as a downloadable JSON file with `Content-Disposition: attachment; filename="vibelint-report-{repoName}-{date}.json"` and `Content-Type: application/json`.
- **Requirement 4**: If `format` is not specified or invalid, default to `md`.
- **Requirement 5**: If the requested analysis ID doesn't exist, return 404.
- **Requirement 6**: Add an "Export" dropdown button on the Analysis View page with two options: "Export as Markdown" and "Export as JSON". Clicking either option triggers a file download.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Export Analysis Reports

  Scenario: Export as Markdown
    Given an analysis with id 42 exists for repo "my-app"
    When I send GET /api/repos/my-app/analysis/42/export?format=md
    Then the response status is 200
    And the Content-Type is "text/markdown"
    And the Content-Disposition header contains "vibelint-report-my-app"
    And the response body is a valid markdown report

  Scenario: Export as JSON
    Given an analysis with id 42 exists for repo "my-app"
    When I send GET /api/repos/my-app/analysis/42/export?format=json
    Then the response status is 200
    And the Content-Type is "application/json"
    And the Content-Disposition header contains "vibelint-report-my-app"
    And the response body is valid JSON with analysis data

  Scenario: Default format is Markdown
    Given an analysis with id 42 exists for repo "my-app"
    When I send GET /api/repos/my-app/analysis/42/export (no format param)
    Then the response is a Markdown file download

  Scenario: Analysis not found
    Given no analysis with id 999 exists
    When I send GET /api/repos/my-app/analysis/999/export
    Then the response status is 404
    And the response body matches { "error": "...", "code": "NOT_FOUND" }

  Scenario: UI export dropdown
    Given the user is on the Analysis View page with a completed analysis
    When the user clicks the "Export" dropdown button
    Then two options are visible: "Export as Markdown" and "Export as JSON"

  Scenario: UI Markdown download
    Given the Export dropdown is open
    When the user clicks "Export as Markdown"
    Then a file download starts for the Markdown report

  Scenario: UI JSON download
    Given the Export dropdown is open
    When the user clicks "Export as JSON"
    Then a file download starts for the JSON report
```

### 2.2 Verification Steps
- [ ] `GET /api/repos/:repoId/analysis/:id/export?format=md` returns markdown with correct headers.
- [ ] `GET /api/repos/:repoId/analysis/:id/export?format=json` returns JSON with correct headers.
- [ ] `Content-Disposition` header triggers file download in browsers.
- [ ] Missing format parameter defaults to Markdown.
- [ ] Non-existent analysis ID returns 404 with structured error.
- [ ] UI export dropdown is visible and triggers correct downloads.
- [ ] No TypeScript compilation errors.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**:
  - `src/server/api/analysis.ts` (modify — add export endpoint)
  - `src/client/pages/AnalysisView.tsx` (modify — add Export dropdown)
- **Related Files**:
  - `src/server/db/queries.ts` (getAnalysis query)
  - `src/server/analyzer/report-writer.ts` (existing report generation, if available)
  - `src/client/lib/api.ts` (add export URL builder)
- **New Files Needed**: None

### 3.2 Technical Logic

**Step 1: Add the export endpoint to the analysis API**

```typescript
// src/server/api/analysis.ts — add export route

import { readFile } from 'node:fs/promises';
import path from 'node:path';
import { notFound, badRequest } from '../utils/errors.js';

server.get('/api/repos/:repoId/analysis/:id/export', async (request, reply) => {
  const { repoId, id } = request.params as { repoId: string; id: string };
  const { format } = request.query as { format?: string };

  const analysisId = parseInt(id, 10);
  if (isNaN(analysisId)) {
    throw badRequest('Invalid analysis ID');
  }

  // Fetch analysis from database
  const analysis = db.getAnalysis(analysisId);
  if (!analysis || analysis.repo_id !== repoId) {
    throw notFound('Analysis', id);
  }

  // Fetch repo for name and path
  const repo = db.getRepo(repoId);
  if (!repo) {
    throw notFound('Repository', repoId);
  }

  const dateStr = new Date(analysis.created_at).toISOString().split('T')[0];
  const safeRepoName = repo.name.replace(/[^a-zA-Z0-9_-]/g, '_');
  const exportFormat = format === 'json' ? 'json' : 'md';

  if (exportFormat === 'json') {
    // JSON export: return structured analysis data
    const analysisData = JSON.parse(analysis.analysis_data);
    const filename = `vibelint-report-${safeRepoName}-${dateStr}.json`;

    return reply
      .header('Content-Type', 'application/json')
      .header('Content-Disposition', `attachment; filename="${filename}"`)
      .send(JSON.stringify(analysisData, null, 2));
  }

  // Markdown export: try to read from .vibelint/reports/latest.md first
  const reportPath = path.join(repo.path, '.vibelint', 'reports', 'latest.md');
  let markdownContent: string;

  try {
    markdownContent = await readFile(reportPath, 'utf-8');
  } catch {
    // File doesn't exist — generate markdown from stored analysis data
    markdownContent = generateMarkdownReport(analysis, repo);
  }

  const filename = `vibelint-report-${safeRepoName}-${dateStr}.md`;

  return reply
    .header('Content-Type', 'text/markdown')
    .header('Content-Disposition', `attachment; filename="${filename}"`)
    .send(markdownContent);
});
```

**Step 2: Implement the fallback markdown generator**

```typescript
// src/server/api/analysis.ts — helper function (or put in a shared module)

function generateMarkdownReport(analysis: any, repo: any): string {
  const data = JSON.parse(analysis.analysis_data);
  const checks = data.checks || [];

  let md = `# Analysis Report - ${repo.name}\n`;
  md += `Generated: ${analysis.created_at}\n\n`;

  if (analysis.scan_mode === 'full') {
    md += `## Full Codebase Scan\n`;
    md += `Total files analyzed: ${data.diffStats?.totalFiles ?? 'N/A'}\n\n`;
  } else {
    md += `## Branch: ${analysis.branch} vs ${analysis.base_branch}\n`;
    const stats = data.diffStats || {};
    md += `Files changed: ${stats.filesChanged ?? 'N/A'}`;
    if (stats.additions !== undefined) {
      md += ` | +${stats.additions} -${stats.deletions}`;
    }
    md += '\n\n';
  }

  md += `## Summary\n`;
  md += `| Check | Status | Duration |\n`;
  md += `|-------|--------|----------|\n`;

  for (const check of checks) {
    const statusEmoji =
      check.status === 'PASS' ? 'PASS' :
      check.status === 'WARN' ? 'WARN' :
      check.status === 'FAIL' ? 'FAIL' :
      check.status === 'TIMEOUT' ? 'TIMEOUT' : check.status;
    md += `| ${check.check} | ${statusEmoji} | ${check.durationMs}ms |\n`;
  }

  md += '\n## Details\n\n';

  for (const check of checks) {
    md += `### ${check.check}\n`;
    md += `Status: ${check.status}\n`;
    if (check.details) {
      md += `\`\`\`json\n${JSON.stringify(check.details, null, 2)}\n\`\`\`\n`;
    }
    md += '\n';
  }

  return md;
}
```

**Step 3: Add export URL builder to the frontend API client**

```typescript
// src/client/lib/api.ts

export function getExportUrl(
  repoId: string,
  analysisId: number,
  format: 'md' | 'json'
): string {
  return `/api/repos/${repoId}/analysis/${analysisId}/export?format=${format}`;
}
```

**Step 4: Add Export dropdown to Analysis View**

```tsx
// src/client/pages/AnalysisView.tsx — add export dropdown

import { useState, useRef, useEffect } from 'react';
import { getExportUrl } from '../lib/api';

function ExportDropdown({
  repoId,
  analysisId,
}: {
  repoId: string;
  analysisId: number;
}) {
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);

  // Close on outside click
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (
        dropdownRef.current &&
        !dropdownRef.current.contains(event.target as Node)
      ) {
        setIsOpen(false);
      }
    }
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  function handleExport(format: 'md' | 'json') {
    // Trigger file download by navigating to the export URL
    window.open(getExportUrl(repoId, analysisId, format), '_blank');
    setIsOpen(false);
  }

  return (
    <div className="relative" ref={dropdownRef}>
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 border border-gray-300 flex items-center gap-1"
      >
        Export
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <div className="absolute right-0 mt-1 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-10">
          <button
            onClick={() => handleExport('md')}
            className="w-full text-left px-4 py-2 text-sm hover:bg-gray-50"
          >
            Export as Markdown
          </button>
          <button
            onClick={() => handleExport('json')}
            className="w-full text-left px-4 py-2 text-sm hover:bg-gray-50"
          >
            Export as JSON
          </button>
        </div>
      )}
    </div>
  );
}

// Use in the AnalysisView header:
// <ExportDropdown repoId={repoId} analysisId={analysis.id} />
```

**Step 5: Integrate into the AnalysisView page header**

```tsx
// src/client/pages/AnalysisView.tsx — in the header section

<div className="flex items-center gap-2">
  <button onClick={() => handleRunAnalysis('branch')} disabled={isRunning}
    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50">
    {isRunning ? 'Running...' : 'Run Analysis'}
  </button>
  <button onClick={() => handleRunAnalysis('full')} disabled={isRunning}
    className="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50">
    {isRunning ? 'Running...' : 'Full Scan'}
  </button>
  {analysis?.id && (
    <ExportDropdown repoId={repoId!} analysisId={analysis.id} />
  )}
</div>
```

### 3.3 API Contract

**New Endpoint:**

```
GET /api/repos/:repoId/analysis/:id/export?format=md|json
```

| Param | Type | Default | Description |
|-------|------|---------|-------------|
| `repoId` | path param | required | Repository ID |
| `id` | path param | required | Analysis ID (integer) |
| `format` | query string | `"md"` | `"md"` for Markdown, `"json"` for JSON |

**Response (200 — Markdown):**
```
Content-Type: text/markdown
Content-Disposition: attachment; filename="vibelint-report-my-app-2026-02-23.md"

<markdown content>
```

**Response (200 — JSON):**
```
Content-Type: application/json
Content-Disposition: attachment; filename="vibelint-report-my-app-2026-02-23.json"

{ "scanMode": "branch", "diffStats": {...}, "checks": [...] }
```

**Response (404):**
```json
{ "error": "Analysis '999' not found", "code": "NOT_FOUND" }
```

---

## 4. Definition of Done (The Gate)
- [ ] `GET /api/repos/:repoId/analysis/:id/export?format=md` returns a downloadable Markdown file.
- [ ] `GET /api/repos/:repoId/analysis/:id/export?format=json` returns a downloadable JSON file.
- [ ] `Content-Disposition` header is set correctly with repo name and date in the filename.
- [ ] Missing `format` parameter defaults to Markdown.
- [ ] Non-existent analysis returns 404.
- [ ] Markdown export reads from `.vibelint/reports/latest.md` or falls back to generated report.
- [ ] Export dropdown is visible on Analysis View when an analysis exists.
- [ ] Clicking "Export as Markdown" triggers a Markdown file download.
- [ ] Clicking "Export as JSON" triggers a JSON file download.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
