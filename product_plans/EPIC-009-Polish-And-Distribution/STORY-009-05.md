---
id: STORY-009-05
parent_epic: EPIC-009
status: Draft
actor: Full-Stack Developer
complexity: Medium (2-3 files)
---
# STORY-009-05: Pre-Commit Hook Installer

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Full-Stack Developer,
**I want** VibeLint to install and manage a git pre-commit hook that automatically runs analysis before each commit,
**So that** developers get immediate feedback on code quality without needing to remember to run analysis manually, and commits that exceed quality thresholds can optionally be blocked.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/server/hooks/precommit.ts` with two exported functions: `installPreCommitHook(repoPath: string, repoId: string)` and `removePreCommitHook(repoPath: string)`.
- **Requirement 2**: `installPreCommitHook` writes a shell script to `.git/hooks/pre-commit` in the target repo. The script calls VibeLint's analyze endpoint via `curl` and checks the exit code. If analysis returns any `FAIL` results, the hook exits with code 1 (blocking the commit) and prints a summary message. If all checks pass or warn, the hook exits with code 0.
- **Requirement 3**: Handle existing pre-commit hooks: if `.git/hooks/pre-commit` already exists, append the VibeLint hook section (delimited by `# --- VibeLint pre-commit hook START ---` and `# --- VibeLint pre-commit hook END ---`) rather than overwriting the file. This allows coexistence with other hooks.
- **Requirement 4**: Handle edge cases: if `.git/hooks/` directory doesn't exist, create it. Set the hook file as executable (`chmod +x`).
- **Requirement 5**: `removePreCommitHook` removes only the VibeLint-delimited section from the pre-commit hook file. If the file contains only the VibeLint section, delete the entire file. If other hook content exists, leave it intact.
- **Requirement 6**: Create REST API endpoints: `POST /api/repos/:repoId/hooks/install` (install hook) and `DELETE /api/repos/:repoId/hooks/install` (remove hook).
- **Requirement 7**: Create `GET /api/repos/:repoId/hooks/status` to check whether the VibeLint pre-commit hook is currently installed.
- **Requirement 8**: On the Settings page (STORY-009-06), provide a toggle per repo that calls these endpoints. This story creates the backend; the Settings page UI is in STORY-009-06.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Pre-Commit Hook Installer

  Scenario: Install hook in repo with no existing hooks
    Given a repo at "/tmp/test-repo" with a .git directory
    And no pre-commit hook exists
    When I call installPreCommitHook("/tmp/test-repo", "repo-1")
    Then .git/hooks/pre-commit exists
    And it contains the VibeLint START and END delimiters
    And it contains a curl call to localhost:3847
    And the file is executable

  Scenario: Install hook in repo with existing pre-commit hook
    Given a repo with an existing pre-commit hook containing "eslint"
    When I call installPreCommitHook on the repo
    Then the existing "eslint" content is preserved
    And the VibeLint section is appended after the existing content
    And both the eslint and VibeLint sections run

  Scenario: Remove hook from repo
    Given a repo with the VibeLint pre-commit hook installed
    When I call removePreCommitHook on the repo
    Then the VibeLint section is removed from .git/hooks/pre-commit
    And if no other content remains, the file is deleted

  Scenario: Remove hook preserves other hooks
    Given a repo with both eslint and VibeLint pre-commit hooks
    When I call removePreCommitHook on the repo
    Then the VibeLint section is removed
    And the eslint content remains intact

  Scenario: Hook blocks commit on FAIL
    Given the VibeLint pre-commit hook is installed
    And the analysis returns a FAIL result
    When the user runs git commit
    Then the commit is blocked (exit code 1)
    And a message is printed explaining the failure

  Scenario: Hook allows commit on PASS/WARN
    Given the VibeLint pre-commit hook is installed
    And the analysis returns only PASS and WARN results
    When the user runs git commit
    Then the commit proceeds (exit code 0)

  Scenario: API install endpoint
    Given a repo "repo-1" is registered
    When I send POST /api/repos/repo-1/hooks/install
    Then the pre-commit hook is installed in the repo
    And the response status is 200

  Scenario: API remove endpoint
    Given the VibeLint hook is installed for "repo-1"
    When I send DELETE /api/repos/repo-1/hooks/install
    Then the pre-commit hook is removed
    And the response status is 200

  Scenario: API status endpoint
    Given the VibeLint hook is installed for "repo-1"
    When I send GET /api/repos/repo-1/hooks/status
    Then the response is { "installed": true }
```

### 2.2 Verification Steps
- [ ] `installPreCommitHook` creates `.git/hooks/pre-commit` with correct content.
- [ ] The hook file is executable (`chmod +x`).
- [ ] Existing hooks are preserved when VibeLint hook is appended.
- [ ] `removePreCommitHook` cleanly removes only the VibeLint section.
- [ ] The hook script correctly calls the VibeLint API and checks for FAIL results.
- [ ] `POST /api/repos/:repoId/hooks/install` installs the hook.
- [ ] `DELETE /api/repos/:repoId/hooks/install` removes the hook.
- [ ] `GET /api/repos/:repoId/hooks/status` returns correct installation status.
- [ ] No TypeScript compilation errors.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**:
  - `src/server/hooks/precommit.ts` (create)
  - `src/server/api/hooks.ts` (create — new route file for hook endpoints)
- **Related Files**:
  - `src/server/index.ts` (register hook routes)
  - `src/server/db/queries.ts` (getRepo for path lookup)
  - `src/server/utils/errors.ts` (error helpers)
- **New Files Needed**:
  - `src/server/hooks/precommit.ts`
  - `src/server/api/hooks.ts`

### 3.2 Technical Logic

**Step 1: Create the pre-commit hook module**

```typescript
// src/server/hooks/precommit.ts

import { readFile, writeFile, unlink, mkdir, chmod, access } from 'node:fs/promises';
import path from 'node:path';
import { constants } from 'node:fs';

const HOOK_START = '# --- VibeLint pre-commit hook START ---';
const HOOK_END = '# --- VibeLint pre-commit hook END ---';
const PORT = 3847;

function generateHookScript(repoId: string): string {
  return `
${HOOK_START}
# VibeLint pre-commit analysis hook
# This section was auto-installed by VibeLint. Do not edit manually.
# To remove, use: VibeLint Settings > Pre-commit Hooks > Uninstall

vibelint_check() {
  echo "[VibeLint] Running pre-commit analysis..."

  # Check if VibeLint server is running
  if ! curl -s --max-time 2 http://localhost:${PORT}/api/health > /dev/null 2>&1; then
    echo "[VibeLint] Server not running. Skipping pre-commit check."
    echo "[VibeLint] Start VibeLint with 'vibelint' to enable pre-commit analysis."
    return 0
  fi

  # Run branch analysis and capture result
  RESULT=$(curl -s --max-time 60 -X POST "http://localhost:${PORT}/api/repos/${repoId}/analyze?mode=branch")

  if [ $? -ne 0 ]; then
    echo "[VibeLint] Could not reach VibeLint server. Skipping check."
    return 0
  fi

  # Check for FAIL status in results
  # Parse JSON response for any check with status "FAIL"
  if echo "$RESULT" | grep -q '"status":"FAIL"'; then
    echo ""
    echo "============================================"
    echo "[VibeLint] PRE-COMMIT CHECK FAILED"
    echo "============================================"
    echo ""
    echo "One or more analysis checks failed."
    echo "Review the analysis at: http://localhost:${PORT}"
    echo ""
    echo "To bypass this check, use: git commit --no-verify"
    echo "============================================"
    return 1
  fi

  # Check for TIMEOUT status
  if echo "$RESULT" | grep -q '"status":"TIMEOUT"'; then
    echo "[VibeLint] Warning: Some checks timed out. Allowing commit."
  fi

  echo "[VibeLint] All checks passed. Proceeding with commit."
  return 0
}

vibelint_check
VIBELINT_EXIT=$?
if [ $VIBELINT_EXIT -ne 0 ]; then
  exit $VIBELINT_EXIT
fi
${HOOK_END}
`.trim();
}

export async function installPreCommitHook(
  repoPath: string,
  repoId: string
): Promise<void> {
  const hooksDir = path.join(repoPath, '.git', 'hooks');
  const hookPath = path.join(hooksDir, 'pre-commit');

  // Ensure .git/hooks directory exists
  try {
    await access(hooksDir, constants.F_OK);
  } catch {
    await mkdir(hooksDir, { recursive: true });
  }

  const hookScript = generateHookScript(repoId);
  let existingContent = '';

  // Read existing hook file if it exists
  try {
    existingContent = await readFile(hookPath, 'utf-8');
  } catch {
    // File doesn't exist — start fresh
  }

  // Check if VibeLint hook is already installed
  if (existingContent.includes(HOOK_START)) {
    // Replace existing VibeLint section
    const startIdx = existingContent.indexOf(HOOK_START);
    const endIdx = existingContent.indexOf(HOOK_END);
    if (endIdx !== -1) {
      const before = existingContent.slice(0, startIdx);
      const after = existingContent.slice(endIdx + HOOK_END.length);
      existingContent = before + after;
    }
  }

  // Build final content
  let finalContent: string;
  if (existingContent.trim() === '') {
    // No existing content — create new file with shebang
    finalContent = `#!/bin/sh\n\n${hookScript}\n`;
  } else {
    // Append VibeLint section to existing hook
    finalContent = existingContent.trimEnd() + '\n\n' + hookScript + '\n';
  }

  await writeFile(hookPath, finalContent, 'utf-8');
  await chmod(hookPath, 0o755);
}

export async function removePreCommitHook(repoPath: string): Promise<void> {
  const hookPath = path.join(repoPath, '.git', 'hooks', 'pre-commit');

  let content: string;
  try {
    content = await readFile(hookPath, 'utf-8');
  } catch {
    // File doesn't exist — nothing to remove
    return;
  }

  if (!content.includes(HOOK_START)) {
    // VibeLint hook not found — nothing to remove
    return;
  }

  const startIdx = content.indexOf(HOOK_START);
  const endIdx = content.indexOf(HOOK_END);

  if (endIdx === -1) {
    // Malformed — remove from START to end of file
    const before = content.slice(0, startIdx).trimEnd();
    if (before === '' || before === '#!/bin/sh') {
      await unlink(hookPath);
      return;
    }
    await writeFile(hookPath, before + '\n', 'utf-8');
    return;
  }

  const before = content.slice(0, startIdx).trimEnd();
  const after = content.slice(endIdx + HOOK_END.length).trimStart();

  const remaining = (before + '\n' + after).trim();

  if (remaining === '' || remaining === '#!/bin/sh') {
    // Only VibeLint content was present — delete the file
    await unlink(hookPath);
  } else {
    await writeFile(hookPath, remaining + '\n', 'utf-8');
    await chmod(hookPath, 0o755);
  }
}

export async function isHookInstalled(repoPath: string): Promise<boolean> {
  const hookPath = path.join(repoPath, '.git', 'hooks', 'pre-commit');

  try {
    const content = await readFile(hookPath, 'utf-8');
    return content.includes(HOOK_START);
  } catch {
    return false;
  }
}
```

**Step 2: Create the hooks API routes**

```typescript
// src/server/api/hooks.ts

import { FastifyInstance } from 'fastify';
import { installPreCommitHook, removePreCommitHook, isHookInstalled } from '../hooks/precommit.js';
import { notFound } from '../utils/errors.js';

export async function hookRoutes(server: FastifyInstance) {
  // Install pre-commit hook
  server.post('/api/repos/:repoId/hooks/install', async (request, reply) => {
    const { repoId } = request.params as { repoId: string };

    const repo = db.getRepo(repoId);
    if (!repo) {
      throw notFound('Repository', repoId);
    }

    await installPreCommitHook(repo.path, repoId);

    return reply.send({
      success: true,
      message: `Pre-commit hook installed in ${repo.name}`,
    });
  });

  // Remove pre-commit hook
  server.delete('/api/repos/:repoId/hooks/install', async (request, reply) => {
    const { repoId } = request.params as { repoId: string };

    const repo = db.getRepo(repoId);
    if (!repo) {
      throw notFound('Repository', repoId);
    }

    await removePreCommitHook(repo.path);

    return reply.send({
      success: true,
      message: `Pre-commit hook removed from ${repo.name}`,
    });
  });

  // Check hook status
  server.get('/api/repos/:repoId/hooks/status', async (request, reply) => {
    const { repoId } = request.params as { repoId: string };

    const repo = db.getRepo(repoId);
    if (!repo) {
      throw notFound('Repository', repoId);
    }

    const installed = await isHookInstalled(repo.path);

    return reply.send({ installed });
  });
}
```

**Step 3: Register hook routes in the server**

```typescript
// src/server/index.ts — add with other route registrations

import { hookRoutes } from './api/hooks.js';

// After other route registrations:
await server.register(hookRoutes);
```

**Step 4: Add a health endpoint for the hook to check if server is running**

```typescript
// src/server/index.ts or src/server/api/health.ts

server.get('/api/health', async (request, reply) => {
  return reply.send({ status: 'ok', timestamp: new Date().toISOString() });
});
```

### 3.3 API Contract

**Install Pre-Commit Hook:**
```
POST /api/repos/:repoId/hooks/install

Response (200):
{
  "success": true,
  "message": "Pre-commit hook installed in my-app"
}
```

**Remove Pre-Commit Hook:**
```
DELETE /api/repos/:repoId/hooks/install

Response (200):
{
  "success": true,
  "message": "Pre-commit hook removed from my-app"
}
```

**Check Hook Status:**
```
GET /api/repos/:repoId/hooks/status

Response (200):
{
  "installed": true
}
```

**Health Check (used by hook script):**
```
GET /api/health

Response (200):
{
  "status": "ok",
  "timestamp": "2026-02-23T14:30:00.000Z"
}
```

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/hooks/precommit.ts` exists with `installPreCommitHook`, `removePreCommitHook`, and `isHookInstalled`.
- [ ] Installing the hook creates an executable `.git/hooks/pre-commit` file with the VibeLint section.
- [ ] Existing pre-commit hooks are preserved when VibeLint section is appended.
- [ ] Removing the hook cleanly excises only the VibeLint section.
- [ ] The hook script calls VibeLint's analyze endpoint and blocks commits on FAIL.
- [ ] The hook gracefully skips if VibeLint server is not running.
- [ ] `POST /api/repos/:repoId/hooks/install` installs the hook.
- [ ] `DELETE /api/repos/:repoId/hooks/install` removes the hook.
- [ ] `GET /api/repos/:repoId/hooks/status` returns correct installation status.
- [ ] `GET /api/health` returns 200 for hook connectivity checks.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
