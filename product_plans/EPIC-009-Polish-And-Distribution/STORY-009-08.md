---
id: STORY-009-08
parent_epic: EPIC-009
status: Draft
actor: Backend Developer
complexity: High (4+ files)
---
# STORY-009-08: Cross-Platform Compatibility

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** all file path operations, shell command executions, home directory references, and text parsing to work correctly on macOS, Linux, and Windows,
**So that** `npm install -g vibelint && vibelint` works reliably on all major operating systems without path errors, command failures, or line ending issues.

### 1.2 Detailed Requirements
- **Requirement 1**: Audit all file path operations across the codebase. Replace any string concatenation for paths (e.g., `dir + '/' + file`) with `path.join()` or `path.resolve()`. This includes all files in `src/server/`, `bin/`, and any utility modules.
- **Requirement 2**: Audit all shell command execution (`child_process.exec`, `execFile`, `execSync`). Handle Windows command differences — either use the `cross-spawn` package for cross-platform child process spawning, or conditionally construct commands based on `process.platform`.
- **Requirement 3**: Replace all uses of `~` for home directory with `os.homedir()`. The VibeLint data directory `~/.vibelint/` must resolve correctly on Windows as `%USERPROFILE%\.vibelint\` and on Unix as `$HOME/.vibelint/`.
- **Requirement 4**: Handle Windows line endings (`\r\n`) in git output parsing. All git command output parsers (branch lists, diffs, file lists) must strip `\r` before processing lines.
- **Requirement 5**: Handle spaces in file paths. All paths passed to shell commands must be quoted. When constructing command arguments, use proper quoting or pass arguments as arrays to `execFile` (which handles quoting automatically).
- **Requirement 6**: Use `os.homedir()` instead of environment variable lookups for the home directory. Do not rely on `$HOME` (undefined on some Windows configurations).
- **Requirement 7**: Add `cross-spawn` as a dependency if needed for Windows-compatible `child_process.spawn`/`execFile`. The `cross-spawn` package correctly handles `.cmd`/`.bat` extensions on Windows and path resolution for executables.
- **Requirement 8**: Ensure the `.vibelint/` data directory creation works on all platforms. Use `fs.mkdir` with `{ recursive: true }` and `path.join(os.homedir(), '.vibelint')`.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Cross-Platform Compatibility

  Scenario: File paths use path.join everywhere
    Given the codebase is audited
    When I search for string path concatenation patterns
    Then no instances of "dir + '/' + file" or template literal path joining exist
    And all path construction uses path.join() or path.resolve()

  Scenario: Home directory resolved correctly on all platforms
    Given VibeLint is running on Windows
    When the data directory is resolved
    Then it uses os.homedir() (e.g., C:\Users\dev\.vibelint)
    And no ~ character appears in resolved paths

  Scenario: Git output with Windows line endings is parsed correctly
    Given a git branch list command returns lines with \r\n endings
    When the output is parsed
    Then the branch names do not contain \r characters
    And all branches are correctly listed

  Scenario: Paths with spaces work in shell commands
    Given a repository at "/Users/dev/My Projects/my-app"
    When VibeLint runs git commands against this repo
    Then the commands execute successfully
    And no "file not found" errors occur due to unquoted paths

  Scenario: Shell commands work on Windows
    Given VibeLint is running on Windows
    When a git command is executed via child_process
    Then the command resolves git.exe correctly
    And the command completes without "ENOENT" errors

  Scenario: Data directory creation on Windows
    Given VibeLint is starting for the first time on Windows
    When the data directory is created
    Then %USERPROFILE%\.vibelint\ is created successfully
    And vibelint.db is created inside it

  Scenario: cross-spawn handles Windows executables
    Given VibeLint needs to run "git" on Windows
    When using cross-spawn instead of child_process.execFile
    Then "git.cmd" or "git.exe" is correctly resolved
    And the command executes without errors
```

### 2.2 Verification Steps
- [ ] No string path concatenation (` + '/' + ` or `` `${dir}/${file}` ``) exists in the codebase.
- [ ] All `os.homedir()` calls replace any `~` expansion or `$HOME` lookups.
- [ ] Git output parsing strips `\r` from all line-based parsing.
- [ ] All paths in shell commands are properly quoted or passed as array arguments.
- [ ] `cross-spawn` is added as a dependency (if chosen).
- [ ] Data directory creation uses `path.join(os.homedir(), '.vibelint')`.
- [ ] The pre-commit hook script (STORY-009-05) works on both Unix and Windows shells.
- [ ] No TypeScript compilation errors.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files** (audit all of these):
  - `src/server/git/scanner.ts` (file path operations, git commands)
  - `src/server/git/diff.ts` (git commands, output parsing)
  - `src/server/git/history.ts` (git commands, output parsing)
  - `src/server/analyzer/engine.ts` (file paths)
  - `src/server/analyzer/complexity.ts` (shell commands for lizard)
  - `src/server/analyzer/duplication.ts` (shell commands for jscpd)
  - `src/server/injector/index.ts` (file write paths)
  - `src/server/injector/platforms/*.ts` (file write paths)
  - `src/server/vdoc/monitor.ts` (file paths)
  - `src/server/db/schema.ts` (database path)
  - `src/server/utils/exec.ts` (shell command execution)
  - `src/server/hooks/precommit.ts` (file paths, shell script)
  - `bin/vibelint.ts` (startup, data dir creation)
- **Related Files**:
  - `package.json` (add `cross-spawn` dependency)
- **New Files Needed**: None (this is an audit and modification story)

### 3.2 Technical Logic

**Step 1: Create a cross-platform path utility**

```typescript
// src/server/utils/paths.ts (create)

import os from 'node:os';
import path from 'node:path';
import { mkdir } from 'node:fs/promises';

/**
 * Get the VibeLint data directory, cross-platform.
 * On macOS/Linux: /Users/dev/.vibelint or /home/dev/.vibelint
 * On Windows: C:\Users\dev\.vibelint
 */
export function getDataDir(): string {
  return path.join(os.homedir(), '.vibelint');
}

/**
 * Get the SQLite database path.
 */
export function getDbPath(): string {
  return path.join(getDataDir(), 'vibelint.db');
}

/**
 * Ensure the data directory exists.
 */
export async function ensureDataDir(): Promise<string> {
  const dataDir = getDataDir();
  await mkdir(dataDir, { recursive: true });
  return dataDir;
}

/**
 * Normalize a file path for the current platform.
 * Resolves ~, normalizes separators, resolves relative paths.
 */
export function normalizePath(inputPath: string): string {
  // Replace ~ with home directory
  if (inputPath.startsWith('~')) {
    inputPath = path.join(os.homedir(), inputPath.slice(1));
  }

  // Resolve to absolute path and normalize separators
  return path.resolve(inputPath);
}
```

**Step 2: Add cross-spawn dependency**

```bash
npm install cross-spawn
npm install -D @types/cross-spawn
```

**Step 3: Update the exec utility to use cross-spawn**

```typescript
// src/server/utils/exec.ts — replace execFile with cross-spawn

import spawn from 'cross-spawn';
import type { SpawnOptions } from 'node:child_process';

export interface ExecOptions {
  cwd?: string;
  timeoutMs?: number;
}

export function execWithTimeout(
  command: string,
  args: string[],
  options: ExecOptions = {}
): Promise<string> {
  const { cwd, timeoutMs = 30_000 } = options;

  return new Promise((resolve, reject) => {
    let stdout = '';
    let stderr = '';

    const child = spawn(command, args, {
      cwd,
      stdio: ['ignore', 'pipe', 'pipe'],
    } as SpawnOptions);

    if (!child.stdout || !child.stderr) {
      reject(new Error(`Failed to spawn '${command}'`));
      return;
    }

    child.stdout.on('data', (data: Buffer) => {
      stdout += data.toString();
    });

    child.stderr.on('data', (data: Buffer) => {
      stderr += data.toString();
    });

    const timer = setTimeout(() => {
      child.kill('SIGTERM');
      reject(new Error(`Command '${command}' timed out after ${timeoutMs}ms`));
    }, timeoutMs);

    child.on('error', (error: Error) => {
      clearTimeout(timer);
      reject(error);
    });

    child.on('close', (code: number | null) => {
      clearTimeout(timer);
      if (code === 0) {
        resolve(stdout);
      } else {
        reject(
          new Error(`Command '${command} ${args.join(' ')}' exited with code ${code}: ${stderr}`)
        );
      }
    });
  });
}
```

**Step 4: Fix git output parsing to handle Windows line endings**

```typescript
// src/server/git/scanner.ts — add \r stripping to all line parsing

/**
 * Normalize git command output: strip \r (Windows line endings) and split into lines.
 */
function parseGitLines(output: string): string[] {
  return output
    .replace(/\r/g, '')  // Strip Windows \r
    .trim()
    .split('\n')
    .filter(Boolean);
}

// Apply to branch listing:
export async function listBranches(repoPath: string): Promise<string[]> {
  const output = await execWithTimeout(
    'git',
    ['branch', '--list', '--format=%(refname:short)'],
    { cwd: repoPath, timeoutMs: 10_000 }
  );
  return parseGitLines(output);
}

// Apply to file listing:
export async function listTrackedFiles(repoPath: string): Promise<string[]> {
  const output = await execWithTimeout(
    'git',
    ['ls-files'],
    { cwd: repoPath, timeoutMs: 10_000 }
  );
  return parseGitLines(output);
}
```

```typescript
// src/server/git/diff.ts — same treatment for diff parsing

function parseGitLines(output: string): string[] {
  return output
    .replace(/\r/g, '')
    .trim()
    .split('\n')
    .filter(Boolean);
}

export async function getDiffFiles(
  repoPath: string,
  baseBranch: string,
  targetBranch: string
): Promise<{ files: string[]; additions: number; deletions: number }> {
  // Get changed file names
  const nameOutput = await execWithTimeout(
    'git',
    ['diff', '--name-only', `${baseBranch}...${targetBranch}`],
    { cwd: repoPath, timeoutMs: 30_000 }
  );
  const files = parseGitLines(nameOutput);

  // Get stats
  const statOutput = await execWithTimeout(
    'git',
    ['diff', '--shortstat', `${baseBranch}...${targetBranch}`],
    { cwd: repoPath, timeoutMs: 30_000 }
  );
  const statLine = statOutput.replace(/\r/g, '').trim();

  let additions = 0;
  let deletions = 0;
  const addMatch = statLine.match(/(\d+) insertions?/);
  const delMatch = statLine.match(/(\d+) deletions?/);
  if (addMatch) additions = parseInt(addMatch[1], 10);
  if (delMatch) deletions = parseInt(delMatch[1], 10);

  return { files, additions, deletions };
}
```

**Step 5: Audit and fix path concatenation across the codebase**

Search for these patterns and replace them:

```typescript
// WRONG — string concatenation
const configPath = repoPath + '/.vibelint/config.yml';
const reportPath = `${repoPath}/.vibelint/reports/latest.md`;

// CORRECT — path.join
const configPath = path.join(repoPath, '.vibelint', 'config.yml');
const reportPath = path.join(repoPath, '.vibelint', 'reports', 'latest.md');
```

Specific files to audit:

```typescript
// src/server/injector/index.ts
// WRONG:
const targetDir = repoPath + '/.vibelint/skills/';
// CORRECT:
const targetDir = path.join(repoPath, '.vibelint', 'skills');

// src/server/injector/platforms/claude-code.ts
// WRONG:
const claudeMdPath = `${repoPath}/CLAUDE.md`;
const commandsDir = `${repoPath}/.claude/commands/`;
// CORRECT:
const claudeMdPath = path.join(repoPath, 'CLAUDE.md');
const commandsDir = path.join(repoPath, '.claude', 'commands');

// src/server/db/schema.ts
// WRONG:
const dbPath = os.homedir() + '/.vibelint/vibelint.db';
// CORRECT:
import { getDbPath } from '../utils/paths.js';
const dbPath = getDbPath();

// bin/vibelint.ts
// WRONG:
const dataDir = process.env.HOME + '/.vibelint';
// CORRECT:
import { ensureDataDir } from '../src/server/utils/paths.js';
const dataDir = await ensureDataDir();
```

**Step 6: Ensure shell commands use array arguments (not string commands)**

```typescript
// WRONG — string command (breaks with spaces in paths)
exec(`git -C ${repoPath} log --oneline`);

// CORRECT — array arguments (cross-spawn handles quoting)
execWithTimeout('git', ['-C', repoPath, 'log', '--oneline']);
```

For the analyzer tools (lizard, jscpd), use array arguments:

```typescript
// src/server/analyzer/complexity.ts
// WRONG:
exec(`lizard "${filePath}" --CCN`);

// CORRECT:
execWithTimeout('lizard', [filePath, '--CCN'], { cwd: repoPath });

// src/server/analyzer/duplication.ts
// WRONG:
exec(`npx jscpd "${repoPath}" --format json`);

// CORRECT:
execWithTimeout('npx', ['jscpd', repoPath, '--format', 'json'], { cwd: repoPath });
```

**Step 7: Handle the pre-commit hook for Windows**

The shell script from STORY-009-05 uses bash syntax (`#!/bin/sh`). On Windows with Git Bash, this works. However, add a note for Windows users who use PowerShell:

```typescript
// src/server/hooks/precommit.ts — Windows consideration

function generateHookScript(repoId: string): string {
  // Git hooks on Windows run in Git Bash (MINGW), so sh syntax works.
  // No need for a separate .ps1 script — Git always uses sh for hooks.
  return `
${HOOK_START}
# VibeLint pre-commit hook
# Works on macOS, Linux, and Windows (Git Bash)

vibelint_check() {
  # ... same script as STORY-009-05 ...
}

vibelint_check
VIBELINT_EXIT=$?
if [ $VIBELINT_EXIT -ne 0 ]; then
  exit $VIBELINT_EXIT
fi
${HOOK_END}
`.trim();
}
```

**Step 8: Extract parseGitLines into a shared utility**

Since multiple git modules need the same line parsing, create a shared utility:

```typescript
// src/server/git/utils.ts (create)

/**
 * Parse git command output into clean lines.
 * Handles Windows \r\n line endings.
 */
export function parseGitLines(output: string): string[] {
  return output
    .replace(/\r/g, '')
    .trim()
    .split('\n')
    .filter(Boolean);
}

/**
 * Parse git shortstat output into { additions, deletions } counts.
 */
export function parseGitStats(statOutput: string): { additions: number; deletions: number } {
  const line = statOutput.replace(/\r/g, '').trim();
  let additions = 0;
  let deletions = 0;
  const addMatch = line.match(/(\d+) insertions?/);
  const delMatch = line.match(/(\d+) deletions?/);
  if (addMatch) additions = parseInt(addMatch[1], 10);
  if (delMatch) deletions = parseInt(delMatch[1], 10);
  return { additions, deletions };
}
```

### 3.3 API Contract
N/A — this story modifies internal behavior only. No API changes.

---

## 4. Definition of Done (The Gate)
- [ ] No string path concatenation exists in the codebase — all paths use `path.join()` or `path.resolve()`.
- [ ] `os.homedir()` is used everywhere instead of `~` expansion or `$HOME`/`%USERPROFILE%` env vars.
- [ ] `src/server/utils/paths.ts` exists with `getDataDir()`, `getDbPath()`, `ensureDataDir()`, `normalizePath()`.
- [ ] `cross-spawn` is installed and used in `src/server/utils/exec.ts`.
- [ ] All git output parsing strips `\r` characters before processing lines.
- [ ] `src/server/git/utils.ts` exports shared `parseGitLines()` and `parseGitStats()`.
- [ ] All shell commands pass arguments as arrays (not string concatenation).
- [ ] Paths with spaces are handled correctly in all command executions.
- [ ] The data directory `~/.vibelint/` is created correctly on macOS, Linux, and Windows.
- [ ] The pre-commit hook script works in Git Bash on Windows.
- [ ] `npm run build` succeeds on all platforms.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
