---
id: STORY-009-03
parent_epic: EPIC-009
status: Draft
actor: Full-Stack Developer
complexity: Medium (2-3 files)
---
# STORY-009-03: Full Codebase Scan Mode

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Full-Stack Developer,
**I want** an analysis mode that scans the entire repository's source files regardless of the current git diff,
**So that** users can run a comprehensive health check on their full codebase for initial onboarding or periodic audits, instead of only analyzing files changed on a branch.

### 1.2 Detailed Requirements
- **Requirement 1**: Extend the analyzer engine to support two modes: `"branch"` (existing behavior — analyze only files changed in the branch diff vs base) and `"full"` (new — analyze all source files in the repo, respecting skip directories and binary file filters).
- **Requirement 2**: Modify `POST /api/repos/:repoId/analyze` to accept an optional query parameter `mode=full|branch` (default: `"branch"`). When `mode=full`, pass all source files to the analysis pipeline instead of only diff files.
- **Requirement 3**: Store the scan mode in the `analyses` table — add a `scan_mode` column (TEXT, default `"branch"`) so that results can be displayed with context.
- **Requirement 4**: Full mode is useful for: first-time analysis of a newly connected repo, periodic health checks, and baseline snapshots for trends.
- **Requirement 5**: Update the Analysis View UI to display which scan mode was used (a badge or label: "Branch Scan" or "Full Scan").
- **Requirement 6**: Add a "Full Scan" button on the Analysis View page alongside the existing "Run Analysis" button. The existing button keeps running branch mode; the new button triggers full mode.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Full Codebase Scan Mode

  Scenario: Full scan analyzes all source files
    Given a repository with 200 source files
    And 10 files changed on the current branch vs main
    When I call POST /api/repos/:repoId/analyze?mode=full
    Then the analyzer processes all 200 source files
    And the analysis result includes metrics for the full codebase

  Scenario: Branch scan only analyzes diff files (default)
    Given a repository with 200 source files
    And 10 files changed on the current branch vs main
    When I call POST /api/repos/:repoId/analyze (no mode param)
    Then the analyzer processes only the 10 changed files
    And the analysis result covers only the branch diff

  Scenario: Scan mode is stored in the database
    Given a full scan analysis was completed
    When I query the analyses table for that analysis
    Then the scan_mode column is "full"

  Scenario: Analysis View shows scan mode badge
    Given a completed full scan analysis
    When the user views the Analysis View page
    Then a "Full Scan" badge is displayed near the analysis header

  Scenario: Full Scan button triggers full mode
    Given the user is on the Analysis View page
    When the user clicks the "Full Scan" button
    Then a POST request is sent to /api/repos/:repoId/analyze?mode=full
    And the analysis runs against all source files

  Scenario: Run Analysis button triggers branch mode
    Given the user is on the Analysis View page
    When the user clicks the "Run Analysis" button
    Then a POST request is sent to /api/repos/:repoId/analyze (no mode param)
    And the analysis runs against branch diff files only
```

### 2.2 Verification Steps
- [ ] `POST /api/repos/:repoId/analyze?mode=full` triggers a full repo scan.
- [ ] `POST /api/repos/:repoId/analyze` (default) triggers a branch diff scan.
- [ ] Full mode passes all source files (respecting skip dirs and binary filters) to the analyzer.
- [ ] The `analyses` table has a `scan_mode` column storing `"branch"` or `"full"`.
- [ ] The Analysis View UI displays a scan mode badge.
- [ ] A "Full Scan" button exists alongside "Run Analysis".
- [ ] No TypeScript compilation errors.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**:
  - `src/server/analyzer/engine.ts` (modify — add full mode support)
  - `src/server/api/analysis.ts` (modify — accept `mode` query param)
  - `src/server/db/schema.ts` (modify — add `scan_mode` column to analyses)
  - `src/client/pages/AnalysisView.tsx` (modify — add badge + Full Scan button)
- **Related Files**:
  - `src/server/git/scanner.ts` (reuse `scanRepoFiles` for full mode)
  - `src/server/git/diff.ts` (existing branch diff logic)
  - `src/server/db/queries.ts` (update insert/select for analyses)
  - `src/client/lib/api.ts` (add `mode` param to analysis API call)
- **New Files Needed**: None

### 3.2 Technical Logic

**Step 1: Add `scan_mode` column to analyses table**

```typescript
// src/server/db/schema.ts — modify the analyses table creation

// Add migration or modify CREATE TABLE:
// If table already exists, run ALTER TABLE:
db.exec(`
  ALTER TABLE analyses ADD COLUMN scan_mode TEXT DEFAULT 'branch';
`);

// Or if creating fresh:
db.exec(`
  CREATE TABLE IF NOT EXISTS analyses (
    id INTEGER PRIMARY KEY,
    repo_id TEXT REFERENCES repos(id),
    branch TEXT,
    base_branch TEXT,
    scan_mode TEXT DEFAULT 'branch',
    diff_stats TEXT,
    analysis_data TEXT,
    created_at TEXT
  );
`);
```

**Step 2: Extend the analyzer engine to support full mode**

```typescript
// src/server/analyzer/engine.ts

import { scanRepoFiles } from '../git/scanner.js';
import { getDiffFiles } from '../git/diff.js';

export type ScanMode = 'branch' | 'full';

export interface AnalysisOptions {
  repoPath: string;
  repoId: string;
  branch?: string;
  baseBranch?: string;
  mode: ScanMode;
}

export async function runAnalysis(options: AnalysisOptions) {
  const { repoPath, mode, branch, baseBranch } = options;

  let targetFiles: string[];
  let diffStats: any = null;

  if (mode === 'full') {
    // Full mode: scan all source files in the repository
    const scanResult = await scanRepoFiles(repoPath);
    targetFiles = scanResult.files;
    diffStats = {
      mode: 'full',
      totalFiles: targetFiles.length,
      truncated: scanResult.truncated,
    };
  } else {
    // Branch mode: only analyze files changed vs base branch
    const diff = await getDiffFiles(repoPath, baseBranch || 'main', branch || 'HEAD');
    targetFiles = diff.files.map((f) => path.join(repoPath, f));
    diffStats = {
      mode: 'branch',
      branch,
      baseBranch: baseBranch || 'main',
      filesChanged: targetFiles.length,
      additions: diff.additions,
      deletions: diff.deletions,
    };
  }

  // Run all checks against targetFiles
  const checks = [
    { name: 'complexity', fn: () => runComplexityCheck(targetFiles, options) },
    { name: 'duplication', fn: () => runDuplicationCheck(targetFiles, options) },
    { name: 'error-patterns', fn: () => runErrorPatternCheck(targetFiles, options) },
    { name: 'file-size', fn: () => runFileSizeCheck(targetFiles, options) },
    { name: 'coupling', fn: () => runCouplingCheck(targetFiles, options) },
    { name: 'dependencies', fn: () => runDependencyCheck(repoPath, options) },
  ];

  const results = await Promise.all(
    checks.map(({ name, fn }) => runCheckWithTimeout(name, fn))
  );

  return {
    scanMode: mode,
    diffStats,
    checks: results,
    timestamp: new Date().toISOString(),
  };
}
```

**Step 3: Modify the analysis API endpoint**

```typescript
// src/server/api/analysis.ts

import { ScanMode } from '../analyzer/engine.js';
import { badRequest, notFound } from '../utils/errors.js';

server.post('/api/repos/:repoId/analyze', async (request, reply) => {
  const { repoId } = request.params as { repoId: string };
  const { mode } = request.query as { mode?: string };

  // Validate mode parameter
  const scanMode: ScanMode = mode === 'full' ? 'full' : 'branch';

  const repo = db.getRepo(repoId);
  if (!repo) {
    throw notFound('Repository', repoId);
  }

  const result = await runAnalysis({
    repoPath: repo.path,
    repoId,
    branch: repo.currentBranch,
    baseBranch: 'main',
    mode: scanMode,
  });

  // Store in database with scan_mode
  const analysisId = db.insertAnalysis({
    repo_id: repoId,
    branch: repo.currentBranch,
    base_branch: 'main',
    scan_mode: scanMode,
    diff_stats: JSON.stringify(result.diffStats),
    analysis_data: JSON.stringify(result),
    created_at: result.timestamp,
  });

  return reply.send({ id: analysisId, ...result });
});
```

**Step 4: Update queries to include scan_mode**

```typescript
// src/server/db/queries.ts

interface InsertAnalysisParams {
  repo_id: string;
  branch: string;
  base_branch: string;
  scan_mode: string;
  diff_stats: string;
  analysis_data: string;
  created_at: string;
}

export function insertAnalysis(params: InsertAnalysisParams): number {
  const stmt = db.prepare(`
    INSERT INTO analyses (repo_id, branch, base_branch, scan_mode, diff_stats, analysis_data, created_at)
    VALUES (?, ?, ?, ?, ?, ?, ?)
  `);
  const result = stmt.run(
    params.repo_id,
    params.branch,
    params.base_branch,
    params.scan_mode,
    params.diff_stats,
    params.analysis_data,
    params.created_at
  );
  return result.lastInsertRowid as number;
}

export function getAnalysis(id: number) {
  const stmt = db.prepare('SELECT * FROM analyses WHERE id = ?');
  return stmt.get(id);
}
```

**Step 5: Update the frontend API client**

```typescript
// src/client/lib/api.ts — add mode param to analyze function

export async function triggerAnalysis(
  repoId: string,
  mode: 'branch' | 'full' = 'branch'
): Promise<any> {
  const url = mode === 'full'
    ? `/api/repos/${repoId}/analyze?mode=full`
    : `/api/repos/${repoId}/analyze`;
  return apiFetch(url, { method: 'POST' });
}
```

**Step 6: Update Analysis View UI**

```tsx
// src/client/pages/AnalysisView.tsx — add scan mode badge and Full Scan button

import { triggerAnalysis } from '../lib/api';

function AnalysisView() {
  const { repoId } = useParams<{ repoId: string }>();
  const [analysis, setAnalysis] = useState<any>(null);
  const [isRunning, setIsRunning] = useState(false);

  async function handleRunAnalysis(mode: 'branch' | 'full') {
    if (!repoId) return;
    setIsRunning(true);
    try {
      const result = await triggerAnalysis(repoId, mode);
      setAnalysis(result);
    } finally {
      setIsRunning(false);
    }
  }

  return (
    <div>
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <h1 className="text-2xl font-bold">Analysis</h1>
          {analysis?.scanMode && (
            <span
              className={`px-2 py-1 text-xs font-medium rounded-full ${
                analysis.scanMode === 'full'
                  ? 'bg-purple-100 text-purple-700'
                  : 'bg-blue-100 text-blue-700'
              }`}
            >
              {analysis.scanMode === 'full' ? 'Full Scan' : 'Branch Scan'}
            </span>
          )}
        </div>

        <div className="flex gap-2">
          <button
            onClick={() => handleRunAnalysis('branch')}
            disabled={isRunning}
            className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50"
          >
            {isRunning ? 'Running...' : 'Run Analysis'}
          </button>
          <button
            onClick={() => handleRunAnalysis('full')}
            disabled={isRunning}
            className="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50"
          >
            {isRunning ? 'Running...' : 'Full Scan'}
          </button>
        </div>
      </div>

      {/* Rest of analysis results display */}
    </div>
  );
}
```

### 3.3 API Contract

**Modified Endpoint:**

```
POST /api/repos/:repoId/analyze?mode=branch|full
```

| Param | Type | Default | Description |
|-------|------|---------|-------------|
| `mode` | query string | `"branch"` | `"branch"` = analyze only files changed vs base branch. `"full"` = analyze all source files. |

**Response (200):**
```json
{
  "id": 42,
  "scanMode": "full",
  "diffStats": {
    "mode": "full",
    "totalFiles": 487,
    "truncated": false
  },
  "checks": [
    { "check": "complexity", "status": "WARN", "details": {...}, "durationMs": 1234 },
    ...
  ],
  "timestamp": "2026-02-23T14:30:00.000Z"
}
```

---

## 4. Definition of Done (The Gate)
- [ ] `POST /api/repos/:repoId/analyze?mode=full` runs analysis against all source files in the repo.
- [ ] `POST /api/repos/:repoId/analyze` (no param) defaults to branch diff mode.
- [ ] Full mode respects skip directories and binary file filters from STORY-009-02.
- [ ] The `analyses` table has a `scan_mode` column, populated on insert.
- [ ] Analysis View displays a "Full Scan" or "Branch Scan" badge.
- [ ] A "Full Scan" button exists on Analysis View alongside "Run Analysis".
- [ ] The frontend correctly passes `mode=full` query parameter when clicking "Full Scan".
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
