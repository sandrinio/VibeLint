---
id: STORY-009-07
parent_epic: EPIC-009
status: Draft
actor: Full-Stack Developer
complexity: Medium (2-3 files)
---
# STORY-009-07: npm Publish Setup

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Full-Stack Developer,
**I want** the package.json, bin entry, file list, build scripts, and .npmignore configured so that `npm pack` produces a clean installable tarball and `npm install -g vibelint` works out of the box,
**So that** VibeLint can be distributed via npm and users can install it with a single command.

### 1.2 Detailed Requirements
- **Requirement 1**: Update `package.json` fields: `name: "vibelint"`, `version: "0.1.0"`, `description: "Local web app for preparing AI coding context files"`, `keywords: ["ai", "coding", "linting", "code-quality", "context", "claude", "cursor"]`, `license: "MIT"`, `author: "VibeLint"`, `repository: { type: "git", url: "https://github.com/vibelint/vibelint" }`, `homepage: "https://github.com/vibelint/vibelint"`.
- **Requirement 2**: Add `"bin": { "vibelint": "./bin/vibelint.js" }` — this must point to the compiled JavaScript (not TypeScript). The `bin/vibelint.js` file is produced by the build step from `bin/vibelint.ts`.
- **Requirement 3**: Add `"files"` array: `["bin/", "dist/", "templates/"]`. This controls what gets included in the npm tarball. Only ship compiled output + templates.
- **Requirement 4**: Update/add scripts: `"build": "tsc && vite build"`, `"prepublishOnly": "npm run build"`, `"start": "node bin/vibelint.js"`.
- **Requirement 5**: Add `"engines": { "node": ">=18" }` to declare minimum Node.js version.
- **Requirement 6**: Create `.npmignore` to explicitly exclude: `src/`, `tests/`, `.github/`, `tsconfig.json`, `vite.config.ts`, `tailwind.config.js`, `.eslintrc.*`, `*.map`, `data/`, `.env`, `.DS_Store`, `product_plans/`.
- **Requirement 7**: Ensure the compiled `bin/vibelint.js` starts with `#!/usr/bin/env node` shebang line so it's executable as a CLI command.
- **Requirement 8**: Verify by running `npm pack` and inspecting the tarball contents. Then test with `npm install -g ./vibelint-0.1.0.tgz` and confirm `vibelint` command works.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: npm Publish Setup

  Scenario: package.json has all required fields
    Given the project root contains a package.json
    When I read the package.json
    Then the "name" field is "vibelint"
    And the "version" field is "0.1.0"
    And the "description" field is set
    And the "license" field is "MIT"
    And the "bin.vibelint" field is "./bin/vibelint.js"
    And the "engines.node" field is ">=18"
    And the "files" array includes "bin/", "dist/", "templates/"

  Scenario: Build produces compiled output
    Given the project has TypeScript source files
    When I run "npm run build"
    Then dist/ directory is populated with compiled JavaScript
    And bin/vibelint.js exists
    And bin/vibelint.js starts with "#!/usr/bin/env node"

  Scenario: npm pack produces clean tarball
    Given the build has completed
    When I run "npm pack"
    Then a vibelint-0.1.0.tgz file is created
    And the tarball contains bin/, dist/, and templates/ directories
    And the tarball does NOT contain src/, tests/, or .github/

  Scenario: Global install works
    Given the tarball vibelint-0.1.0.tgz exists
    When I run "npm install -g ./vibelint-0.1.0.tgz"
    Then the install succeeds
    And "vibelint" command is available in PATH
    And running "vibelint --version" outputs "0.1.0"

  Scenario: .npmignore excludes development files
    Given .npmignore exists
    When I run "npm pack --dry-run"
    Then the output does NOT include src/ files
    And the output does NOT include tests/ files
    And the output does NOT include tsconfig.json
    And the output does NOT include vite.config.ts

  Scenario: prepublishOnly runs build
    Given a clean project (no dist/ directory)
    When npm's publish lifecycle runs
    Then "npm run build" is executed automatically
    And dist/ is populated before the tarball is created
```

### 2.2 Verification Steps
- [ ] `package.json` contains all required metadata fields.
- [ ] `"bin"` points to `./bin/vibelint.js` (compiled JS, not TS).
- [ ] `"files"` includes only `bin/`, `dist/`, `templates/`.
- [ ] `"engines"` specifies `node >= 18`.
- [ ] `"build"` script runs `tsc && vite build`.
- [ ] `"prepublishOnly"` script runs `npm run build`.
- [ ] `.npmignore` excludes `src/`, `tests/`, `.github/`, config files.
- [ ] `npm run build` succeeds and populates `dist/`.
- [ ] `bin/vibelint.js` has shebang `#!/usr/bin/env node`.
- [ ] `npm pack` produces a tarball with correct contents.
- [ ] `npm install -g ./vibelint-0.1.0.tgz` makes `vibelint` command available.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**:
  - `package.json` (modify)
  - `.npmignore` (create)
  - `bin/vibelint.ts` (modify — ensure shebang is preserved in compilation)
- **Related Files**:
  - `tsconfig.json` (verify `outDir` and `rootDir` settings produce correct output structure)
  - `vite.config.ts` (verify build output goes to `dist/`)
- **New Files Needed**:
  - `.npmignore`

### 3.2 Technical Logic

**Step 1: Update package.json**

```json
{
  "name": "vibelint",
  "version": "0.1.0",
  "description": "Local web app for preparing AI coding context files",
  "type": "module",
  "main": "dist/server/index.js",
  "bin": {
    "vibelint": "./bin/vibelint.js"
  },
  "files": [
    "bin/",
    "dist/",
    "templates/"
  ],
  "scripts": {
    "dev": "tsx watch bin/vibelint.ts",
    "dev:client": "vite",
    "build": "tsc && vite build",
    "start": "node bin/vibelint.js",
    "prepublishOnly": "npm run build",
    "lint": "tsc --noEmit"
  },
  "keywords": [
    "ai",
    "coding",
    "linting",
    "code-quality",
    "context",
    "claude",
    "cursor",
    "vibelint",
    "developer-tools"
  ],
  "license": "MIT",
  "author": "VibeLint",
  "repository": {
    "type": "git",
    "url": "https://github.com/vibelint/vibelint"
  },
  "homepage": "https://github.com/vibelint/vibelint",
  "engines": {
    "node": ">=18"
  },
  "dependencies": {
    "better-sqlite3": "^11.7.0",
    "fastify": "^5.2.0",
    "open": "^10.1.0",
    "yaml": "^2.7.0"
  },
  "devDependencies": {
    "@types/better-sqlite3": "^7.6.12",
    "@types/node": "^22.12.0",
    "tsx": "^4.19.0",
    "typescript": "^5.7.0",
    "vite": "^6.0.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "@vitejs/plugin-react": "^4.3.0",
    "tailwindcss": "^4.0.0"
  }
}
```

**Step 2: Ensure bin/vibelint.ts has a shebang**

The TypeScript source file should have the shebang as a comment that `tsc` preserves (or handle it post-build):

```typescript
// bin/vibelint.ts
#!/usr/bin/env node

// Note: TypeScript does not natively preserve shebangs.
// The shebang must be added post-compilation.
```

Since `tsc` strips shebangs, add a post-build step or use a build script:

```json
{
  "scripts": {
    "build": "tsc && vite build && node -e \"const fs=require('fs');const f='bin/vibelint.js';const c=fs.readFileSync(f,'utf8');if(!c.startsWith('#!'))fs.writeFileSync(f,'#!/usr/bin/env node\\n'+c)\""
  }
}
```

Alternatively, create a small build helper:

```typescript
// scripts/add-shebang.ts (run as part of build)
import { readFileSync, writeFileSync } from 'node:fs';

const binPath = 'bin/vibelint.js';
const content = readFileSync(binPath, 'utf-8');
if (!content.startsWith('#!')) {
  writeFileSync(binPath, '#!/usr/bin/env node\n' + content);
}
```

A cleaner approach is to use the build script:

```json
{
  "scripts": {
    "build": "tsc && vite build && npm run add-shebang",
    "add-shebang": "node -e \"const f=require('fs'),p='bin/vibelint.js',c=f.readFileSync(p,'utf8');c.startsWith('#!')||f.writeFileSync(p,'#!/usr/bin/env node\\n'+c)\""
  }
}
```

**Step 3: Verify tsconfig.json output structure**

```json
{
  "compilerOptions": {
    "outDir": "dist",
    "rootDir": "."
  },
  "include": ["src/**/*.ts", "src/**/*.tsx", "bin/**/*.ts"]
}
```

Important: With `rootDir: "."`, the compiled output for `bin/vibelint.ts` goes to `dist/bin/vibelint.js`. But the `"bin"` field in package.json points to `./bin/vibelint.js`. There are two approaches:

**Option A**: Change `rootDir` to produce flat output, or
**Option B**: Have the bin entry point re-export from dist:

Create a small `bin/vibelint.js` wrapper that is checked into git:

```javascript
#!/usr/bin/env node
// bin/vibelint.js — thin wrapper that loads the compiled entry point
import '../dist/bin/vibelint.js';
```

Or make `bin/vibelint.js` a standalone file:

```javascript
#!/usr/bin/env node
// bin/vibelint.js
import { startServer } from '../dist/server/index.js';
import open from 'open';

const PORT = 3847;

async function main() {
  if (process.argv.includes('--version') || process.argv.includes('-v')) {
    const pkg = await import('../package.json', { assert: { type: 'json' } });
    console.log(pkg.default.version);
    process.exit(0);
  }

  await startServer(PORT);
  console.log(`VibeLint running at http://localhost:${PORT}`);

  if (!process.argv.includes('--no-open')) {
    await open(`http://localhost:${PORT}`);
  }
}

main().catch((err) => {
  console.error('Failed to start VibeLint:', err);
  process.exit(1);
});
```

This approach is recommended: `bin/vibelint.js` is a committed JavaScript file (not compiled from TS) that serves as the CLI entry point.

**Step 4: Create .npmignore**

```
# Source files (ship compiled dist/ only)
src/
tests/

# Development config
tsconfig.json
vite.config.ts
tailwind.config.js
postcss.config.js
.eslintrc.*
.prettierrc*

# CI/CD
.github/

# Source maps (optional — remove if you want them in the package)
*.map

# Data and environment
data/
.env
.env.*

# OS files
.DS_Store
Thumbs.db

# Product plans and docs (internal)
product_plans/

# Package manager files
*.tgz

# Editor config
.vscode/
.idea/
```

**Step 5: Verify with npm pack**

Run the following commands to verify the setup:

```bash
# Build the project
npm run build

# Create the tarball
npm pack

# List contents of the tarball
tar tzf vibelint-0.1.0.tgz

# Expected output should show:
# package/bin/vibelint.js
# package/dist/...
# package/templates/...
# package/package.json
# package/README.md (if it exists)
# package/LICENSE (if it exists)

# Should NOT show:
# package/src/...
# package/tests/...
# package/tsconfig.json
# package/vite.config.ts

# Test global install
npm install -g ./vibelint-0.1.0.tgz

# Verify command works
vibelint --version
# Should output: 0.1.0

# Cleanup
npm uninstall -g vibelint
rm vibelint-0.1.0.tgz
```

**Step 6: Add --version flag support to the CLI**

```javascript
// bin/vibelint.js — ensure --version flag is handled

if (process.argv.includes('--version') || process.argv.includes('-v')) {
  // Read version from package.json
  import { createRequire } from 'node:module';
  const require = createRequire(import.meta.url);
  const pkg = require('../package.json');
  console.log(pkg.version);
  process.exit(0);
}
```

### 3.3 API Contract
N/A — this story is packaging and distribution setup only. No HTTP endpoints.

---

## 4. Definition of Done (The Gate)
- [ ] `package.json` has correct `name`, `version`, `description`, `keywords`, `license`, `author`, `repository`, `homepage` fields.
- [ ] `"bin"` field points to `./bin/vibelint.js` (compiled JavaScript with shebang).
- [ ] `"files"` array includes `bin/`, `dist/`, `templates/`.
- [ ] `"engines"` specifies `node >= 18`.
- [ ] `"build"` script runs `tsc && vite build` and produces valid output.
- [ ] `"prepublishOnly"` runs `npm run build`.
- [ ] `.npmignore` excludes `src/`, `tests/`, `.github/`, config files.
- [ ] `bin/vibelint.js` starts with `#!/usr/bin/env node`.
- [ ] `vibelint --version` outputs the package version.
- [ ] `npm pack` produces `vibelint-0.1.0.tgz` containing only `bin/`, `dist/`, `templates/`, `package.json`.
- [ ] `npm install -g ./vibelint-0.1.0.tgz` installs successfully and `vibelint` command is available.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
