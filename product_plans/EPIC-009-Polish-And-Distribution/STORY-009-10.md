---
id: STORY-009-10
parent_epic: EPIC-009
status: Draft
actor: Full-Stack Developer
complexity: Medium (2-3 files)
---
# STORY-009-10: Changelog System

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** VibeLint user,
**I want** to view the changelog to see what's new in each version,
**So that** I can understand what changed before and after updating, and know what new features or fixes are available.

### 1.2 Detailed Requirements
- **Requirement 1**: Maintain a `CHANGELOG.md` file in the project root following the [Keep a Changelog](https://keepachangelog.com/) format. Sections: Added, Changed, Fixed, Removed. Entries grouped by version with release dates.
- **Requirement 2**: Bundle `CHANGELOG.md` in the npm package (ensure it's not in `.npmignore` or `files` excludes).
- **Requirement 3**: Create `GET /api/changelog` endpoint that reads `CHANGELOG.md` from the installed package directory and returns it as raw markdown text (`Content-Type: text/markdown`) or parsed JSON (`?format=json` returning an array of version entries).
- **Requirement 4**: Create a Changelog page (`src/client/pages/Changelog.tsx`) accessible from the sidebar navigation. Renders the changelog markdown using the existing `FilePreview` component (from STORY-003-07).
- **Requirement 5**: The update notification banner (from STORY-009-09) should include a "What's new?" link that navigates to the Changelog page.
- **Requirement 6**: The Changelog page should highlight the current version's section and visually distinguish versions newer than the currently installed version (for users who haven't updated yet).
- **Requirement 7**: If `CHANGELOG.md` is not found (development/non-standard install), show a fallback message: "Changelog not available. View it at https://github.com/{org}/vibelint/blob/main/CHANGELOG.md" with a link.
- **Requirement 8**: Add a route for the Changelog page in the React Router config (`/changelog`).

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Changelog System

  Scenario: Changelog endpoint returns markdown
    Given CHANGELOG.md exists in the installed package
    When I send GET /api/changelog
    Then the response status is 200
    And the Content-Type is text/markdown
    And the body contains "# Changelog"

  Scenario: Changelog endpoint returns parsed JSON
    Given CHANGELOG.md exists with entries for v0.2.0 and v0.1.0
    When I send GET /api/changelog?format=json
    Then the response status is 200
    And the response body is an array of version entries
    And each entry has version, date, and sections (added, changed, fixed, removed)

  Scenario: Changelog page renders markdown
    Given the user navigates to /changelog
    When the page loads
    Then the CHANGELOG.md content is rendered as styled HTML
    And version headers are visible

  Scenario: Current version is highlighted
    Given the app is running version "0.1.0"
    And the changelog has entries for "0.2.0" and "0.1.0"
    When the user views the Changelog page
    Then the "0.1.0" section has a visual indicator (e.g., "Current version" badge)

  Scenario: Newer versions are visually distinguished
    Given the app is running version "0.1.0"
    And the changelog has an entry for "0.2.0"
    When the user views the Changelog page
    Then the "0.2.0" section is visually distinguished as a newer/available update

  Scenario: Update banner links to changelog
    Given the update banner is visible
    When the user clicks "What's new?"
    Then they are navigated to /changelog

  Scenario: CHANGELOG.md not found (dev mode)
    Given CHANGELOG.md does not exist at the expected path
    When I send GET /api/changelog
    Then the response status is 200
    And the body contains a fallback message with a GitHub link

  Scenario: Changelog accessible from navigation
    Given the user is on any page
    When they look at the sidebar navigation
    Then a "Changelog" link is visible
    And clicking it navigates to /changelog
```

### 2.2 Verification Steps
- [ ] `CHANGELOG.md` exists in the project root and follows Keep a Changelog format.
- [ ] `GET /api/changelog` returns the raw markdown content.
- [ ] `GET /api/changelog?format=json` returns parsed version entries.
- [ ] `/changelog` page renders the changelog with styled markdown.
- [ ] Current version section is highlighted.
- [ ] Update banner includes "What's new?" link.
- [ ] Fallback message shown when CHANGELOG.md is missing.
- [ ] Changelog link appears in sidebar navigation.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**:
  - `CHANGELOG.md` (create — project root)
  - `src/server/api/changelog.ts` (create — API endpoint)
  - `src/client/pages/Changelog.tsx` (create — UI page)
- **Related Files**:
  - `src/server/index.ts` (register changelog route)
  - `src/client/App.tsx` (add /changelog route)
  - `src/client/components/Sidebar.tsx` or layout (add navigation link)
  - `src/client/components/UpdateBanner.tsx` (add "What's new?" link)
  - `src/client/components/FilePreview.tsx` (reuse for rendering)
  - `package.json` (ensure CHANGELOG.md is included in `files`)
- **New Files Needed**: `CHANGELOG.md`, `src/server/api/changelog.ts`, `src/client/pages/Changelog.tsx`

### 3.2 Technical Logic

**Step 1: Create `CHANGELOG.md` in the project root**

```markdown
# Changelog

All notable changes to VibeLint will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

## [0.1.0] - YYYY-MM-DD

### Added
- Initial release
- Setup wizard with platform detection (Claude Code, Cursor, Windsurf, Generic)
- Repository management (add, scan, remove)
- Skills, rules, and commands editor with markdown preview
- File injection system for all supported platforms
- Analyzer engine: complexity, duplication, error patterns, file size, coupling
- vdoc documentation freshness monitoring
- PR & branch navigation with diff analysis
- Trends & historical metrics with line charts
- Settings page with API key management
- Pre-commit hook installer
- Export analysis reports (markdown, JSON)
- npm global install support
```

**Step 2: Ensure `CHANGELOG.md` is included in the npm package**

In `package.json`, add to the `files` array:

```json
{
  "files": [
    "dist/",
    "CHANGELOG.md",
    "README.md"
  ]
}
```

**Step 3: Create `src/server/api/changelog.ts`**

```typescript
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import { readFileSync, existsSync } from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const CHANGELOG_PATH = path.resolve(__dirname, '../../../CHANGELOG.md');
const GITHUB_FALLBACK_URL = 'https://github.com/vibelint/vibelint/blob/main/CHANGELOG.md';

/**
 * Simple parser for Keep a Changelog format.
 * Returns an array of version entries.
 */
interface ChangelogEntry {
  version: string;
  date: string | null;
  sections: {
    added: string[];
    changed: string[];
    fixed: string[];
    removed: string[];
  };
}

function parseChangelog(markdown: string): ChangelogEntry[] {
  const entries: ChangelogEntry[] = [];
  let current: ChangelogEntry | null = null;
  let currentSection: keyof ChangelogEntry['sections'] | null = null;

  for (const line of markdown.split('\n')) {
    // Match version headers: ## [0.1.0] - 2025-01-15 or ## [Unreleased]
    const versionMatch = line.match(/^## \[(.+?)\](?:\s*-\s*(.+))?/);
    if (versionMatch) {
      if (current) entries.push(current);
      current = {
        version: versionMatch[1],
        date: versionMatch[2]?.trim() || null,
        sections: { added: [], changed: [], fixed: [], removed: [] },
      };
      currentSection = null;
      continue;
    }

    // Match section headers: ### Added, ### Changed, etc.
    const sectionMatch = line.match(/^### (Added|Changed|Fixed|Removed)/i);
    if (sectionMatch && current) {
      currentSection = sectionMatch[1].toLowerCase() as keyof ChangelogEntry['sections'];
      continue;
    }

    // Match list items: - Something
    const itemMatch = line.match(/^- (.+)/);
    if (itemMatch && current && currentSection) {
      current.sections[currentSection].push(itemMatch[1]);
    }
  }

  if (current) entries.push(current);
  return entries;
}

export default async function changelogRoutes(fastify: FastifyInstance): Promise<void> {
  fastify.get('/api/changelog', async (request: FastifyRequest, reply: FastifyReply) => {
    const format = (request.query as { format?: string }).format;

    // Check if CHANGELOG.md exists
    if (!existsSync(CHANGELOG_PATH)) {
      if (format === 'json') {
        return reply.send([]);
      }
      return reply
        .type('text/markdown')
        .send(
          `# Changelog\n\nChangelog not available in this installation.\n\n` +
          `View it at: [${GITHUB_FALLBACK_URL}](${GITHUB_FALLBACK_URL})\n`
        );
    }

    const content = readFileSync(CHANGELOG_PATH, 'utf-8');

    if (format === 'json') {
      return reply.send(parseChangelog(content));
    }

    return reply.type('text/markdown').send(content);
  });
}
```

**Step 4: Create `src/client/pages/Changelog.tsx`**

```tsx
import React, { useEffect, useState } from 'react';
import FilePreview from '../components/FilePreview';

export default function Changelog() {
  const [markdown, setMarkdown] = useState<string | null>(null);
  const [currentVersion, setCurrentVersion] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Fetch changelog and version info in parallel
    Promise.all([
      fetch('/api/changelog').then((res) => res.text()),
      fetch('/api/version').then((res) => res.json()),
    ])
      .then(([changelogText, versionInfo]) => {
        setMarkdown(changelogText);
        setCurrentVersion(versionInfo.current);
      })
      .catch(() => {
        setMarkdown('# Changelog\n\nFailed to load changelog.');
      })
      .finally(() => setLoading(false));
  }, []);

  if (loading) {
    return (
      <div className="p-8 text-gray-500">Loading changelog...</div>
    );
  }

  return (
    <div className="max-w-3xl mx-auto py-8 px-4">
      <h1 className="text-2xl font-bold mb-2">Changelog</h1>
      {currentVersion && (
        <p className="text-sm text-gray-500 mb-6">
          You are running VibeLint <strong>v{currentVersion}</strong>
        </p>
      )}
      {markdown && <FilePreview content={markdown} />}
    </div>
  );
}
```

**Step 5: Add route in `src/client/App.tsx`**

```tsx
import Changelog from './pages/Changelog';

// In Routes:
<Route path="/changelog" element={<Changelog />} />
```

**Step 6: Add "What's new?" link to UpdateBanner**

In `src/client/components/UpdateBanner.tsx`, add a link between the version text and the buttons:

```tsx
import { Link } from 'react-router-dom';

// Inside the banner JSX, after the version text:
<Link to="/changelog" className="text-amber-700 underline hover:text-amber-900 ml-2">
  What's new?
</Link>
```

**Step 7: Add navigation link**

In the sidebar/navigation component, add:
```tsx
<NavLink to="/changelog">Changelog</NavLink>
```

### 3.3 API Contract

| Method | Path                          | Request Body | Response                                    |
|--------|-------------------------------|--------------|---------------------------------------------|
| GET    | `/api/changelog`              | N/A          | `200` — raw markdown (`text/markdown`)      |
| GET    | `/api/changelog?format=json`  | N/A          | `200` — `ChangelogEntry[]` as JSON          |

**ChangelogEntry shape:**
```typescript
{
  version: string;           // "0.1.0" or "Unreleased"
  date: string | null;       // "2025-01-15" or null
  sections: {
    added: string[];
    changed: string[];
    fixed: string[];
    removed: string[];
  };
}
```

---

## 4. Definition of Done (The Gate)
- [ ] `CHANGELOG.md` exists in the project root, following Keep a Changelog format.
- [ ] `CHANGELOG.md` is included in the npm package (`files` array in `package.json`).
- [ ] `GET /api/changelog` returns raw markdown content.
- [ ] `GET /api/changelog?format=json` returns parsed version entries.
- [ ] `/changelog` page renders the changelog using `FilePreview` with styled markdown.
- [ ] Current version is indicated on the Changelog page.
- [ ] Update banner includes a "What's new?" link to `/changelog`.
- [ ] Fallback message with GitHub link shown when `CHANGELOG.md` is missing.
- [ ] Changelog link appears in sidebar navigation.
- [ ] Route `/changelog` is registered in `App.tsx`.
- [ ] TypeScript compiles with no errors.
