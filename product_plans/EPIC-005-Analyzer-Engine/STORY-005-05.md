---
id: STORY-005-05
parent_epic: EPIC-005
status: Draft
actor: Backend Developer
complexity: Medium (2-3 files)
---
# STORY-005-05: Duplication Detection (jscpd)

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a module that wraps the jscpd CLI to detect code duplication across the repository,
**So that** the analyzer engine can flag duplicated code blocks and report the total duplication percentage, helping developers identify copy-paste patterns that increase maintenance burden.

### 1.2 Detailed Requirements
- **Requirement 1**: Implement `detectDuplication(repoPath: string, config: DuplicationConfig): Promise<DuplicationResult>` that invokes jscpd and parses its JSON output.
- **Requirement 2**: Shell command: `jscpd {repoPath} --reporters json --output {tempDir} --min-lines 10 --min-tokens 50 --ignore "{excludePattern}"`.
- **Requirement 3**: Use a unique temp directory for jscpd output: `/tmp/vibelint-jscpd-{repoId or timestamp}`. Clean up the temp directory after parsing.
- **Requirement 4**: Parse the JSON report from `{tempDir}/jscpd-report.json` to extract: total duplication percentage, individual clones with source file paths, start/end lines, and token counts.
- **Requirement 5**: Apply configurable thresholds: `warnThreshold` (default: 5% total duplication), `failThreshold` (default: 10% total duplication).
- **Requirement 6**: Exclude directories: `node_modules`, `dist`, `.git`, `.vibelint`, `vendor`, `build`. Pass as `--ignore` pattern to jscpd.
- **Requirement 7**: Graceful fallback if jscpd is not installed: return `{ status: 'skipped', available: false, reason: 'jscpd not installed. Run: npm install -g jscpd' }`.
- **Requirement 8**: Set a timeout of 120 seconds (jscpd can be slow on large repos).

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Duplication Detection via jscpd

  Scenario: Detect code duplication
    Given a repo with two files sharing a 20-line duplicated block
    And jscpd is installed
    When I call detectDuplication on the repo
    Then the result contains at least one clone entry
    And the clone entry identifies both source files and line ranges
    And the total duplication percentage is greater than 0

  Scenario: Duplication exceeds fail threshold
    Given a repo with more than 10% code duplication
    When I call detectDuplication with failThreshold=10
    Then the result status is "fail"

  Scenario: Duplication exceeds warn threshold but not fail
    Given a repo with 7% code duplication
    When I call detectDuplication with warnThreshold=5 and failThreshold=10
    Then the result status is "warn"

  Scenario: No significant duplication
    Given a repo with less than 5% code duplication
    When I call detectDuplication with warnThreshold=5
    Then the result status is "pass"

  Scenario: jscpd not installed
    Given jscpd is not available on the system PATH
    When I call detectDuplication
    Then the result status is "skipped"
    And available is false
    And reason contains "jscpd not installed"

  Scenario: Excluded directories are skipped
    Given a repo with duplicated code in "node_modules/"
    When I call detectDuplication
    Then clones from "node_modules/" do not appear in results

  Scenario: Temp directory is cleaned up
    Given a successful jscpd run
    When the result is returned
    Then the temp directory at /tmp/vibelint-jscpd-* no longer exists
```

### 2.2 Verification Steps
- [ ] `detectDuplication` returns clone data when jscpd is available.
- [ ] Total duplication percentage is correctly extracted from jscpd output.
- [ ] Clones include both file paths, start/end lines, and token counts.
- [ ] Thresholds are applied: pass < warnThreshold < failThreshold.
- [ ] Graceful fallback when jscpd is not installed.
- [ ] Excluded directories are passed to jscpd via `--ignore`.
- [ ] Temp directory is cleaned up after the run.
- [ ] Timeout of 120 seconds is enforced.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/analyzer/duplication.ts` (create)
- **Related Files**:
  - `src/server/utils/exec.ts` (shell execution utility from STORY-005-04)
  - `src/server/analyzer/languages/detector.ts` (reuse `SKIP_DIRS`)
- **New Files Needed**:
  - `src/server/analyzer/duplication.ts`
  - `tests/analyzer/duplication.test.ts`

### 3.2 Technical Logic

**Step 1: Define types and config**

```typescript
// src/server/analyzer/duplication.ts

import { join, relative } from 'node:path';
import { readFile, mkdtemp, rm } from 'node:fs/promises';
import { tmpdir } from 'node:os';
import { execCommand, isCommandAvailable } from '../utils/exec.js';
import { SKIP_DIRS } from './languages/detector.js';

export interface DuplicationConfig {
  warnThreshold: number;    // default: 5 (percent)
  failThreshold: number;    // default: 10 (percent)
  minLines: number;         // default: 10
  minTokens: number;        // default: 50
  timeoutMs: number;        // default: 120000
}

export const DEFAULT_DUPLICATION_CONFIG: DuplicationConfig = {
  warnThreshold: 5,
  failThreshold: 10,
  minLines: 10,
  minTokens: 50,
  timeoutMs: 120_000,
};

export interface CloneEntry {
  firstFile: string;     // relative path
  firstStartLine: number;
  firstEndLine: number;
  secondFile: string;    // relative path
  secondStartLine: number;
  secondEndLine: number;
  lines: number;
  tokens: number;
  fragment?: string;     // optional code snippet
}

export interface DuplicationResult {
  status: 'pass' | 'warn' | 'fail' | 'skipped';
  available: boolean;
  reason?: string;
  percentage: number;
  clones: CloneEntry[];
  summary: {
    totalClones: number;
    totalDuplicatedLines: number;
    totalLines: number;
    percentage: number;
  };
}
```

**Step 2: Build jscpd command arguments**

```typescript
function buildJscpdArgs(
  repoPath: string,
  outputDir: string,
  config: DuplicationConfig
): string[] {
  const args = [
    repoPath,
    '--reporters', 'json',
    '--output', outputDir,
    '--min-lines', String(config.minLines),
    '--min-tokens', String(config.minTokens),
    '--format', 'javascript,typescript,python,go,java,csharp,ruby,rust',
  ];

  // Build ignore pattern from SKIP_DIRS
  const ignorePatterns = Array.from(SKIP_DIRS).map(dir => `**/${dir}/**`);
  args.push('--ignore', ignorePatterns.join(','));

  return args;
}
```

**Step 3: Parse jscpd JSON report**

```typescript
// jscpd report JSON structure
interface JscpdReport {
  statistics: {
    total: {
      lines: number;
      sources: number;
      clones: number;
      duplicatedLines: number;
      percentage: string;  // e.g., "12.34"
    };
  };
  duplicates: Array<{
    format: string;
    lines: number;
    tokens: number;
    firstFile: {
      name: string;
      start: number;
      end: number;
      startLoc: { line: number; column: number };
      endLoc: { line: number; column: number };
    };
    secondFile: {
      name: string;
      start: number;
      end: number;
      startLoc: { line: number; column: number };
      endLoc: { line: number; column: number };
    };
    fragment?: string;
  }>;
}

async function parseJscpdReport(
  outputDir: string,
  repoPath: string
): Promise<{ percentage: number; clones: CloneEntry[]; totalLines: number; duplicatedLines: number }> {
  const reportPath = join(outputDir, 'jscpd-report.json');
  const content = await readFile(reportPath, 'utf-8');
  const report: JscpdReport = JSON.parse(content);

  const percentage = parseFloat(report.statistics.total.percentage) || 0;
  const totalLines = report.statistics.total.lines;
  const duplicatedLines = report.statistics.total.duplicatedLines;

  const clones: CloneEntry[] = report.duplicates.map(dup => ({
    firstFile: relative(repoPath, dup.firstFile.name),
    firstStartLine: dup.firstFile.startLoc.line,
    firstEndLine: dup.firstFile.endLoc.line,
    secondFile: relative(repoPath, dup.secondFile.name),
    secondStartLine: dup.secondFile.startLoc.line,
    secondEndLine: dup.secondFile.endLoc.line,
    lines: dup.lines,
    tokens: dup.tokens,
    fragment: dup.fragment,
  }));

  return { percentage, clones, totalLines, duplicatedLines };
}
```

**Step 4: Implement detectDuplication**

```typescript
export async function detectDuplication(
  repoPath: string,
  config: DuplicationConfig = DEFAULT_DUPLICATION_CONFIG
): Promise<DuplicationResult> {
  // Check if jscpd is available
  const available = await isCommandAvailable('jscpd');
  if (!available) {
    return {
      status: 'skipped',
      available: false,
      reason: 'jscpd not installed. Run: npm install -g jscpd',
      percentage: 0,
      clones: [],
      summary: { totalClones: 0, totalDuplicatedLines: 0, totalLines: 0, percentage: 0 },
    };
  }

  // Create temp directory for jscpd output
  const tempDir = await mkdtemp(join(tmpdir(), 'vibelint-jscpd-'));

  try {
    // Execute jscpd
    const args = buildJscpdArgs(repoPath, tempDir, config);
    try {
      await execCommand('jscpd', args, {
        timeoutMs: config.timeoutMs,
        cwd: repoPath,
      });
    } catch (error: any) {
      if (error.killed || error.signal === 'SIGTERM') {
        return {
          status: 'skipped',
          available: true,
          reason: `jscpd timed out after ${config.timeoutMs / 1000}s`,
          percentage: 0,
          clones: [],
          summary: { totalClones: 0, totalDuplicatedLines: 0, totalLines: 0, percentage: 0 },
        };
      }
      // jscpd may exit with non-zero if duplicates found — check if report exists
    }

    // Parse the report
    const { percentage, clones, totalLines, duplicatedLines } =
      await parseJscpdReport(tempDir, repoPath);

    // Determine status based on thresholds
    let status: 'pass' | 'warn' | 'fail' = 'pass';
    if (percentage >= config.failThreshold) {
      status = 'fail';
    } else if (percentage >= config.warnThreshold) {
      status = 'warn';
    }

    return {
      status,
      available: true,
      percentage,
      clones,
      summary: {
        totalClones: clones.length,
        totalDuplicatedLines: duplicatedLines,
        totalLines,
        percentage,
      },
    };
  } catch (error: any) {
    return {
      status: 'skipped',
      available: true,
      reason: `jscpd error: ${error.message}`,
      percentage: 0,
      clones: [],
      summary: { totalClones: 0, totalDuplicatedLines: 0, totalLines: 0, percentage: 0 },
    };
  } finally {
    // Always clean up temp directory
    await rm(tempDir, { recursive: true, force: true }).catch(() => {});
  }
}
```

### 3.3 API Contract
N/A — this is an internal module consumed by the analysis engine (STORY-005-08). No HTTP endpoints.

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/analyzer/duplication.ts` exists and exports `detectDuplication`, `DuplicationConfig`, `DuplicationResult`, and related types.
- [ ] When jscpd is installed, `detectDuplication` returns clone data with file paths, line ranges, and duplication percentage.
- [ ] Thresholds correctly determine status: pass (< warnThreshold), warn (>= warnThreshold), fail (>= failThreshold).
- [ ] When jscpd is not installed, returns `status: 'skipped'` with installation instructions.
- [ ] Timeout of 120 seconds is enforced; timed-out runs return `status: 'skipped'`.
- [ ] Directories in `SKIP_DIRS` are excluded via jscpd `--ignore` flags.
- [ ] Temp directory is always cleaned up (even on error).
- [ ] Unit tests pass (with mocked jscpd output for CI environments).
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
