---
id: STORY-005-01
parent_epic: EPIC-005
status: Draft
actor: Backend Developer
complexity: Low (1 file)
---
# STORY-005-01: Language Detector

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a language detection module that walks a repository's source files, counts them by extension, and returns a sorted list of detected languages,
**So that** the analyzer engine knows which language-specific checks to run and can report the repo's language composition.

### 1.2 Detailed Requirements
- **Requirement 1**: Implement `detectLanguages(repoPath: string): Promise<LanguageStats[]>` that recursively walks source files in the given repository path.
- **Requirement 2**: Map file extensions to languages using a static lookup: `.ts`/`.tsx` -> TypeScript, `.js`/`.jsx` -> JavaScript, `.py` -> Python, `.go` -> Go, `.java` -> Java, `.rs` -> Rust, `.cs` -> C#, `.rb` -> Ruby.
- **Requirement 3**: Skip the following directories during traversal: `node_modules`, `.git`, `dist`, `build`, `vendor`, `__pycache__`, `.vibelint`.
- **Requirement 4**: Cap file traversal at 2000 files maximum to prevent runaway scans on massive repos. If the cap is hit, set a `truncated: true` flag on the result.
- **Requirement 5**: Return results sorted by `fileCount` descending. Each entry contains `language`, `fileCount`, and `percentage` (rounded to 1 decimal).
- **Requirement 6**: If no source files are found, return an empty array.
- **Requirement 7**: Export the `EXTENSION_MAP` and `SKIP_DIRS` constants so other analyzer modules can reuse them for file filtering.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Language Detection

  Scenario: Detect languages in a TypeScript/Python repo
    Given a repository at "/tmp/test-repo" with 10 .ts files and 5 .py files
    When I call detectLanguages("/tmp/test-repo")
    Then the result contains { language: "TypeScript", fileCount: 10, percentage: 66.7 }
    And the result contains { language: "Python", fileCount: 5, percentage: 33.3 }
    And TypeScript appears before Python in the array

  Scenario: Skip excluded directories
    Given a repository with 3 .ts files in "src/" and 100 .js files in "node_modules/"
    When I call detectLanguages on the repository
    Then the result contains only { language: "TypeScript", fileCount: 3, percentage: 100.0 }
    And no JavaScript entry appears

  Scenario: File cap is enforced
    Given a repository with 3000 .js files
    When I call detectLanguages on the repository
    Then the result reflects at most 2000 files
    And the result has truncated set to true

  Scenario: Empty repository
    Given a repository with no source files (only a README.md)
    When I call detectLanguages on the repository
    Then the result is an empty array

  Scenario: Unknown extensions are ignored
    Given a repository with 5 .ts files and 3 .xyz files
    When I call detectLanguages on the repository
    Then the result contains only { language: "TypeScript", fileCount: 5, percentage: 100.0 }
```

### 2.2 Verification Steps
- [ ] `detectLanguages` returns correct counts for a fixture repo with known file types.
- [ ] Directories in `SKIP_DIRS` are never traversed.
- [ ] File count never exceeds 2000; `truncated` flag is set when limit is hit.
- [ ] Percentages sum to 100 (within rounding tolerance).
- [ ] Result is sorted by `fileCount` descending.
- [ ] Unknown file extensions do not appear in results.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/analyzer/languages/detector.ts` (create)
- **Related Files**: None (first analyzer module)
- **New Files Needed**:
  - `src/server/analyzer/languages/detector.ts`
  - `tests/analyzer/detector.test.ts` (unit tests)

### 3.2 Technical Logic

**Step 1: Define types and constants**

```typescript
// src/server/analyzer/languages/detector.ts

export interface LanguageStats {
  language: string;
  fileCount: number;
  percentage: number;
}

export interface DetectionResult {
  languages: LanguageStats[];
  totalFiles: number;
  truncated: boolean;
}

export const EXTENSION_MAP: Record<string, string> = {
  '.ts': 'TypeScript',
  '.tsx': 'TypeScript',
  '.js': 'JavaScript',
  '.jsx': 'JavaScript',
  '.py': 'Python',
  '.go': 'Go',
  '.java': 'Java',
  '.rs': 'Rust',
  '.cs': 'C#',
  '.rb': 'Ruby',
};

export const SKIP_DIRS = new Set([
  'node_modules',
  '.git',
  'dist',
  'build',
  'vendor',
  '__pycache__',
  '.vibelint',
]);

const MAX_FILES = 2000;
```

**Step 2: Implement recursive file walker**

```typescript
import { readdir, stat } from 'node:fs/promises';
import { join, extname, basename } from 'node:path';

async function walkSourceFiles(
  dir: string,
  files: string[],
  maxFiles: number
): Promise<boolean> {
  if (files.length >= maxFiles) return true;

  let entries;
  try {
    entries = await readdir(dir, { withFileTypes: true });
  } catch {
    // Permission denied or missing directory — skip silently
    return false;
  }

  for (const entry of entries) {
    if (files.length >= maxFiles) return true;

    if (entry.isDirectory()) {
      if (SKIP_DIRS.has(entry.name)) continue;
      const truncated = await walkSourceFiles(
        join(dir, entry.name),
        files,
        maxFiles
      );
      if (truncated) return true;
    } else if (entry.isFile()) {
      const ext = extname(entry.name).toLowerCase();
      if (EXTENSION_MAP[ext]) {
        files.push(join(dir, entry.name));
      }
    }
  }
  return false;
}
```

**Step 3: Implement detectLanguages**

```typescript
export async function detectLanguages(
  repoPath: string
): Promise<DetectionResult> {
  const files: string[] = [];
  const truncated = await walkSourceFiles(repoPath, files, MAX_FILES);

  // Count files per language
  const counts = new Map<string, number>();
  for (const filePath of files) {
    const ext = extname(filePath).toLowerCase();
    const language = EXTENSION_MAP[ext];
    if (language) {
      counts.set(language, (counts.get(language) || 0) + 1);
    }
  }

  const totalFiles = files.length;
  if (totalFiles === 0) {
    return { languages: [], totalFiles: 0, truncated: false };
  }

  // Build sorted result
  const languages: LanguageStats[] = Array.from(counts.entries())
    .map(([language, fileCount]) => ({
      language,
      fileCount,
      percentage: Math.round((fileCount / totalFiles) * 1000) / 10,
    }))
    .sort((a, b) => b.fileCount - a.fileCount);

  return { languages, totalFiles, truncated };
}
```

### 3.3 API Contract
N/A — this is an internal module consumed by the analysis engine (STORY-005-08). No HTTP endpoints.

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/analyzer/languages/detector.ts` exists and exports `detectLanguages`, `EXTENSION_MAP`, `SKIP_DIRS`.
- [ ] `detectLanguages` correctly counts files by extension and returns sorted `LanguageStats[]`.
- [ ] Directories in `SKIP_DIRS` are excluded from traversal.
- [ ] File traversal stops at 2000 files and sets `truncated: true`.
- [ ] Empty repos return an empty array with `totalFiles: 0`.
- [ ] Unknown file extensions are silently ignored.
- [ ] Unit tests pass covering all scenarios above.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
