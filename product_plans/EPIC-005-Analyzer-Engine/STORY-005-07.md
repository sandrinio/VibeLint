---
id: STORY-005-07
parent_epic: EPIC-005
status: Draft
actor: Backend Developer
complexity: Low (1 file)
---
# STORY-005-07: Coupling Analysis

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a module that analyzes how many files and directories were touched in recent changes using git diff,
**So that** the analyzer engine can flag overly broad changesets that indicate tight coupling or scattered modifications across the codebase.

### 1.2 Detailed Requirements
- **Requirement 1**: Implement `analyzeCoupling(repoPath: string, baseBranch?: string): Promise<CouplingResult>` that uses git diff to count unique files and directories touched.
- **Requirement 2**: If `baseBranch` is provided, run `git diff --stat {baseBranch}...HEAD`. If not provided, fall back to `git diff --stat HEAD~10` (last 10 commits).
- **Requirement 3**: Parse git diff stat output to extract: list of changed file paths, count of unique top-level directories touched, total files changed, insertions, and deletions.
- **Requirement 4**: Apply configurable thresholds for directory spread: `warnThreshold` (default: 10 directories), `failThreshold` (default: 20 directories).
- **Requirement 5**: If the path is not a git repository or has no commits, return `{ status: 'skipped', reason: 'Not a git repository' }` without throwing an error.
- **Requirement 6**: File paths in the result should be relative to the repo root.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Coupling Analysis via Git Diff

  Scenario: Analyze coupling against base branch
    Given a git repo with changes touching 5 directories compared to "main"
    When I call analyzeCoupling with baseBranch="main"
    Then the result contains dirsChanged=5
    And the result contains the list of changed files
    And the status is "pass" (below warn threshold of 10)

  Scenario: Directory spread exceeds warn threshold
    Given a git repo with changes touching 12 directories
    When I call analyzeCoupling with warnThreshold=10
    Then the status is "warn"

  Scenario: Directory spread exceeds fail threshold
    Given a git repo with changes touching 25 directories
    When I call analyzeCoupling with failThreshold=20
    Then the status is "fail"

  Scenario: No base branch provided — fallback to HEAD~10
    Given a git repo with at least 10 commits
    When I call analyzeCoupling without baseBranch
    Then the result reflects files changed in the last 10 commits

  Scenario: Not a git repository
    Given a directory that is not a git repository
    When I call analyzeCoupling
    Then the result status is "skipped"
    And reason is "Not a git repository"

  Scenario: New repo with no commits
    Given a git repo with no commits
    When I call analyzeCoupling
    Then the result status is "skipped"
    And reason indicates no commits available
```

### 2.2 Verification Steps
- [ ] `analyzeCoupling` correctly counts files and directories from git diff output.
- [ ] Base branch comparison uses `{baseBranch}...HEAD` syntax.
- [ ] Fallback to `HEAD~10` when no base branch is provided.
- [ ] Thresholds are correctly applied: pass < warnThreshold < failThreshold.
- [ ] Non-git directories return `status: 'skipped'` gracefully.
- [ ] Repos with no commits return `status: 'skipped'` gracefully.
- [ ] File list contains relative paths.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/analyzer/coupling.ts` (create)
- **Related Files**:
  - `src/server/utils/exec.ts` (shell execution utility from STORY-005-04)
- **New Files Needed**:
  - `src/server/analyzer/coupling.ts`
  - `tests/analyzer/coupling.test.ts`

### 3.2 Technical Logic

**Step 1: Define types and config**

```typescript
// src/server/analyzer/coupling.ts

import { access } from 'node:fs/promises';
import { join, dirname } from 'node:path';
import { execCommand } from '../utils/exec.js';

export interface CouplingConfig {
  warnThreshold: number;   // default: 10 dirs
  failThreshold: number;   // default: 20 dirs
}

export const DEFAULT_COUPLING_CONFIG: CouplingConfig = {
  warnThreshold: 10,
  failThreshold: 20,
};

export interface CouplingResult {
  status: 'pass' | 'warn' | 'fail' | 'skipped';
  reason?: string;
  filesChanged: number;
  dirsChanged: number;
  insertions: number;
  deletions: number;
  fileList: string[];
  dirList: string[];
}
```

**Step 2: Check git repository status**

```typescript
async function isGitRepo(repoPath: string): Promise<boolean> {
  try {
    await access(join(repoPath, '.git'));
    return true;
  } catch {
    return false;
  }
}

async function hasCommits(repoPath: string): Promise<boolean> {
  try {
    await execCommand('git', ['rev-parse', 'HEAD'], { cwd: repoPath, timeoutMs: 5_000 });
    return true;
  } catch {
    return false;
  }
}

async function branchExists(repoPath: string, branch: string): Promise<boolean> {
  try {
    await execCommand('git', ['rev-parse', '--verify', branch], { cwd: repoPath, timeoutMs: 5_000 });
    return true;
  } catch {
    return false;
  }
}
```

**Step 3: Parse git diff --stat output**

```typescript
interface DiffStatResult {
  files: string[];
  insertions: number;
  deletions: number;
}

function parseDiffStat(stdout: string): DiffStatResult {
  const lines = stdout.trim().split('\n');
  const files: string[] = [];
  let insertions = 0;
  let deletions = 0;

  for (const line of lines) {
    // File lines look like: " src/server/api/repos.ts | 45 ++++-----"
    // Summary line looks like: " 12 files changed, 340 insertions(+), 28 deletions(-)"
    const fileMatch = line.match(/^\s*(.+?)\s*\|\s*\d+/);
    if (fileMatch) {
      files.push(fileMatch[1].trim());
      continue;
    }

    const summaryMatch = line.match(
      /(\d+)\s+files?\s+changed(?:,\s+(\d+)\s+insertions?\(\+\))?(?:,\s+(\d+)\s+deletions?\(-\))?/
    );
    if (summaryMatch) {
      insertions = parseInt(summaryMatch[2] || '0', 10);
      deletions = parseInt(summaryMatch[3] || '0', 10);
    }
  }

  return { files, insertions, deletions };
}

function extractUniqueDirectories(files: string[]): string[] {
  const dirs = new Set<string>();
  for (const file of files) {
    // Use the first path segment as the "top-level directory"
    const dir = dirname(file);
    if (dir !== '.') {
      // Add the first-level directory (e.g., "src" from "src/server/api/repos.ts")
      const topLevel = file.split('/')[0];
      dirs.add(topLevel);
      // Also add the second-level for more granular coupling signal
      const parts = file.split('/');
      if (parts.length >= 2) {
        dirs.add(parts.slice(0, 2).join('/'));
      }
    } else {
      dirs.add('.');
    }
  }
  return Array.from(dirs).sort();
}
```

**Step 4: Implement analyzeCoupling**

```typescript
export async function analyzeCoupling(
  repoPath: string,
  baseBranch?: string,
  config: CouplingConfig = DEFAULT_COUPLING_CONFIG
): Promise<CouplingResult> {
  // Check if this is a git repo
  if (!(await isGitRepo(repoPath))) {
    return {
      status: 'skipped',
      reason: 'Not a git repository',
      filesChanged: 0,
      dirsChanged: 0,
      insertions: 0,
      deletions: 0,
      fileList: [],
      dirList: [],
    };
  }

  // Check if there are any commits
  if (!(await hasCommits(repoPath))) {
    return {
      status: 'skipped',
      reason: 'No commits in repository',
      filesChanged: 0,
      dirsChanged: 0,
      insertions: 0,
      deletions: 0,
      fileList: [],
      dirList: [],
    };
  }

  // Build the git diff command
  let diffArgs: string[];
  if (baseBranch && await branchExists(repoPath, baseBranch)) {
    diffArgs = ['diff', '--stat', `${baseBranch}...HEAD`];
  } else {
    // Fallback: compare against last 10 commits
    // Check if we have at least 10 commits
    try {
      await execCommand('git', ['rev-parse', 'HEAD~10'], { cwd: repoPath, timeoutMs: 5_000 });
      diffArgs = ['diff', '--stat', 'HEAD~10'];
    } catch {
      // Fewer than 10 commits — diff against initial commit
      try {
        const { stdout: rootHash } = await execCommand(
          'git', ['rev-list', '--max-parents=0', 'HEAD'],
          { cwd: repoPath, timeoutMs: 5_000 }
        );
        diffArgs = ['diff', '--stat', rootHash.trim()];
      } catch {
        return {
          status: 'skipped',
          reason: 'Unable to determine diff range',
          filesChanged: 0,
          dirsChanged: 0,
          insertions: 0,
          deletions: 0,
          fileList: [],
          dirList: [],
        };
      }
    }
  }

  // Execute git diff
  let stdout: string;
  try {
    const result = await execCommand('git', diffArgs, {
      cwd: repoPath,
      timeoutMs: 10_000,
    });
    stdout = result.stdout;
  } catch (error: any) {
    return {
      status: 'skipped',
      reason: `Git diff failed: ${error.message}`,
      filesChanged: 0,
      dirsChanged: 0,
      insertions: 0,
      deletions: 0,
      fileList: [],
      dirList: [],
    };
  }

  // Parse the output
  const { files, insertions, deletions } = parseDiffStat(stdout);
  const dirs = extractUniqueDirectories(files);

  // Apply thresholds
  let status: 'pass' | 'warn' | 'fail' = 'pass';
  if (dirs.length >= config.failThreshold) {
    status = 'fail';
  } else if (dirs.length >= config.warnThreshold) {
    status = 'warn';
  }

  return {
    status,
    filesChanged: files.length,
    dirsChanged: dirs.length,
    insertions,
    deletions,
    fileList: files,
    dirList: dirs,
  };
}
```

### 3.3 API Contract
N/A — this is an internal module consumed by the analysis engine (STORY-005-08). No HTTP endpoints.

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/analyzer/coupling.ts` exists and exports `analyzeCoupling`, `CouplingConfig`, `CouplingResult`, and related types.
- [ ] `analyzeCoupling` correctly parses git diff stat output into file and directory counts.
- [ ] Base branch comparison uses `{baseBranch}...HEAD` when provided.
- [ ] Fallback to `HEAD~10` when no base branch is provided.
- [ ] Further fallback to initial commit when fewer than 10 commits exist.
- [ ] Thresholds correctly determine status: pass, warn, or fail based on directory count.
- [ ] Non-git directories return `status: 'skipped'` without errors.
- [ ] Repos with no commits return `status: 'skipped'` without errors.
- [ ] Unit tests pass covering all scenarios.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
