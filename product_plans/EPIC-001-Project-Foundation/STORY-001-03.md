---
id: STORY-001-03
parent_epic: EPIC-001
status: Done
actor: Backend Developer
complexity: Low (1 file)
---
# STORY-001-03: Fastify Server with Health Check

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a Fastify HTTP server running on port 3847 with CORS, static file serving, and a health check endpoint,
**So that** the frontend can communicate with the backend and subsequent API routes can be registered on a working server instance.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/server/index.ts` that instantiates and configures a Fastify server.
- **Requirement 2**: Server listens on port 3847 by default (configurable via parameter).
- **Requirement 3**: Register CORS allowing all origins in development mode.
- **Requirement 4**: Serve static files from `dist/client` in production mode (when the directory exists).
- **Requirement 5**: Register a health check endpoint: `GET /api/health` returns `{ status: "ok", version: "0.1.0" }`.
- **Requirement 6**: Implement graceful shutdown on SIGINT and SIGTERM signals.
- **Requirement 7**: Export a `startServer(options)` function that the CLI entry point can call.
- **Requirement 8**: Bind to `127.0.0.1` by default (not `0.0.0.0`) to prevent network exposure. No authentication exists, so the server must only be accessible locally. Support `--host` CLI flag for explicit override.
- **Requirement 9**: Detect port conflicts on startup. If port 3847 is already in use, show a clear error: "Port 3847 is already in use. Is VibeLint already running?" instead of crashing with an opaque EADDRINUSE error.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Fastify Server with Health Check

  Scenario: Server starts and responds to health check
    Given the server module is imported
    When I call startServer({ port: 3847 })
    Then the server is listening on port 3847
    And GET /api/health returns status 200
    And the response body is { "status": "ok", "version": "0.1.0" }

  Scenario: CORS headers are present in dev mode
    Given the server is running
    When I send a request with Origin header "http://localhost:5173"
    Then the response includes Access-Control-Allow-Origin header

  Scenario: Graceful shutdown
    Given the server is running
    When the process receives SIGINT
    Then the server closes all connections
    And the process exits cleanly

  Scenario: Server accepts custom port
    Given the server module is imported
    When I call startServer({ port: 4000 })
    Then the server is listening on port 4000

  Scenario: Server binds to localhost only by default
    Given the server module is imported
    When I call startServer() with default options
    Then the server is listening on 127.0.0.1:3847
    And the server is NOT accessible from external network interfaces

  Scenario: Server detects port conflict
    Given another process is already listening on port 3847
    When I call startServer({ port: 3847 })
    Then a clear error message is shown: "Port 3847 is already in use. Is VibeLint already running?"
    And the process exits with a non-zero code
```

### 2.2 Verification Steps
- [ ] `tsx src/server/index.ts` starts the server (or calling startServer programmatically).
- [ ] `curl http://localhost:3847/api/health` returns `{"status":"ok","version":"0.1.0"}`.
- [ ] Response headers include CORS headers.
- [ ] Sending SIGINT gracefully stops the server.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/index.ts`
- **Related Files**: `package.json` (already has `fastify` dependency from STORY-001-01)
- **New Files Needed**: Yes — `src/server/index.ts`

### 3.2 Technical Logic

**Step 1: Create `src/server/index.ts`**

```typescript
import Fastify, { type FastifyInstance } from 'fastify';
import cors from '@fastify/cors';
import fastifyStatic from '@fastify/static';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const PKG_VERSION = '0.1.0';

export interface ServerOptions {
  port?: number;
  host?: string;
}

export async function createServer(): Promise<FastifyInstance> {
  const server = Fastify({
    logger: {
      level: 'info',
      transport: {
        target: 'pino-pretty',
        options: { translateTime: 'HH:MM:ss', ignore: 'pid,hostname' },
      },
    },
  });

  // --- CORS ---
  await server.register(cors, {
    origin: true, // allow all origins in dev
  });

  // --- Static files (production) ---
  const clientDistPath = path.resolve(__dirname, '../../dist/client');
  try {
    await server.register(fastifyStatic, {
      root: clientDistPath,
      prefix: '/',
      wildcard: false,
    });
  } catch {
    // dist/client may not exist yet — that's fine in dev
    server.log.info('Static file directory not found; skipping static serving.');
  }

  // --- Health Check ---
  server.get('/api/health', async () => {
    return { status: 'ok', version: PKG_VERSION };
  });

  return server;
}

export async function startServer(options: ServerOptions = {}): Promise<FastifyInstance> {
  const port = options.port ?? 3847;
  const host = options.host ?? '127.0.0.1'; // Bind to localhost only — no auth exists

  const server = await createServer();

  // --- Graceful Shutdown ---
  const shutdown = async () => {
    server.log.info('Shutting down gracefully...');
    await server.close();
    process.exit(0);
  };

  process.on('SIGINT', shutdown);
  process.on('SIGTERM', shutdown);

  // --- Start ---
  try {
    await server.listen({ port, host });
  } catch (err: unknown) {
    if (err instanceof Error && 'code' in err && (err as NodeJS.ErrnoException).code === 'EADDRINUSE') {
      server.log.error(`Port ${port} is already in use. Is VibeLint already running?`);
      process.exit(1);
    }
    throw err;
  }
  server.log.info(`VibeLint server running at http://localhost:${port}`);

  return server;
}
```

**Step 2: Add required Fastify plugins to `package.json` dependencies**

```bash
npm install @fastify/cors @fastify/static
npm install -D pino-pretty
```

Note: `pino-pretty` is optional for dev-friendly log formatting. The server works without it; logs will just be raw JSON.

**Step 3: Verify**

```bash
npx tsx src/server/index.ts
# In another terminal:
curl http://localhost:3847/api/health
# Expected: {"status":"ok","version":"0.1.0"}
```

### 3.3 API Contract

| Method | Path          | Request Body | Response (200)                              |
|--------|---------------|--------------|---------------------------------------------|
| GET    | `/api/health` | N/A          | `{ "status": "ok", "version": "0.1.0" }`   |

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/index.ts` exists and exports `createServer()` and `startServer()`.
- [ ] Server starts on port 3847 by default.
- [ ] Server binds to `127.0.0.1` by default (NOT `0.0.0.0`).
- [ ] `GET /api/health` returns `{ "status": "ok", "version": "0.1.0" }` with status 200.
- [ ] CORS headers are present on responses.
- [ ] Graceful shutdown works on SIGINT/SIGTERM.
- [ ] Port conflict (EADDRINUSE) shows a clear user-facing error message instead of a stack trace.
- [ ] `@fastify/cors` and `@fastify/static` are listed in `package.json` dependencies.
