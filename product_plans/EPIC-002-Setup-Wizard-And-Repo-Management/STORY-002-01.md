---
id: STORY-002-01
parent_epic: EPIC-002
status: Done
actor: Backend Developer
complexity: Medium (2-3 files)
---
# STORY-002-01: Git Scanner

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a Git scanner module that inspects a repository path to detect languages, branches, and existing AI context files,
**So that** the Setup Wizard and Repo Management features have accurate metadata about each connected repository.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/server/git/scanner.ts` with a `scanRepo(repoPath: string)` function.
- **Requirement 2**: Validate that the given path contains a `.git` directory (or is a valid bare repo). Throw a descriptive error if not.
- **Requirement 3**: Detect programming languages by walking the first 2000 files and mapping file extensions to language names (`.ts` -> TypeScript, `.py` -> Python, `.rs` -> Rust, etc.).
- **Requirement 4**: List all branches via `git branch -a` (both local and remote).
- **Requirement 5**: Detect the current branch via `git rev-parse --abbrev-ref HEAD`.
- **Requirement 6**: Check for existing AI context files: `CLAUDE.md`, `.cursorrules`, `.windsurfrules`, `AGENTS.md`, `LESSONS.md`, `.vibelint/`, `vdocs/`.
- **Requirement 7**: Return a typed `RepoScanResult` object.
- **Requirement 8**: Create `src/server/utils/exec.ts` with a helper for executing shell commands with error handling.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Git Scanner

  Scenario: Scan a valid git repository
    Given a directory at "/path/to/repo" contains a .git folder
    When scanRepo("/path/to/repo") is called
    Then the result contains the repo name derived from the directory name
    And the result contains a non-empty languages array
    And the result contains a branches array with at least one entry
    And the result contains the current branch name
    And the result contains an existingFiles record

  Scenario: Scan a non-git directory
    Given a directory at "/tmp/not-a-repo" has no .git folder
    When scanRepo("/tmp/not-a-repo") is called
    Then an error is thrown with message containing "not a git repository"

  Scenario: Scan a non-existent directory
    Given the path "/tmp/does-not-exist" does not exist
    When scanRepo("/tmp/does-not-exist") is called
    Then an error is thrown with message containing "does not exist"

  Scenario: Language detection from file extensions
    Given a repo contains files: main.ts, utils.py, styles.css, README.md
    When scanRepo is called on that repo
    Then languages includes "TypeScript" and "Python" and "CSS"

  Scenario: Existing file detection
    Given a repo contains a CLAUDE.md file and a .cursorrules file
    When scanRepo is called on that repo
    Then existingFiles["CLAUDE.md"] is true
    And existingFiles[".cursorrules"] is true
    And existingFiles[".windsurfrules"] is false
```

### 2.2 Verification Steps
- [ ] `scanRepo()` returns a valid `RepoScanResult` when pointed at a real git repository.
- [ ] `scanRepo()` throws for non-git directories.
- [ ] `scanRepo()` throws for non-existent paths.
- [ ] Language detection produces correct results for common extensions.
- [ ] Branch listing includes both local and remote branches.
- [ ] Current branch is correctly identified.
- [ ] Existing file detection correctly identifies present and absent files.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**:
  - `src/server/git/scanner.ts`
  - `src/server/utils/exec.ts`
- **Related Files**: None directly (consumed by STORY-002-03 Repo CRUD API)
- **New Files Needed**: Yes — both files listed above

### 3.2 Technical Logic

**Step 1: Create `src/server/utils/exec.ts`**

```typescript
import { execSync } from 'node:child_process';

export interface ExecResult {
  stdout: string;
  success: boolean;
}

/**
 * Execute a shell command synchronously with error handling.
 * Returns stdout as a trimmed string.
 */
export function exec(command: string, cwd?: string): ExecResult {
  try {
    const stdout = execSync(command, {
      cwd,
      encoding: 'utf-8',
      timeout: 30_000,
      stdio: ['pipe', 'pipe', 'pipe'],
    }).trim();
    return { stdout, success: true };
  } catch {
    return { stdout: '', success: false };
  }
}

/**
 * Execute a shell command and throw on failure.
 */
export function execOrThrow(command: string, cwd?: string): string {
  const result = exec(command, cwd);
  if (!result.success) {
    throw new Error(`Command failed: ${command}`);
  }
  return result.stdout;
}
```

**Step 2: Create `src/server/git/scanner.ts`**

```typescript
import fs from 'node:fs';
import path from 'node:path';
import { exec, execOrThrow } from '../utils/exec.js';

// --- Types ---

export interface RepoScanResult {
  path: string;
  name: string;
  languages: string[];
  branches: string[];
  currentBranch: string;
  existingFiles: Record<string, boolean>;
}

// --- Extension-to-Language Map ---

const EXTENSION_MAP: Record<string, string> = {
  '.ts': 'TypeScript',
  '.tsx': 'TypeScript',
  '.js': 'JavaScript',
  '.jsx': 'JavaScript',
  '.py': 'Python',
  '.rs': 'Rust',
  '.go': 'Go',
  '.java': 'Java',
  '.kt': 'Kotlin',
  '.swift': 'Swift',
  '.rb': 'Ruby',
  '.php': 'PHP',
  '.cs': 'C#',
  '.cpp': 'C++',
  '.c': 'C',
  '.h': 'C',
  '.hpp': 'C++',
  '.css': 'CSS',
  '.scss': 'SCSS',
  '.html': 'HTML',
  '.vue': 'Vue',
  '.svelte': 'Svelte',
  '.dart': 'Dart',
  '.ex': 'Elixir',
  '.exs': 'Elixir',
  '.zig': 'Zig',
  '.lua': 'Lua',
  '.sh': 'Shell',
  '.bash': 'Shell',
  '.sql': 'SQL',
  '.md': 'Markdown',
  '.json': 'JSON',
  '.yaml': 'YAML',
  '.yml': 'YAML',
  '.toml': 'TOML',
};

// Files to check for existing AI context
const CONTEXT_FILES = [
  'CLAUDE.md',
  '.cursorrules',
  '.windsurfrules',
  'AGENTS.md',
  'LESSONS.md',
  '.vibelint',
  'vdocs',
];

// --- Main Scanner ---

export async function scanRepo(repoPath: string): Promise<RepoScanResult> {
  const absolutePath = path.resolve(repoPath);

  // 1. Validate path exists
  if (!fs.existsSync(absolutePath)) {
    throw new Error(`Path does not exist: ${absolutePath}`);
  }

  // 2. Validate it's a git repo
  const gitDir = path.join(absolutePath, '.git');
  if (!fs.existsSync(gitDir)) {
    throw new Error(`Not a git repository (no .git directory): ${absolutePath}`);
  }

  // 3. Get repo name from directory name
  const name = path.basename(absolutePath);

  // 4. Detect languages by walking files (first 2000)
  const languages = detectLanguages(absolutePath);

  // 5. List branches
  const branches = listBranches(absolutePath);

  // 6. Get current branch
  const currentBranch = getCurrentBranch(absolutePath);

  // 7. Check existing files
  const existingFiles = checkExistingFiles(absolutePath);

  return {
    path: absolutePath,
    name,
    languages,
    branches,
    currentBranch,
    existingFiles,
  };
}

// --- Helper Functions ---

function detectLanguages(repoPath: string): string[] {
  const languageSet = new Set<string>();
  let fileCount = 0;
  const MAX_FILES = 2000;

  // Directories to skip
  const SKIP_DIRS = new Set([
    'node_modules', '.git', 'dist', 'build', 'target',
    '.next', '__pycache__', 'vendor', '.venv', 'venv',
  ]);

  function walk(dir: string): void {
    if (fileCount >= MAX_FILES) return;

    let entries: fs.Dirent[];
    try {
      entries = fs.readdirSync(dir, { withFileTypes: true });
    } catch {
      return; // Skip unreadable directories
    }

    for (const entry of entries) {
      if (fileCount >= MAX_FILES) return;

      if (entry.isDirectory()) {
        if (!SKIP_DIRS.has(entry.name) && !entry.name.startsWith('.')) {
          walk(path.join(dir, entry.name));
        }
      } else if (entry.isFile()) {
        fileCount++;
        const ext = path.extname(entry.name).toLowerCase();
        const lang = EXTENSION_MAP[ext];
        if (lang) {
          languageSet.add(lang);
        }
      }
    }
  }

  walk(repoPath);

  // Sort by name, filter out non-code languages for primary display
  const codeLangs = ['Markdown', 'JSON', 'YAML', 'TOML'];
  const primary = [...languageSet].filter((l) => !codeLangs.includes(l)).sort();
  const secondary = [...languageSet].filter((l) => codeLangs.includes(l)).sort();

  return [...primary, ...secondary];
}

function listBranches(repoPath: string): string[] {
  const result = exec('git branch -a --no-color', repoPath);
  if (!result.success) return [];

  return result.stdout
    .split('\n')
    .map((b) => b.replace(/^\*?\s+/, '').trim())
    .filter((b) => b && !b.includes('->'));
}

function getCurrentBranch(repoPath: string): string {
  const result = exec('git rev-parse --abbrev-ref HEAD', repoPath);
  return result.success ? result.stdout : 'unknown';
}

function checkExistingFiles(repoPath: string): Record<string, boolean> {
  const result: Record<string, boolean> = {};
  for (const file of CONTEXT_FILES) {
    const fullPath = path.join(repoPath, file);
    result[file] = fs.existsSync(fullPath);
  }
  return result;
}
```

### 3.3 API Contract
N/A — this is an internal module. It is consumed by the Repo CRUD API (STORY-002-03).

**Exported function signature:**
```typescript
scanRepo(repoPath: string): Promise<RepoScanResult>
```

**Return type:**
```typescript
interface RepoScanResult {
  path: string;
  name: string;
  languages: string[];         // e.g. ["TypeScript", "Python", "CSS"]
  branches: string[];          // e.g. ["main", "feature/wizard", "remotes/origin/main"]
  currentBranch: string;       // e.g. "main"
  existingFiles: Record<string, boolean>;
  // e.g. { "CLAUDE.md": true, ".cursorrules": false, ... }
}
```

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/git/scanner.ts` exists and exports `scanRepo()` and `RepoScanResult`.
- [ ] `src/server/utils/exec.ts` exists and exports `exec()` and `execOrThrow()`.
- [ ] `scanRepo()` correctly validates that the path exists and is a git repo.
- [ ] `scanRepo()` detects languages from file extensions (first 2000 files).
- [ ] `scanRepo()` lists all branches (local and remote).
- [ ] `scanRepo()` detects the current branch.
- [ ] `scanRepo()` checks for all 7 existing context files/directories.
- [ ] Error cases throw descriptive errors for non-existent paths and non-git directories.
- [ ] TypeScript compiles without errors.
