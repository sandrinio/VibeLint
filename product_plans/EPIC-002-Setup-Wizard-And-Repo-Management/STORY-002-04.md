---
id: STORY-002-04
parent_epic: EPIC-002
status: Done
actor: Backend Developer
complexity: Low (1 file)
---
# STORY-002-04: Config API

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** REST API endpoints for reading and writing application configuration, plus setup wizard status endpoints,
**So that** the frontend can persist user preferences and track whether the initial setup wizard has been completed.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/server/api/config.ts` as a Fastify route plugin.
- **Requirement 2**: `GET /api/config/:key` — get a single config value by key.
- **Requirement 3**: `PUT /api/config/:key` — set a config value. Accept `{ value: string }` in the body.
- **Requirement 4**: `GET /api/config` — get all config as a key-value object.
- **Requirement 5**: `GET /api/setup/status` — returns `{ completed: boolean, platform: string | null }` by reading the `wizard_complete` and `selected_platform` config keys.
- **Requirement 6**: `POST /api/setup/complete` — marks the wizard as complete. Accept `{ platform: string }` in the body. Stores `wizard_complete = "true"` and `selected_platform = <platform>` in the config table.
- **Requirement 7**: `GET /api/setup/platforms` — returns the platform detection results from the `detectPlatforms()` utility (STORY-002-02).
- **Requirement 8**: Register this plugin in the main Fastify server.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Config API

  Scenario: Get all config when empty
    Given the config table is empty
    When I send GET /api/config
    Then the response status is 200
    And the response body is an empty object {}

  Scenario: Set and get a config value
    When I send PUT /api/config/theme with body { "value": "dark" }
    Then the response status is 200
    When I send GET /api/config/theme
    Then the response body is { "key": "theme", "value": "dark" }

  Scenario: Get a non-existent config key
    When I send GET /api/config/nonexistent
    Then the response status is 404

  Scenario: Setup status before wizard completion
    Given the wizard has not been completed
    When I send GET /api/setup/status
    Then the response is { "completed": false, "platform": null }

  Scenario: Complete the setup wizard
    When I send POST /api/setup/complete with body { "platform": "claude-code" }
    Then the response status is 200
    When I send GET /api/setup/status
    Then the response is { "completed": true, "platform": "claude-code" }

  Scenario: Detect platforms
    When I send GET /api/setup/platforms
    Then the response status is 200
    And the response body is an array of platform detection objects
```

### 2.2 Verification Steps
- [ ] `GET /api/config` returns all stored config as a key-value object.
- [ ] `PUT /api/config/:key` stores a value and returns 200.
- [ ] `GET /api/config/:key` retrieves the stored value.
- [ ] `GET /api/config/:key` returns 404 for unknown keys.
- [ ] `GET /api/setup/status` returns `{ completed: false, platform: null }` initially.
- [ ] `POST /api/setup/complete` stores wizard state and returns 200.
- [ ] `GET /api/setup/status` returns `{ completed: true, platform: "..." }` after completion.
- [ ] `GET /api/setup/platforms` returns platform detection results.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/api/config.ts`
- **Related Files**:
  - `src/server/index.ts` (register the plugin)
  - `src/server/db/queries.ts` (STORY-001-04, provides config helpers)
  - `src/server/utils/platform-detect.ts` (STORY-002-02, provides `detectPlatforms`)
- **New Files Needed**: Yes — `src/server/api/config.ts`

### 3.2 Technical Logic

**Step 1: Create `src/server/api/config.ts`**

```typescript
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import { getConfig, setConfig, getAllConfig } from '../db/queries.js';
import { detectPlatforms } from '../utils/platform-detect.js';

export default async function configRoutes(fastify: FastifyInstance): Promise<void> {

  // GET /api/config — get all config values
  fastify.get('/api/config', async (_request: FastifyRequest, _reply: FastifyReply) => {
    return getAllConfig();
  });

  // GET /api/config/:key — get a single config value
  fastify.get('/api/config/:key', async (request: FastifyRequest, reply: FastifyReply) => {
    const { key } = request.params as { key: string };
    const value = getConfig(key);

    if (value === undefined) {
      return reply.status(404).send({ error: `Config key not found: ${key}` });
    }

    return { key, value };
  });

  // PUT /api/config/:key — set a config value
  fastify.put('/api/config/:key', async (request: FastifyRequest, reply: FastifyReply) => {
    const { key } = request.params as { key: string };
    const { value } = request.body as { value: string };

    if (value === undefined || value === null) {
      return reply.status(400).send({ error: 'Missing "value" in request body.' });
    }

    setConfig(key, String(value));
    return { key, value: String(value) };
  });

  // GET /api/setup/status — get wizard completion status
  fastify.get('/api/setup/status', async (_request: FastifyRequest, _reply: FastifyReply) => {
    const wizardComplete = getConfig('wizard_complete');
    const selectedPlatform = getConfig('selected_platform');

    return {
      completed: wizardComplete === 'true',
      platform: selectedPlatform ?? null,
    };
  });

  // POST /api/setup/complete — mark wizard as complete
  fastify.post('/api/setup/complete', async (request: FastifyRequest, reply: FastifyReply) => {
    const { platform } = request.body as { platform: string };

    if (!platform || typeof platform !== 'string') {
      return reply.status(400).send({ error: 'Missing "platform" in request body.' });
    }

    setConfig('wizard_complete', 'true');
    setConfig('selected_platform', platform);

    return {
      completed: true,
      platform,
    };
  });

  // GET /api/setup/platforms — detect installed platforms
  fastify.get('/api/setup/platforms', async (_request: FastifyRequest, _reply: FastifyReply) => {
    const platforms = detectPlatforms();
    return platforms;
  });
}
```

**Step 2: Register the plugin in `src/server/index.ts`**

Add to the `createServer()` function alongside the repos routes:

```typescript
import configRoutes from './api/config.js';

// Inside createServer():
await server.register(configRoutes);
```

The complete registration block in `createServer()` should look like:

```typescript
// API route plugins
await server.register(reposRoutes);
await server.register(configRoutes);

// Health check
server.get('/api/health', async () => {
  return { status: 'ok', version: PKG_VERSION };
});
```

**Step 3: Verify with curl**

```bash
# Get all config (empty)
curl http://localhost:3847/api/config
# {}

# Set a config value
curl -X PUT http://localhost:3847/api/config/theme \
  -H "Content-Type: application/json" \
  -d '{"value": "dark"}'
# { "key": "theme", "value": "dark" }

# Get a config value
curl http://localhost:3847/api/config/theme
# { "key": "theme", "value": "dark" }

# Check setup status
curl http://localhost:3847/api/setup/status
# { "completed": false, "platform": null }

# Complete setup
curl -X POST http://localhost:3847/api/setup/complete \
  -H "Content-Type: application/json" \
  -d '{"platform": "claude-code"}'
# { "completed": true, "platform": "claude-code" }

# Detect platforms
curl http://localhost:3847/api/setup/platforms
# [{ "name": "Claude Code", "id": "claude-code", "detected": true, ... }, ...]
```

### 3.3 API Contract

| Method | Path                     | Request Body              | Response (Success)                                    | Response (Error)         |
|--------|--------------------------|---------------------------|-------------------------------------------------------|--------------------------|
| GET    | `/api/config`            | N/A                       | `200` — `Record<string, string>`                      | N/A                      |
| GET    | `/api/config/:key`       | N/A                       | `200` — `{ key, value }`                              | `404` — key not found    |
| PUT    | `/api/config/:key`       | `{ "value": string }`    | `200` — `{ key, value }`                              | `400` — missing value    |
| GET    | `/api/setup/status`      | N/A                       | `200` — `{ completed: boolean, platform: string|null }`| N/A                      |
| POST   | `/api/setup/complete`    | `{ "platform": string }` | `200` — `{ completed: true, platform }`               | `400` — missing platform |
| GET    | `/api/setup/platforms`   | N/A                       | `200` — `PlatformDetection[]`                         | N/A                      |

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/api/config.ts` exists and exports a Fastify plugin with all 6 routes.
- [ ] Plugin is registered in `src/server/index.ts`.
- [ ] `GET /api/config` returns all config as a key-value object.
- [ ] `GET /api/config/:key` returns the value or 404.
- [ ] `PUT /api/config/:key` stores the value.
- [ ] `GET /api/setup/status` returns wizard completion status.
- [ ] `POST /api/setup/complete` stores the platform and marks wizard complete.
- [ ] `GET /api/setup/platforms` returns platform detection results.
- [ ] TypeScript compiles without errors.
