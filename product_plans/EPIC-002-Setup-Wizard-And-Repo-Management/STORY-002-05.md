---
id: STORY-002-05
parent_epic: EPIC-002
status: Draft
actor: Frontend Developer
complexity: High (4+ files)
---
# STORY-002-05: Setup Wizard UI

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Frontend Developer,
**I want** a guided 3-panel Setup Wizard that lets the user select their AI platform, connect repositories, and optionally provide an API key,
**So that** first-time users have a smooth onboarding experience and VibeLint is configured correctly from the start.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/client/pages/SetupWizard.tsx` as the main wizard page with 3 panels/steps.
- **Requirement 2**: **Panel 1 — Platform Picker**: Display radio buttons for each AI platform. Show a "Detected" badge next to platforms identified by `GET /api/setup/platforms`. User must select one platform to proceed.
- **Requirement 3**: **Panel 2 — Repo Adder**: Text input for a repository path with an "Add" button. On add, call `POST /api/repos` and display scan results (languages, branches, existing context files). Show a list of added repos with a remove button (calls `DELETE /api/repos/:id`).
- **Requirement 4**: **Panel 3 — API Key (Optional)**: Provider dropdown (Anthropic, OpenAI), key input field (masked), "Test" button (future), "Skip" and "Finish" buttons. The API key is stored via `PUT /api/config/api_key` and `PUT /api/config/api_provider`.
- **Requirement 5**: Navigation: "Next" and "Back" buttons at the bottom, plus a step indicator showing progress (step 1/3, 2/3, 3/3).
- **Requirement 6**: On "Finish": call `POST /api/setup/complete` with the selected platform, then redirect to the Dashboard (`/`).
- **Requirement 7**: Create `src/client/components/PlatformPicker.tsx` as a reusable component.
- **Requirement 8**: Create `src/client/lib/api.ts` as a thin fetch wrapper for making API calls.
- **Requirement 9**: **Persist wizard state after each panel** — After the user completes each panel, save the wizard progress to the API via `PUT /api/config/wizard_state` (JSON blob: `{ step, platform, repos, apiProvider }`). On page load, fetch the saved state and resume from the last completed panel. This prevents data loss if the browser tab is accidentally closed.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Setup Wizard UI

  Scenario: Wizard loads and shows platform picker
    Given the user navigates to /setup
    When the page loads
    Then Panel 1 (Platform Picker) is displayed
    And platform options are fetched from GET /api/setup/platforms
    And detected platforms show a "Detected" badge

  Scenario: User selects a platform and advances
    Given Panel 1 is displayed
    When the user selects "Claude Code"
    And clicks "Next"
    Then Panel 2 (Repo Adder) is displayed

  Scenario: User adds a repository
    Given Panel 2 is displayed
    When the user enters "/path/to/repo" in the path input
    And clicks "Add"
    Then POST /api/repos is called with the path
    And the scan results (languages, branches) are displayed
    And the repo appears in the connected repos list

  Scenario: User removes a repository
    Given Panel 2 shows a connected repo
    When the user clicks the remove button on that repo
    Then DELETE /api/repos/:id is called
    And the repo is removed from the list

  Scenario: User skips API key and finishes
    Given Panel 3 is displayed
    When the user clicks "Skip" or "Finish" without entering a key
    Then POST /api/setup/complete is called with the selected platform
    And the user is redirected to /

  Scenario: User provides an API key and finishes
    Given Panel 3 is displayed
    When the user selects "Anthropic" and enters an API key
    And clicks "Finish"
    Then PUT /api/config/api_provider is called with "anthropic"
    And PUT /api/config/api_key is called with the key
    And POST /api/setup/complete is called
    And the user is redirected to /

  Scenario: Step indicator reflects current panel
    Given the wizard is on Panel 2
    Then the step indicator shows step 2 of 3 as active
    And step 1 shows as completed

  Scenario: Wizard state is persisted after each panel
    Given the user has completed Panel 1 and selected "Claude Code"
    When the user clicks "Next" to advance to Panel 2
    Then wizard progress is saved to PUT /api/config/wizard_state
    And the saved state includes step 2 and platform "claude-code"

  Scenario: Wizard resumes from saved state after browser close
    Given wizard state was previously saved at step 2 with platform "claude-code"
    When the user navigates to /setup in a new browser tab
    Then the wizard loads at Panel 2
    And the platform "Claude Code" is pre-selected
    And previously added repos are shown
```

### 2.2 Verification Steps
- [ ] Navigating to `/setup` renders the wizard with Panel 1 visible.
- [ ] Platform radio buttons appear, with "Detected" badges where applicable.
- [ ] Selecting a platform enables the "Next" button.
- [ ] Panel 2 allows entering a repo path and adding it.
- [ ] Added repos display with their scan metadata (languages, branches, existing files).
- [ ] Repos can be removed from the list.
- [ ] Panel 3 has provider dropdown, key input, and Skip/Finish buttons.
- [ ] "Finish" calls `POST /api/setup/complete` and redirects to `/`.
- [ ] Step indicator updates correctly across panels.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**:
  - `src/client/pages/SetupWizard.tsx`
  - `src/client/components/PlatformPicker.tsx`
  - `src/client/lib/api.ts`
- **Related Files**:
  - `src/client/App.tsx` (route already exists from STORY-001-02)
  - API endpoints from STORY-002-03 and STORY-002-04
- **New Files Needed**: Yes — all 3 primary files, plus `src/client/components/StepIndicator.tsx` and `src/client/components/RepoAdder.tsx`

### 3.2 Technical Logic

**Step 1: Create `src/client/lib/api.ts` — API client**

```typescript
const API_BASE = '/api';

async function fetchJson<T>(url: string, options?: RequestInit): Promise<T> {
  const response = await fetch(`${API_BASE}${url}`, {
    headers: {
      'Content-Type': 'application/json',
      ...options?.headers,
    },
    ...options,
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({ error: response.statusText }));
    throw new Error(error.error || `HTTP ${response.status}`);
  }

  return response.json() as Promise<T>;
}

// --- Platform APIs ---

export interface PlatformDetection {
  name: string;
  id: string;
  detected: boolean;
  configFile: string;
  description: string;
}

export function fetchPlatforms(): Promise<PlatformDetection[]> {
  return fetchJson('/setup/platforms');
}

// --- Repo APIs ---

export interface RepoResponse {
  id: string;
  path: string;
  name: string;
  languages: string[];
  platform: string | null;
  created_at: string;
  last_scan_at: string | null;
  scan?: {
    branches: string[];
    currentBranch: string;
    existingFiles: Record<string, boolean>;
  };
}

export function fetchRepos(): Promise<RepoResponse[]> {
  return fetchJson('/repos');
}

export function addRepo(path: string): Promise<RepoResponse> {
  return fetchJson('/repos', {
    method: 'POST',
    body: JSON.stringify({ path }),
  });
}

export function removeRepo(id: string): Promise<void> {
  return fetchJson(`/repos/${id}`, { method: 'DELETE' });
}

// --- Config / Setup APIs ---

export interface SetupStatus {
  completed: boolean;
  platform: string | null;
}

export function fetchSetupStatus(): Promise<SetupStatus> {
  return fetchJson('/setup/status');
}

export function completeSetup(platform: string): Promise<SetupStatus> {
  return fetchJson('/setup/complete', {
    method: 'POST',
    body: JSON.stringify({ platform }),
  });
}

export function setConfigValue(key: string, value: string): Promise<void> {
  return fetchJson(`/config/${key}`, {
    method: 'PUT',
    body: JSON.stringify({ value }),
  });
}

export async function fetchConfigValue(key: string): Promise<string | null> {
  try {
    const result = await fetchJson<{ value: string }>(`/config/${key}`);
    return result.value;
  } catch {
    return null;
  }
}
```

**Step 2: Create `src/client/components/StepIndicator.tsx`**

```tsx
import React from 'react';

interface StepIndicatorProps {
  currentStep: number;
  totalSteps: number;
  labels: string[];
}

export default function StepIndicator({ currentStep, totalSteps, labels }: StepIndicatorProps) {
  return (
    <div className="flex items-center justify-center mb-8">
      {Array.from({ length: totalSteps }, (_, i) => {
        const step = i + 1;
        const isActive = step === currentStep;
        const isCompleted = step < currentStep;

        return (
          <React.Fragment key={step}>
            {i > 0 && (
              <div
                className={`h-0.5 w-16 mx-2 ${
                  isCompleted ? 'bg-brand-500' : 'bg-gray-300'
                }`}
              />
            )}
            <div className="flex flex-col items-center">
              <div
                className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                  isActive
                    ? 'bg-brand-500 text-white'
                    : isCompleted
                      ? 'bg-brand-500 text-white'
                      : 'bg-gray-300 text-gray-600'
                }`}
              >
                {isCompleted ? '\u2713' : step}
              </div>
              <span className="text-xs mt-1 text-gray-500">{labels[i]}</span>
            </div>
          </React.Fragment>
        );
      })}
    </div>
  );
}
```

**Step 3: Create `src/client/components/PlatformPicker.tsx`**

```tsx
import React from 'react';
import type { PlatformDetection } from '../lib/api';

interface PlatformPickerProps {
  platforms: PlatformDetection[];
  selected: string | null;
  onSelect: (platformId: string) => void;
  loading?: boolean;
}

export default function PlatformPicker({
  platforms,
  selected,
  onSelect,
  loading,
}: PlatformPickerProps) {
  if (loading) {
    return <div className="text-gray-500">Detecting installed platforms...</div>;
  }

  return (
    <div className="space-y-3">
      <h2 className="text-lg font-semibold mb-4">Select Your AI Platform</h2>
      <p className="text-gray-500 mb-4">
        Choose the primary AI coding assistant you use. VibeLint will generate
        context files optimized for this platform.
      </p>
      {platforms.map((platform) => (
        <label
          key={platform.id}
          className={`flex items-center p-4 border rounded-lg cursor-pointer transition-colors ${
            selected === platform.id
              ? 'border-brand-500 bg-brand-50'
              : 'border-gray-200 hover:border-gray-300'
          }`}
        >
          <input
            type="radio"
            name="platform"
            value={platform.id}
            checked={selected === platform.id}
            onChange={() => onSelect(platform.id)}
            className="mr-3"
          />
          <div className="flex-1">
            <div className="flex items-center gap-2">
              <span className="font-medium">{platform.name}</span>
              {platform.detected && (
                <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                  Detected
                </span>
              )}
            </div>
            <p className="text-sm text-gray-500">{platform.description}</p>
            <p className="text-xs text-gray-400 mt-1">Config file: {platform.configFile}</p>
          </div>
        </label>
      ))}
      {/* "Other" option */}
      <label
        className={`flex items-center p-4 border rounded-lg cursor-pointer transition-colors ${
          selected === 'other'
            ? 'border-brand-500 bg-brand-50'
            : 'border-gray-200 hover:border-gray-300'
        }`}
      >
        <input
          type="radio"
          name="platform"
          value="other"
          checked={selected === 'other'}
          onChange={() => onSelect('other')}
          className="mr-3"
        />
        <div>
          <span className="font-medium">Other / Generic</span>
          <p className="text-sm text-gray-500">Generate generic context files</p>
        </div>
      </label>
    </div>
  );
}
```

**Step 4: Create `src/client/pages/SetupWizard.tsx`**

```tsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import StepIndicator from '../components/StepIndicator';
import PlatformPicker from '../components/PlatformPicker';
import {
  fetchPlatforms,
  addRepo,
  removeRepo,
  fetchRepos,
  completeSetup,
  setConfigValue,
  fetchConfigValue,
  type PlatformDetection,
  type RepoResponse,
} from '../lib/api';

const STEP_LABELS = ['Platform', 'Repositories', 'API Key'];

export default function SetupWizard() {
  const navigate = useNavigate();
  const [step, setStep] = useState(1);

  // Panel 1 state
  const [platforms, setPlatforms] = useState<PlatformDetection[]>([]);
  const [platformsLoading, setPlatformsLoading] = useState(true);
  const [selectedPlatform, setSelectedPlatform] = useState<string | null>(null);

  // Panel 2 state
  const [repos, setRepos] = useState<RepoResponse[]>([]);
  const [repoPath, setRepoPath] = useState('');
  const [repoError, setRepoError] = useState<string | null>(null);
  const [repoLoading, setRepoLoading] = useState(false);

  // Panel 3 state
  const [apiProvider, setApiProvider] = useState('anthropic');
  const [apiKey, setApiKey] = useState('');

  // Load platforms and restore saved wizard state on mount
  useEffect(() => {
    fetchPlatforms()
      .then(setPlatforms)
      .finally(() => setPlatformsLoading(false));
    fetchRepos().then(setRepos);

    // Restore wizard state if previously saved
    fetchConfigValue('wizard_state').then((savedState) => {
      if (savedState) {
        try {
          const state = JSON.parse(savedState);
          if (state.step) setStep(state.step);
          if (state.platform) setSelectedPlatform(state.platform);
          if (state.apiProvider) setApiProvider(state.apiProvider);
        } catch {
          // Ignore malformed state
        }
      }
    });
  }, []);

  // Persist wizard state after each panel change
  useEffect(() => {
    const state = JSON.stringify({
      step,
      platform: selectedPlatform,
      apiProvider,
    });
    setConfigValue('wizard_state', state).catch(() => {
      // Best-effort persistence; don't block navigation
    });
  }, [step, selectedPlatform, apiProvider]);

  // --- Panel 2 handlers ---
  const handleAddRepo = async () => {
    if (!repoPath.trim()) return;
    setRepoError(null);
    setRepoLoading(true);
    try {
      const repo = await addRepo(repoPath.trim());
      setRepos((prev) => [...prev, repo]);
      setRepoPath('');
    } catch (err) {
      setRepoError(err instanceof Error ? err.message : 'Failed to add repository.');
    } finally {
      setRepoLoading(false);
    }
  };

  const handleRemoveRepo = async (id: string) => {
    try {
      await removeRepo(id);
      setRepos((prev) => prev.filter((r) => r.id !== id));
    } catch {
      // silently fail for now
    }
  };

  // --- Finish handler ---
  const handleFinish = async () => {
    if (!selectedPlatform) return;

    // Store API key if provided
    if (apiKey.trim()) {
      await setConfigValue('api_provider', apiProvider);
      await setConfigValue('api_key', apiKey.trim());
    }

    await completeSetup(selectedPlatform);
    navigate('/');
  };

  return (
    <div className="max-w-2xl mx-auto py-12 px-4">
      <h1 className="text-3xl font-bold text-center mb-2">Welcome to VibeLint</h1>
      <p className="text-gray-500 text-center mb-8">
        Let us set up your AI coding context in a few steps.
      </p>

      <StepIndicator currentStep={step} totalSteps={3} labels={STEP_LABELS} />

      {/* Panel 1: Platform Picker */}
      {step === 1 && (
        <PlatformPicker
          platforms={platforms}
          selected={selectedPlatform}
          onSelect={setSelectedPlatform}
          loading={platformsLoading}
        />
      )}

      {/* Panel 2: Repo Adder */}
      {step === 2 && (
        <div>
          <h2 className="text-lg font-semibold mb-4">Connect Repositories</h2>
          <div className="flex gap-2 mb-4">
            <input
              type="text"
              value={repoPath}
              onChange={(e) => setRepoPath(e.target.value)}
              placeholder="/path/to/your/repo"
              className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm"
              onKeyDown={(e) => e.key === 'Enter' && handleAddRepo()}
            />
            <button
              onClick={handleAddRepo}
              disabled={repoLoading || !repoPath.trim()}
              className="bg-brand-500 text-white px-4 py-2 rounded text-sm hover:bg-brand-600 disabled:opacity-50"
            >
              {repoLoading ? 'Adding...' : 'Add'}
            </button>
          </div>
          {repoError && (
            <p className="text-red-500 text-sm mb-4">{repoError}</p>
          )}

          {/* Repo list */}
          <div className="space-y-3">
            {repos.map((repo) => (
              <div key={repo.id} className="border rounded-lg p-4">
                <div className="flex items-start justify-between">
                  <div>
                    <h3 className="font-medium">{repo.name}</h3>
                    <p className="text-xs text-gray-400">{repo.path}</p>
                    <div className="flex flex-wrap gap-1 mt-2">
                      {repo.languages.map((lang) => (
                        <span
                          key={lang}
                          className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded"
                        >
                          {lang}
                        </span>
                      ))}
                    </div>
                  </div>
                  <button
                    onClick={() => handleRemoveRepo(repo.id)}
                    className="text-gray-400 hover:text-red-500 text-sm"
                  >
                    Remove
                  </button>
                </div>
              </div>
            ))}
            {repos.length === 0 && (
              <p className="text-gray-400 text-sm text-center py-8">
                No repositories connected yet. Enter a path above to add one.
              </p>
            )}
          </div>
        </div>
      )}

      {/* Panel 3: API Key */}
      {step === 3 && (
        <div>
          <h2 className="text-lg font-semibold mb-4">API Key (Optional)</h2>
          <p className="text-gray-500 text-sm mb-4">
            Optionally provide an API key for AI-powered analysis features.
            You can skip this step and add it later in Settings.
          </p>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-1">Provider</label>
              <select
                value={apiProvider}
                onChange={(e) => setApiProvider(e.target.value)}
                className="border border-gray-300 rounded px-3 py-2 text-sm w-full"
              >
                <option value="anthropic">Anthropic</option>
                <option value="openai">OpenAI</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">API Key</label>
              <input
                type="password"
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                placeholder="sk-..."
                className="border border-gray-300 rounded px-3 py-2 text-sm w-full"
              />
            </div>
          </div>
        </div>
      )}

      {/* Navigation Buttons */}
      <div className="flex justify-between mt-8">
        <button
          onClick={() => setStep((s) => Math.max(1, s - 1))}
          disabled={step === 1}
          className="px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-30"
        >
          Back
        </button>
        <div className="flex gap-2">
          {step === 3 && (
            <button
              onClick={handleFinish}
              className="px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded hover:bg-gray-50"
            >
              Skip
            </button>
          )}
          {step < 3 ? (
            <button
              onClick={() => setStep((s) => Math.min(3, s + 1))}
              disabled={step === 1 && !selectedPlatform}
              className="bg-brand-500 text-white px-6 py-2 rounded text-sm hover:bg-brand-600 disabled:opacity-50"
            >
              Next
            </button>
          ) : (
            <button
              onClick={handleFinish}
              className="bg-brand-500 text-white px-6 py-2 rounded text-sm hover:bg-brand-600"
            >
              Finish
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
```

**Step 5: Update `src/client/App.tsx` route**

Replace the placeholder `SetupWizard` import with the real component:

```tsx
import SetupWizard from './pages/SetupWizard';
// ... in Routes:
<Route path="/setup" element={<SetupWizard />} />
```

### 3.3 API Contract

This story consumes the following API endpoints (defined in STORY-002-03 and STORY-002-04):

| Method | Path                     | Purpose                         |
|--------|--------------------------|---------------------------------|
| GET    | `/api/setup/platforms`   | Fetch platform detection data   |
| GET    | `/api/repos`             | List connected repos            |
| POST   | `/api/repos`             | Add a new repo                  |
| DELETE | `/api/repos/:id`         | Remove a repo                   |
| PUT    | `/api/config/:key`       | Store API key and provider      |
| POST   | `/api/setup/complete`    | Mark wizard as complete         |

---

## 4. Definition of Done (The Gate)
- [ ] `src/client/pages/SetupWizard.tsx` renders a 3-panel wizard.
- [ ] `src/client/components/PlatformPicker.tsx` renders radio buttons with "Detected" badges.
- [ ] `src/client/components/StepIndicator.tsx` renders a step progress indicator.
- [ ] `src/client/lib/api.ts` provides typed fetch wrappers for all consumed endpoints, including `fetchConfigValue`.
- [ ] Panel 1 fetches platforms and allows selection.
- [ ] Panel 2 allows adding/removing repos with scan result display.
- [ ] Panel 3 allows optional API key entry with Skip/Finish buttons.
- [ ] "Finish" calls `POST /api/setup/complete` and redirects to `/`.
- [ ] Step indicator correctly reflects the current panel.
- [ ] All panels navigate correctly with Next/Back buttons.
- [ ] **Wizard state is persisted** to the API after each panel change (step, platform, apiProvider).
- [ ] **Wizard resumes from saved state** on page load — if the user closes and reopens the browser, they return to their last completed panel.
- [ ] No TypeScript or React compilation errors.
