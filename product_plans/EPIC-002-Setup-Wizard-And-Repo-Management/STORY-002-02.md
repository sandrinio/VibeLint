---
id: STORY-002-02
parent_epic: EPIC-002
status: Draft
actor: Backend Developer
complexity: Low (1 file)
---
# STORY-002-02: Platform Detection

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a platform detection utility that identifies which AI coding assistants are installed on the developer's machine,
**So that** the Setup Wizard can show "Detected" badges and the injection system knows which platform formats to target.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/server/utils/platform-detect.ts` with a `detectPlatforms()` function.
- **Requirement 2**: Detect the following platforms:
  - **Claude Code**: check for `claude` CLI in PATH
  - **Cursor**: check for `cursor` CLI in PATH or `~/.cursor/` directory
  - **Windsurf**: check for `windsurf` CLI in PATH
  - **Gemini CLI**: check for `gemini` CLI in PATH
  - **Antigravity**: check for `antigravity` or `ag` CLI in PATH
- **Requirement 3**: Use `which` on macOS/Linux and `where` on Windows for CLI detection.
- **Requirement 4**: Return an array of `PlatformDetection` objects with `name`, `id`, `detected` boolean, and `configFile` (the file this platform uses for rules).
- **Requirement 5**: Also expose a `GET /api/setup/platforms` endpoint that returns the detection results (registered in the config API plugin, STORY-002-04).

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Platform Detection

  Scenario: Detect installed platforms
    Given the developer's machine has Claude Code installed
    When detectPlatforms() is called
    Then the result includes { id: "claude-code", detected: true }
    And the result includes entries for all supported platforms

  Scenario: No platforms installed
    Given no AI coding tools are in the PATH
    When detectPlatforms() is called
    Then all entries have detected: false

  Scenario: Cursor detected via directory
    Given ~/.cursor/ directory exists
    And the cursor CLI is not in PATH
    When detectPlatforms() is called
    Then the entry for "cursor" has detected: true

  Scenario: Platform detection returns consistent shape
    Given detectPlatforms() is called
    Then the result is an array of 5+ objects
    And each object has name (string), id (string), detected (boolean)

  Scenario: Cross-platform command detection
    Given the OS is macOS
    When checking for a CLI tool
    Then the "which" command is used (not "where")
```

### 2.2 Verification Steps
- [ ] `detectPlatforms()` returns an array with entries for all supported platforms.
- [ ] Each entry has `name`, `id`, `detected`, and `configFile` fields.
- [ ] On a machine with Claude Code installed, the `claude-code` entry has `detected: true`.
- [ ] On a machine without Windsurf, the `windsurf` entry has `detected: false`.
- [ ] The function does not throw on any platform detection failure (graceful fallback).

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/utils/platform-detect.ts`
- **Related Files**: `src/server/utils/exec.ts` (from STORY-002-01)
- **New Files Needed**: Yes â€” `src/server/utils/platform-detect.ts`

### 3.2 Technical Logic

**Step 1: Create `src/server/utils/platform-detect.ts`**

```typescript
import fs from 'node:fs';
import path from 'node:path';
import os from 'node:os';
import { exec } from './exec.js';

// --- Types ---

export interface PlatformDetection {
  name: string;
  id: string;
  detected: boolean;
  configFile: string;       // The file this platform reads for rules/context
  description: string;
}

// --- Platform Definitions ---

interface PlatformDef {
  name: string;
  id: string;
  configFile: string;
  description: string;
  cliNames: string[];           // CLI commands to check in PATH
  directoryPaths: string[];     // Directories to check existence of
}

const PLATFORMS: PlatformDef[] = [
  {
    name: 'Claude Code',
    id: 'claude-code',
    configFile: 'CLAUDE.md',
    description: 'Anthropic Claude Code CLI agent',
    cliNames: ['claude'],
    directoryPaths: [],
  },
  {
    name: 'Cursor',
    id: 'cursor',
    configFile: '.cursorrules',
    description: 'Cursor AI-powered code editor',
    cliNames: ['cursor'],
    directoryPaths: [path.join(os.homedir(), '.cursor')],
  },
  {
    name: 'Windsurf',
    id: 'windsurf',
    configFile: '.windsurfrules',
    description: 'Windsurf AI code editor',
    cliNames: ['windsurf'],
    directoryPaths: [],
  },
  {
    name: 'Gemini CLI',
    id: 'gemini-cli',
    configFile: 'GEMINI.md',
    description: 'Google Gemini CLI agent',
    cliNames: ['gemini'],
    directoryPaths: [],
  },
  {
    name: 'Antigravity',
    id: 'antigravity',
    configFile: 'AGENTS.md',
    description: 'Antigravity AI coding assistant',
    cliNames: ['antigravity', 'ag'],
    directoryPaths: [],
  },
];

// --- Detection Logic ---

/**
 * Check if a CLI tool is available in PATH.
 * Uses `which` on macOS/Linux, `where` on Windows.
 */
function isCliAvailable(cliName: string): boolean {
  const command = process.platform === 'win32'
    ? `where ${cliName}`
    : `which ${cliName}`;

  const result = exec(command);
  return result.success && result.stdout.length > 0;
}

/**
 * Check if any of the given directory paths exist.
 */
function anyDirectoryExists(paths: string[]): boolean {
  return paths.some((p) => {
    try {
      return fs.existsSync(p) && fs.statSync(p).isDirectory();
    } catch {
      return false;
    }
  });
}

/**
 * Detect which AI coding platforms are installed on this machine.
 */
export function detectPlatforms(): PlatformDetection[] {
  return PLATFORMS.map((platform) => {
    const cliDetected = platform.cliNames.some(isCliAvailable);
    const dirDetected = anyDirectoryExists(platform.directoryPaths);

    return {
      name: platform.name,
      id: platform.id,
      detected: cliDetected || dirDetected,
      configFile: platform.configFile,
      description: platform.description,
    };
  });
}

/**
 * Get a single platform by ID.
 */
export function getPlatformById(id: string): PlatformDef | undefined {
  return PLATFORMS.find((p) => p.id === id);
}

/**
 * Get all supported platform IDs.
 */
export function getSupportedPlatformIds(): string[] {
  return PLATFORMS.map((p) => p.id);
}
```

**Step 2: Usage example**

```typescript
import { detectPlatforms } from '../utils/platform-detect.js';

const platforms = detectPlatforms();
// [
//   { name: "Claude Code", id: "claude-code", detected: true, configFile: "CLAUDE.md", ... },
//   { name: "Cursor", id: "cursor", detected: false, configFile: ".cursorrules", ... },
//   ...
// ]
```

**Step 3: Wire up the API endpoint (done in STORY-002-04)**

The `GET /api/setup/platforms` endpoint will call `detectPlatforms()` and return the result. This wiring happens in the Config API story (STORY-002-04), not in this story. This story focuses solely on the detection logic.

### 3.3 API Contract

This story creates an internal utility module. The API endpoint is registered in STORY-002-04. For reference, the planned endpoint:

| Method | Path                   | Response (200)                    |
|--------|------------------------|-----------------------------------|
| GET    | `/api/setup/platforms` | `PlatformDetection[]` (JSON array)|

**Response example:**
```json
[
  {
    "name": "Claude Code",
    "id": "claude-code",
    "detected": true,
    "configFile": "CLAUDE.md",
    "description": "Anthropic Claude Code CLI agent"
  },
  {
    "name": "Cursor",
    "id": "cursor",
    "detected": false,
    "configFile": ".cursorrules",
    "description": "Cursor AI-powered code editor"
  }
]
```

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/utils/platform-detect.ts` exists and exports `detectPlatforms()`, `getPlatformById()`, and `getSupportedPlatformIds()`.
- [ ] `PlatformDetection` type is exported.
- [ ] `detectPlatforms()` returns an array with entries for all 5 supported platforms.
- [ ] Each entry has `name`, `id`, `detected`, `configFile`, and `description` fields.
- [ ] Detection uses `which` on macOS/Linux and `where` on Windows.
- [ ] Cursor detection includes both CLI and directory-based checks.
- [ ] No exceptions are thrown during detection (all failures are caught gracefully).
- [ ] TypeScript compiles without errors.
