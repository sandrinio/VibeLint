---
id: STORY-004-02
parent_epic: EPIC-004
status: Draft
actor: Backend Developer
complexity: Medium (2-3 files)
---
# STORY-004-02: Claude Code Injector

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a Claude Code platform injector that generates the correct file structure for Claude Code repos,
**So that** when files are injected, the Claude Code agent can natively read CLAUDE.md, slash commands, skill files, and configuration.

### 1.2 Detailed Requirements
- **Requirement 1**: Implement the `PlatformInjector` interface for the `claude-code` platform.
- **Requirement 2**: Generate `CLAUDE.md` at the repo root from rules content, including a "Read and follow these skill files:" section that lists all skill file paths.
- **Requirement 3**: Generate `LESSONS.md` at the repo root from the prepared lessons content.
- **Requirement 4**: Generate `.claude/commands/review.md`, `.claude/commands/check.md`, `.claude/commands/health.md`, `.claude/commands/vdoc-init.md`, and `.claude/commands/vdoc-update.md` from prepared command content.
- **Requirement 5**: Generate `.vibelint/config.yml` from the prepared config content.
- **Requirement 6**: Generate `.vibelint/skills/*.md` — one file per skill from the prepared skills list.
- **Requirement 7**: Create `.vibelint/reports/` as an empty directory (placeholder `.gitkeep`).
- **Requirement 8**: CLAUDE.md must reference skill files by their relative paths and include a reference to LESSONS.md and the analysis report.
- **Requirement 9**: **Existing file detection** — Before writing any file, check if it already exists on disk. If `CLAUDE.md` or any other target file already exists, the `InjectionFile` entry must include `action: 'overwrite'` (not `'create'`) and `existingContent` with the current file content, so the orchestrator/UI can warn the user before overwriting.
- **Requirement 10**: **Backup before overwrite** — When overwriting an existing file, create a backup at `{filename}.vibelint-bak` (e.g., `CLAUDE.md.vibelint-bak`) before writing the new content. This allows users to recover their hand-written content.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Claude Code Injector

  Scenario: Generate full Claude Code file set
    Given prepared content with 3 skills, rules content, 5 commands, config, and lessons
    When I call generateFiles on the ClaudeCodeInjector
    Then the result contains a CLAUDE.md file at the repo root
    And the result contains a LESSONS.md file at the repo root
    And the result contains 5 files under .claude/commands/
    And the result contains a .vibelint/config.yml file
    And the result contains 3 files under .vibelint/skills/
    And the result contains a .vibelint/reports/.gitkeep file

  Scenario: CLAUDE.md references all skill files
    Given prepared content with skills "general.md", "typescript.md", "testing.md"
    When I call generateFiles on the ClaudeCodeInjector
    Then the CLAUDE.md content includes "Read and follow these skill files:"
    And the CLAUDE.md content includes ".vibelint/skills/general.md"
    And the CLAUDE.md content includes ".vibelint/skills/typescript.md"
    And the CLAUDE.md content includes ".vibelint/skills/testing.md"

  Scenario: CLAUDE.md includes LESSONS.md reference
    Given prepared content with any valid data
    When I call generateFiles on the ClaudeCodeInjector
    Then the CLAUDE.md content includes "Read LESSONS.md for project-specific lessons learned"

  Scenario: CLAUDE.md includes analysis report reference
    Given prepared content with any valid data
    When I call generateFiles on the ClaudeCodeInjector
    Then the CLAUDE.md content includes ".vibelint/reports/latest.md"

  Scenario: No skills provided
    Given prepared content with an empty skills array
    When I call generateFiles on the ClaudeCodeInjector
    Then the CLAUDE.md does not include a "Read and follow these skill files:" section
    And no files are generated under .vibelint/skills/

  Scenario: Existing CLAUDE.md is detected before overwrite
    Given the repo already has a hand-written CLAUDE.md
    When I call generateFiles on the ClaudeCodeInjector with repoPath
    Then the CLAUDE.md entry has action "overwrite" (not "create")
    And the entry includes the existing file content for comparison

  Scenario: Backup is created before overwriting existing file
    Given the repo has an existing CLAUDE.md
    When the orchestrator writes the generated CLAUDE.md
    Then a backup file CLAUDE.md.vibelint-bak is created with the original content
    And the new CLAUDE.md contains the VibeLint-generated content
```

### 2.2 Verification Steps
- [ ] `generateFiles` returns the correct number of `InjectionFile` entries.
- [ ] CLAUDE.md content includes the rules body, skill file references, LESSONS.md reference, and report reference.
- [ ] Each command file appears at `.claude/commands/{name}.md`.
- [ ] Each skill file appears at `.vibelint/skills/{filename}`.
- [ ] `.vibelint/config.yml` content matches the prepared config content.
- [ ] `.vibelint/reports/.gitkeep` is an empty string content entry.
- [ ] All `relativePath` values use forward slashes and are relative to repo root.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/injector/platforms/claude-code.ts`
- **Related Files**: `src/server/injector/types.ts` (PlatformInjector, PreparedContent, InjectionFile)
- **New Files Needed**:
  - `src/server/injector/platforms/claude-code.ts`

### 3.2 Technical Logic

**Step 1: Implement the ClaudeCodeInjector class**

```typescript
import type {
  PlatformInjector,
  PreparedContent,
  InjectionFile,
} from '../types.js';
import fs from 'node:fs';
import path from 'node:path';

export class ClaudeCodeInjector implements PlatformInjector {
  platform = 'claude-code';

  generateFiles(content: PreparedContent, repoPath?: string): InjectionFile[] {
    const files: InjectionFile[] = [];

    // 1. Generate CLAUDE.md
    files.push({
      relativePath: 'CLAUDE.md',
      content: this.buildClaudeMd(content),
      action: 'create', // action is recalculated by orchestrator
    });

    // 2. Generate LESSONS.md
    files.push({
      relativePath: 'LESSONS.md',
      content: content.lessonsContent,
      action: 'create',
    });

    // 3. Generate command files under .claude/commands/
    for (const cmd of content.commands) {
      files.push({
        relativePath: `.claude/commands/${cmd.filename}`,
        content: cmd.content,
        action: 'create',
      });
    }

    // 4. Generate .vibelint/config.yml
    files.push({
      relativePath: '.vibelint/config.yml',
      content: content.configContent,
      action: 'create',
    });

    // 5. Generate skill files under .vibelint/skills/
    for (const skill of content.skills) {
      files.push({
        relativePath: `.vibelint/skills/${skill.filename}`,
        content: skill.content,
        action: 'create',
      });
    }

    // 6. Create .vibelint/reports/ placeholder
    files.push({
      relativePath: '.vibelint/reports/.gitkeep',
      content: '',
      action: 'create',
    });

    // 7. Detect existing files and mark as overwrite (if repoPath provided)
    if (repoPath) {
      for (const file of files) {
        const fullPath = path.join(repoPath, file.relativePath);
        if (fs.existsSync(fullPath)) {
          file.action = 'overwrite';
          file.existingContent = fs.readFileSync(fullPath, 'utf-8');
        }
      }
    }

    return files;
  }

  /**
   * Build the CLAUDE.md content by combining rules content
   * with auto-generated skill file references.
   */
  private buildClaudeMd(content: PreparedContent): string {
    const sections: string[] = [];

    // Main rules content
    sections.push(content.rulesContent);

    // Skill file references
    if (content.skills.length > 0) {
      sections.push('');
      sections.push('Read and follow these skill files:');
      for (const skill of content.skills) {
        sections.push(`- .vibelint/skills/${skill.filename}`);
      }
    }

    // LESSONS.md reference
    sections.push('');
    sections.push(
      'Read LESSONS.md for project-specific lessons learned.'
    );

    // Analysis report reference
    sections.push('');
    sections.push(
      'When doing code review, read .vibelint/reports/latest.md for analysis data.'
    );

    return sections.join('\n') + '\n';
  }
}
```

**Step 2: Verify the generated file structure matches the PRD**

The PRD specifies the following Claude Code layout:
```
repo/
├── CLAUDE.md
├── LESSONS.md
├── .claude/
│   └── commands/
│       ├── review.md
│       ├── check.md
│       ├── health.md
│       ├── vdoc-init.md
│       └── vdoc-update.md
├── .vibelint/
│   ├── config.yml
│   ├── skills/
│   │   ├── general.md
│   │   ├── typescript.md
│   │   ├── error-handling.md
│   │   └── testing.md
│   └── reports/
└── .gitignore
```

The `ClaudeCodeInjector.generateFiles()` output must produce exactly this structure. The `.gitignore` update is handled separately by the orchestrator (STORY-004-05).

**Step 3: Register in the platform injectors map**

In `src/server/injector/index.ts`, the orchestrator imports and registers this injector:

```typescript
import { ClaudeCodeInjector } from './platforms/claude-code.js';

const platformInjectors: Record<string, PlatformInjector> = {
  'claude-code': new ClaudeCodeInjector(),
  // ...other platforms
};
```

### 3.3 API Contract
N/A — this is an internal module. The API routes are covered in STORY-004-06.

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/injector/platforms/claude-code.ts` exports `ClaudeCodeInjector` implementing `PlatformInjector`.
- [ ] `generateFiles` returns `InjectionFile[]` containing CLAUDE.md, LESSONS.md, all commands, config.yml, all skills, and reports/.gitkeep.
- [ ] CLAUDE.md includes the rules content body, skill file path references, LESSONS.md reference, and analysis report reference.
- [ ] When no skills are provided, the skill file references section is omitted from CLAUDE.md.
- [ ] **Existing files are detected**: when `repoPath` is provided, files that already exist on disk are marked with `action: 'overwrite'` and include `existingContent`.
- [ ] **Backups are created**: when the orchestrator writes a file marked as `overwrite`, it first creates a `.vibelint-bak` backup.
- [ ] All relative paths use forward slashes and match the PRD file structure.
- [ ] TypeScript compiles with no errors (`npx tsc --noEmit`).
