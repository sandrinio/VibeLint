---
id: STORY-004-04
parent_epic: EPIC-004
status: Draft
actor: Backend Developer
complexity: Medium (2-3 files)
---
# STORY-004-04: Windsurf & Generic Injectors

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** Windsurf and Generic platform injectors that generate the correct file structures for their respective platforms,
**So that** Windsurf users get `.windsurfrules` and `.windsurf/rules/`, and users of other AI tools (Gemini CLI, Antigravity, etc.) get `AGENTS.md` with prompt templates for manual use.

### 1.2 Detailed Requirements
- **Requirement 1**: Implement the `PlatformInjector` interface for `windsurf` — generates `.windsurfrules`, `.windsurf/rules/vibelint.md`, `LESSONS.md`, `.vibelint/config.yml`, `.vibelint/skills/*.md`, `.vibelint/reports/` placeholder.
- **Requirement 2**: `.windsurfrules` should include the rules content with skill file references.
- **Requirement 3**: `.windsurf/rules/vibelint.md` should contain the full rules and skill content for Windsurf's rules system.
- **Requirement 4**: Implement the `PlatformInjector` interface for `generic` — generates `AGENTS.md`, `LESSONS.md`, `.vibelint/config.yml`, `.vibelint/skills/*.md`, `.vibelint/reports/` placeholder, and `.vibelint/prompts/` (prompt templates for manual copy-paste).
- **Requirement 5**: `AGENTS.md` should be a universal agent rules file with skill references and instructions.
- **Requirement 6**: `.vibelint/prompts/` should contain prompt template files (e.g. `review-prompt.md`, `check-prompt.md`) that users can manually paste into their AI tool.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Windsurf Injector

  Scenario: Generate full Windsurf file set
    Given prepared content with 2 skills, rules content, config, and lessons
    When I call generateFiles on the WindsurfInjector
    Then the result contains .windsurfrules at the repo root
    And the result contains LESSONS.md at the repo root
    And the result contains .windsurf/rules/vibelint.md
    And the result contains .vibelint/config.yml
    And the result contains 2 files under .vibelint/skills/
    And the result contains .vibelint/reports/.gitkeep

  Scenario: .windsurfrules references skill files
    Given prepared content with skills "general.md" and "python.md"
    When I call generateFiles on the WindsurfInjector
    Then .windsurfrules includes ".vibelint/skills/general.md"
    And .windsurfrules includes ".vibelint/skills/python.md"

Feature: Generic Injector

  Scenario: Generate full Generic file set
    Given prepared content with 2 skills, rules, commands, config, and lessons
    When I call generateFiles on the GenericInjector
    Then the result contains AGENTS.md at the repo root
    And the result contains LESSONS.md at the repo root
    And the result contains .vibelint/config.yml
    And the result contains 2 files under .vibelint/skills/
    And the result contains .vibelint/reports/.gitkeep
    And the result contains prompt templates under .vibelint/prompts/

  Scenario: AGENTS.md is a universal rules file
    Given prepared content with rules and skills
    When I call generateFiles on the GenericInjector
    Then AGENTS.md includes the rules content
    And AGENTS.md includes skill file references
    And AGENTS.md includes a note about manual prompt usage

  Scenario: Prompt templates are generated from commands
    Given prepared content with commands "review.md" and "check.md"
    When I call generateFiles on the GenericInjector
    Then .vibelint/prompts/review-prompt.md exists
    And .vibelint/prompts/check-prompt.md exists
    And each prompt file contains instructions for manual copy-paste
```

### 2.2 Verification Steps
- [ ] `WindsurfInjector.generateFiles` returns the correct Windsurf file set.
- [ ] `GenericInjector.generateFiles` returns AGENTS.md, prompts, and .vibelint/ files.
- [ ] `.windsurfrules` content references skills and includes rules.
- [ ] `.windsurf/rules/vibelint.md` contains detailed rules and skill content.
- [ ] `AGENTS.md` is a platform-agnostic rules file.
- [ ] Prompt templates under `.vibelint/prompts/` are usable for manual copy-paste.
- [ ] Both injectors create `.vibelint/reports/.gitkeep`.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/injector/platforms/windsurf.ts`, `src/server/injector/platforms/generic.ts`
- **Related Files**: `src/server/injector/types.ts` (PlatformInjector, PreparedContent, InjectionFile)
- **New Files Needed**:
  - `src/server/injector/platforms/windsurf.ts`
  - `src/server/injector/platforms/generic.ts`

### 3.2 Technical Logic

**Step 1: Implement WindsurfInjector in `src/server/injector/platforms/windsurf.ts`**

```typescript
import type {
  PlatformInjector,
  PreparedContent,
  InjectionFile,
} from '../types.js';

export class WindsurfInjector implements PlatformInjector {
  platform = 'windsurf';

  generateFiles(content: PreparedContent): InjectionFile[] {
    const files: InjectionFile[] = [];

    // 1. Generate .windsurfrules
    files.push({
      relativePath: '.windsurfrules',
      content: this.buildWindsurfRules(content),
      action: 'create',
    });

    // 2. Generate LESSONS.md
    files.push({
      relativePath: 'LESSONS.md',
      content: content.lessonsContent,
      action: 'create',
    });

    // 3. Generate .windsurf/rules/vibelint.md
    files.push({
      relativePath: '.windsurf/rules/vibelint.md',
      content: this.buildVibelintRules(content),
      action: 'create',
    });

    // 4. Generate .vibelint/config.yml
    files.push({
      relativePath: '.vibelint/config.yml',
      content: content.configContent,
      action: 'create',
    });

    // 5. Generate skill files
    for (const skill of content.skills) {
      files.push({
        relativePath: `.vibelint/skills/${skill.filename}`,
        content: skill.content,
        action: 'create',
      });
    }

    // 6. Reports placeholder
    files.push({
      relativePath: '.vibelint/reports/.gitkeep',
      content: '',
      action: 'create',
    });

    return files;
  }

  private buildWindsurfRules(content: PreparedContent): string {
    const sections: string[] = [];

    sections.push(content.rulesContent);

    if (content.skills.length > 0) {
      sections.push('');
      sections.push('## Skill Files');
      sections.push(
        'Read and follow these skill files for coding standards:'
      );
      for (const skill of content.skills) {
        sections.push(`- .vibelint/skills/${skill.filename}`);
      }
    }

    sections.push('');
    sections.push(
      'Read LESSONS.md for project-specific lessons learned.'
    );

    sections.push('');
    sections.push(
      'When doing code review, read .vibelint/reports/latest.md for analysis data.'
    );

    return sections.join('\n') + '\n';
  }

  private buildVibelintRules(content: PreparedContent): string {
    const sections: string[] = [];

    sections.push('# VibeLint Project Rules');
    sections.push('');
    sections.push(content.rulesContent);

    if (content.skills.length > 0) {
      sections.push('');
      sections.push('## Coding Standards');
      sections.push('');
      for (const skill of content.skills) {
        sections.push(`### ${skill.filename.replace('.md', '')}`);
        sections.push(skill.content);
        sections.push('');
      }
    }

    sections.push('## References');
    sections.push('- Lessons learned: LESSONS.md');
    sections.push('- Analysis config: .vibelint/config.yml');
    sections.push('- Latest analysis: .vibelint/reports/latest.md');

    return sections.join('\n') + '\n';
  }
}
```

**Step 2: Implement GenericInjector in `src/server/injector/platforms/generic.ts`**

```typescript
import type {
  PlatformInjector,
  PreparedContent,
  InjectionFile,
} from '../types.js';

export class GenericInjector implements PlatformInjector {
  platform = 'generic';

  generateFiles(content: PreparedContent): InjectionFile[] {
    const files: InjectionFile[] = [];

    // 1. Generate AGENTS.md
    files.push({
      relativePath: 'AGENTS.md',
      content: this.buildAgentsMd(content),
      action: 'create',
    });

    // 2. Generate LESSONS.md
    files.push({
      relativePath: 'LESSONS.md',
      content: content.lessonsContent,
      action: 'create',
    });

    // 3. Generate .vibelint/config.yml
    files.push({
      relativePath: '.vibelint/config.yml',
      content: content.configContent,
      action: 'create',
    });

    // 4. Generate skill files
    for (const skill of content.skills) {
      files.push({
        relativePath: `.vibelint/skills/${skill.filename}`,
        content: skill.content,
        action: 'create',
      });
    }

    // 5. Reports placeholder
    files.push({
      relativePath: '.vibelint/reports/.gitkeep',
      content: '',
      action: 'create',
    });

    // 6. Generate prompt templates from commands
    for (const cmd of content.commands) {
      const promptFilename = cmd.filename.replace('.md', '-prompt.md');
      files.push({
        relativePath: `.vibelint/prompts/${promptFilename}`,
        content: this.buildPromptTemplate(cmd),
        action: 'create',
      });
    }

    return files;
  }

  private buildAgentsMd(content: PreparedContent): string {
    const sections: string[] = [];

    sections.push('# AI Agent Rules');
    sections.push('');
    sections.push(
      '> This file provides project rules for any AI coding agent.'
    );
    sections.push(
      '> Generated by VibeLint. Customize as needed.'
    );
    sections.push('');

    sections.push(content.rulesContent);

    if (content.skills.length > 0) {
      sections.push('');
      sections.push('## Skill Files');
      sections.push(
        'Read and follow these skill files for coding standards:'
      );
      for (const skill of content.skills) {
        sections.push(`- .vibelint/skills/${skill.filename}`);
      }
    }

    sections.push('');
    sections.push(
      'Read LESSONS.md for project-specific lessons learned.'
    );

    sections.push('');
    sections.push('## Prompt Templates');
    sections.push(
      'Prompt templates for common workflows are available in `.vibelint/prompts/`.'
    );
    sections.push(
      'Copy and paste these into your AI tool to run reviews, checks, etc.'
    );

    sections.push('');
    sections.push(
      'When doing code review, read .vibelint/reports/latest.md for analysis data.'
    );

    return sections.join('\n') + '\n';
  }

  /**
   * Convert a slash command into a prompt template
   * that users can manually paste into their AI tool.
   */
  private buildPromptTemplate(cmd: {
    filename: string;
    content: string;
  }): string {
    const name = cmd.filename.replace('.md', '');
    const sections: string[] = [];

    sections.push(`# Prompt: ${name}`);
    sections.push('');
    sections.push(
      '> Copy and paste this prompt into your AI coding tool.'
    );
    sections.push(
      '> This is the equivalent of a slash command for platforms that support them.'
    );
    sections.push('');
    sections.push('---');
    sections.push('');
    sections.push(cmd.content);

    return sections.join('\n') + '\n';
  }
}
```

**Step 3: Verify file structures match the PRD**

Windsurf layout:
```
repo/
├── .windsurfrules
├── LESSONS.md
├── .windsurf/
│   └── rules/
│       └── vibelint.md
├── .vibelint/
│   ├── config.yml
│   ├── skills/
│   └── reports/
└── .gitignore
```

Generic layout:
```
repo/
├── AGENTS.md
├── LESSONS.md
├── .vibelint/
│   ├── config.yml
│   ├── skills/
│   ├── reports/
│   └── prompts/
└── .gitignore
```

**Step 4: Register both injectors in `src/server/injector/index.ts`**

```typescript
import { WindsurfInjector } from './platforms/windsurf.js';
import { GenericInjector } from './platforms/generic.js';

const platformInjectors: Record<string, PlatformInjector> = {
  'windsurf': new WindsurfInjector(),
  'generic': new GenericInjector(),
  // ...others
};
```

### 3.3 API Contract
N/A — these are internal modules. The API routes are covered in STORY-004-06.

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/injector/platforms/windsurf.ts` exports `WindsurfInjector` implementing `PlatformInjector`.
- [ ] `src/server/injector/platforms/generic.ts` exports `GenericInjector` implementing `PlatformInjector`.
- [ ] `WindsurfInjector.generateFiles` returns `.windsurfrules`, `LESSONS.md`, `.windsurf/rules/vibelint.md`, `.vibelint/config.yml`, skills, and reports placeholder.
- [ ] `GenericInjector.generateFiles` returns `AGENTS.md`, `LESSONS.md`, `.vibelint/config.yml`, skills, reports placeholder, and prompt templates under `.vibelint/prompts/`.
- [ ] Prompt templates are generated from command content with copy-paste instructions.
- [ ] All relative paths use forward slashes and match the PRD file structures.
- [ ] TypeScript compiles with no errors (`npx tsc --noEmit`).
