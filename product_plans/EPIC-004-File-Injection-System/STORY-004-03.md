---
id: STORY-004-03
parent_epic: EPIC-004
status: Draft
actor: Backend Developer
complexity: Medium (2-3 files)
---
# STORY-004-03: Cursor Injector

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a Cursor platform injector that generates the correct file structure for Cursor-based repos,
**So that** when files are injected, Cursor natively reads `.cursorrules` and `.cursor/rules/` for project context.

### 1.2 Detailed Requirements
- **Requirement 1**: Implement the `PlatformInjector` interface for the `cursor` platform.
- **Requirement 2**: Generate `.cursorrules` at the repo root from rules content, including references to skill files and the vibelint config.
- **Requirement 3**: Generate `LESSONS.md` at the repo root from prepared lessons content.
- **Requirement 4**: Generate `.cursor/rules/vibelint.mdc` — a detailed rules file in MDC (Markdown Document Convention) format containing the full rules, skill summaries, and configuration references.
- **Requirement 5**: Generate `.vibelint/config.yml` from the prepared config content.
- **Requirement 6**: Generate `.vibelint/skills/*.md` — one file per skill.
- **Requirement 7**: Create `.vibelint/reports/` as an empty directory (placeholder `.gitkeep`).

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Cursor Injector

  Scenario: Generate full Cursor file set
    Given prepared content with 3 skills, rules content, config, and lessons
    When I call generateFiles on the CursorInjector
    Then the result contains a .cursorrules file at the repo root
    And the result contains a LESSONS.md file at the repo root
    And the result contains .cursor/rules/vibelint.mdc
    And the result contains .vibelint/config.yml
    And the result contains 3 files under .vibelint/skills/
    And the result contains .vibelint/reports/.gitkeep

  Scenario: .cursorrules references skill files
    Given prepared content with skills "general.md" and "typescript.md"
    When I call generateFiles on the CursorInjector
    Then .cursorrules includes references to .vibelint/skills/general.md
    And .cursorrules includes references to .vibelint/skills/typescript.md

  Scenario: vibelint.mdc uses MDC format
    Given prepared content with rules and skills
    When I call generateFiles on the CursorInjector
    Then .cursor/rules/vibelint.mdc starts with MDC frontmatter "---"
    And .cursor/rules/vibelint.mdc contains a description field
    And .cursor/rules/vibelint.mdc contains the rules content body

  Scenario: No commands for Cursor
    Given prepared content with 5 commands
    When I call generateFiles on the CursorInjector
    Then no files are generated under .cursor/commands/
    And commands are not included in the output (Cursor does not support slash commands)
```

### 2.2 Verification Steps
- [ ] `generateFiles` returns `InjectionFile[]` with `.cursorrules`, `LESSONS.md`, `vibelint.mdc`, `config.yml`, skills, and reports placeholder.
- [ ] `.cursorrules` content references skill files and VibeLint config.
- [ ] `.cursor/rules/vibelint.mdc` uses proper MDC format with frontmatter.
- [ ] Cursor does not receive command files (Cursor has no native slash command system via files).
- [ ] All relative paths use forward slashes.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/injector/platforms/cursor.ts`
- **Related Files**: `src/server/injector/types.ts` (PlatformInjector, PreparedContent, InjectionFile)
- **New Files Needed**:
  - `src/server/injector/platforms/cursor.ts`

### 3.2 Technical Logic

**Step 1: Implement the CursorInjector class**

```typescript
import type {
  PlatformInjector,
  PreparedContent,
  InjectionFile,
} from '../types.js';

export class CursorInjector implements PlatformInjector {
  platform = 'cursor';

  generateFiles(content: PreparedContent): InjectionFile[] {
    const files: InjectionFile[] = [];

    // 1. Generate .cursorrules
    files.push({
      relativePath: '.cursorrules',
      content: this.buildCursorRules(content),
      action: 'create',
    });

    // 2. Generate LESSONS.md
    files.push({
      relativePath: 'LESSONS.md',
      content: content.lessonsContent,
      action: 'create',
    });

    // 3. Generate .cursor/rules/vibelint.mdc
    files.push({
      relativePath: '.cursor/rules/vibelint.mdc',
      content: this.buildVibelintMdc(content),
      action: 'create',
    });

    // 4. Generate .vibelint/config.yml
    files.push({
      relativePath: '.vibelint/config.yml',
      content: content.configContent,
      action: 'create',
    });

    // 5. Generate skill files
    for (const skill of content.skills) {
      files.push({
        relativePath: `.vibelint/skills/${skill.filename}`,
        content: skill.content,
        action: 'create',
      });
    }

    // 6. Reports placeholder
    files.push({
      relativePath: '.vibelint/reports/.gitkeep',
      content: '',
      action: 'create',
    });

    return files;
  }

  /**
   * Build .cursorrules — a concise rules file that Cursor reads automatically.
   * References skill files and VibeLint config by path.
   */
  private buildCursorRules(content: PreparedContent): string {
    const sections: string[] = [];

    // Main rules content
    sections.push(content.rulesContent);

    // Skill file references
    if (content.skills.length > 0) {
      sections.push('');
      sections.push('## Skill Files');
      sections.push(
        'Read and follow these skill files for coding standards:'
      );
      for (const skill of content.skills) {
        sections.push(`- .vibelint/skills/${skill.filename}`);
      }
    }

    // LESSONS reference
    sections.push('');
    sections.push(
      'Read LESSONS.md for project-specific lessons learned.'
    );

    // Config reference
    sections.push('');
    sections.push(
      'Analysis thresholds are configured in .vibelint/config.yml'
    );

    // Report reference
    sections.push('');
    sections.push(
      'When doing code review, read .vibelint/reports/latest.md for analysis data.'
    );

    return sections.join('\n') + '\n';
  }

  /**
   * Build .cursor/rules/vibelint.mdc — MDC format with frontmatter.
   * MDC files in .cursor/rules/ provide detailed context to Cursor.
   */
  private buildVibelintMdc(content: PreparedContent): string {
    const sections: string[] = [];

    // MDC frontmatter
    sections.push('---');
    sections.push('description: VibeLint project rules and coding standards');
    sections.push('globs:');
    sections.push('alwaysApply: true');
    sections.push('---');
    sections.push('');

    // Full rules content
    sections.push('# VibeLint Project Rules');
    sections.push('');
    sections.push(content.rulesContent);

    // Inline skill summaries for richer context
    if (content.skills.length > 0) {
      sections.push('');
      sections.push('## Coding Standards (Skills)');
      sections.push('');
      for (const skill of content.skills) {
        sections.push(`### ${skill.filename.replace('.md', '')}`);
        sections.push(skill.content);
        sections.push('');
      }
    }

    // Config reference
    sections.push('## Configuration');
    sections.push(
      'Analysis thresholds: .vibelint/config.yml'
    );
    sections.push(
      'Analysis reports: .vibelint/reports/latest.md'
    );

    return sections.join('\n') + '\n';
  }
}
```

**Step 2: Verify the generated file structure matches the PRD**

The PRD specifies the following Cursor layout:
```
repo/
├── .cursorrules
├── LESSONS.md
├── .cursor/
│   └── rules/
│       └── vibelint.mdc
├── .vibelint/
│   ├── config.yml
│   ├── skills/
│   └── reports/
└── .gitignore
```

**Step 3: Register in the platform injectors map**

```typescript
import { CursorInjector } from './platforms/cursor.js';

const platformInjectors: Record<string, PlatformInjector> = {
  'cursor': new CursorInjector(),
  // ...
};
```

### 3.3 API Contract
N/A — this is an internal module. The API routes are covered in STORY-004-06.

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/injector/platforms/cursor.ts` exports `CursorInjector` implementing `PlatformInjector`.
- [ ] `generateFiles` returns `InjectionFile[]` containing `.cursorrules`, `LESSONS.md`, `vibelint.mdc`, `config.yml`, all skills, and `reports/.gitkeep`.
- [ ] `.cursorrules` includes skill file references, LESSONS.md reference, and report reference.
- [ ] `.cursor/rules/vibelint.mdc` uses proper MDC frontmatter format with `description`, `globs`, and `alwaysApply` fields.
- [ ] The MDC file contains the full rules content and inlined skill content for richer Cursor context.
- [ ] No command files are generated (Cursor does not support file-based slash commands).
- [ ] All relative paths use forward slashes and match the PRD file structure.
- [ ] TypeScript compiles with no errors (`npx tsc --noEmit`).
