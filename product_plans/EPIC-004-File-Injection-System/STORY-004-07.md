---
id: STORY-004-07
parent_epic: EPIC-004
status: Draft
actor: Frontend Developer
complexity: Medium (2-3 files)
---
# STORY-004-07: Inject UI (Button, Preview, Status)

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Frontend Developer,
**I want** an inject button on each repo card that opens a preview modal showing files to be written, and allows the user to confirm or cancel injection,
**So that** users can review what files will be created or overwritten before committing to the injection.

### 1.2 Detailed Requirements
- **Requirement 1**: Add an "Inject" button to each repo card on the Dashboard page.
- **Requirement 2**: Clicking the inject button fetches the preview from `GET /api/repos/:repoId/inject/preview` and opens a modal.
- **Requirement 3**: The preview modal (`InjectPreviewModal.tsx`) displays a list of files with their relative paths and `create` / `overwrite` action badges.
- **Requirement 4**: Each file in the list can be expanded to show its full content.
- **Requirement 5**: The modal has an "Inject" confirm button and a "Cancel" button.
- **Requirement 6**: On confirm, send `POST /api/repos/:repoId/inject`, show a success or error toast notification.
- **Requirement 7**: Show the last injected timestamp (`injected_at`) on each repo card when available.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Inject UI

  Scenario: Inject button appears on repo cards
    Given the Dashboard page is loaded with repos
    When I view a repo card
    Then an "Inject" button is visible on the card

  Scenario: Click inject opens preview modal
    Given a repo card with an "Inject" button
    When I click the "Inject" button
    Then a loading spinner appears while the preview loads
    And a modal opens showing the list of files to be injected

  Scenario: Preview modal shows file list with action badges
    Given the preview modal is open
    Then each file shows its relative path
    And new files display a "create" badge in green
    And existing files display an "overwrite" badge in amber/yellow

  Scenario: Expand a file to see content
    Given the preview modal is open with files listed
    When I click on a file entry
    Then the file content is shown below the file path
    And clicking again collapses the content

  Scenario: Confirm injection shows success
    Given the preview modal is open
    When I click the "Inject" confirm button
    Then a POST request is sent to /api/repos/:repoId/inject
    And the modal closes
    And a success toast notification appears with the count of files written
    And the repo card updates to show the current injected_at timestamp

  Scenario: Injection error shows error toast
    Given the preview modal is open
    And the injection POST will return an error
    When I click the "Inject" confirm button
    Then the modal closes
    And an error toast notification appears with the error message

  Scenario: Cancel closes modal without injecting
    Given the preview modal is open
    When I click the "Cancel" button
    Then the modal closes
    And no POST request is sent
    And no files are written

  Scenario: Last injected timestamp shown on repo card
    Given a repo was previously injected at "2026-02-20T14:30:00Z"
    When the Dashboard loads
    Then the repo card shows "Last injected: Feb 20, 2026" or similar formatted date
```

### 2.2 Verification Steps
- [ ] "Inject" button renders on every repo card on the Dashboard.
- [ ] Clicking "Inject" calls `GET /api/repos/:repoId/inject/preview` and opens the modal.
- [ ] Modal displays file paths with correct `create`/`overwrite` badges.
- [ ] File content is expandable/collapsible.
- [ ] "Inject" confirm button sends POST and shows success toast.
- [ ] "Cancel" button closes modal without side effects.
- [ ] `injected_at` timestamp renders on repo cards when available.
- [ ] Loading and error states are handled gracefully.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/client/pages/Dashboard.tsx` (modify), `src/client/components/InjectPreviewModal.tsx` (create)
- **Related Files**: `src/client/lib/api.ts` (add inject API functions)
- **New Files Needed**:
  - `src/client/components/InjectPreviewModal.tsx`

### 3.2 Technical Logic

**Step 1: Add API functions in `src/client/lib/api.ts`**

```typescript
import type { PreviewResponse, InjectResponse } from './types.js';

const API_BASE = '/api';

/** Fetch injection preview for a repo */
export async function fetchInjectPreview(
  repoId: string
): Promise<PreviewResponse> {
  const res = await fetch(
    `${API_BASE}/repos/${repoId}/inject/preview`
  );
  if (!res.ok) {
    const body = await res.json().catch(() => ({}));
    throw new Error(
      body.error ?? `Preview failed: ${res.status}`
    );
  }
  return res.json();
}

/** Execute injection for a repo */
export async function executeInjection(
  repoId: string
): Promise<InjectResponse> {
  const res = await fetch(
    `${API_BASE}/repos/${repoId}/inject`,
    { method: 'POST' }
  );
  if (!res.ok) {
    const body = await res.json().catch(() => ({}));
    throw new Error(
      body.error ?? `Injection failed: ${res.status}`
    );
  }
  return res.json();
}
```

**Step 2: Create `InjectPreviewModal.tsx`**

```tsx
import React, { useState } from 'react';

interface InjectionFile {
  relativePath: string;
  content: string;
  action: 'create' | 'overwrite';
}

interface InjectPreviewModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => Promise<void>;
  files: InjectionFile[];
  repoName: string;
  platform: string;
  isInjecting: boolean;
}

export function InjectPreviewModal({
  isOpen,
  onClose,
  onConfirm,
  files,
  repoName,
  platform,
  isInjecting,
}: InjectPreviewModalProps) {
  const [expandedFiles, setExpandedFiles] = useState<Set<string>>(
    new Set()
  );

  if (!isOpen) return null;

  const toggleFile = (path: string) => {
    setExpandedFiles((prev) => {
      const next = new Set(prev);
      if (next.has(path)) {
        next.delete(path);
      } else {
        next.add(path);
      }
      return next;
    });
  };

  const createCount = files.filter((f) => f.action === 'create').length;
  const overwriteCount = files.filter(
    (f) => f.action === 'overwrite'
  ).length;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
        {/* Header */}
        <div className="px-6 py-4 border-b">
          <h2 className="text-lg font-semibold">
            Inject into {repoName}
          </h2>
          <p className="text-sm text-gray-500 mt-1">
            Platform: {platform} &middot; {files.length} files
            ({createCount} new, {overwriteCount} overwrite)
          </p>
        </div>

        {/* File list */}
        <div className="flex-1 overflow-y-auto px-6 py-4">
          <ul className="space-y-2">
            {files.map((file) => (
              <li key={file.relativePath} className="border rounded">
                <button
                  onClick={() => toggleFile(file.relativePath)}
                  className="w-full flex items-center justify-between px-4 py-2 hover:bg-gray-50 text-left"
                >
                  <span className="font-mono text-sm">
                    {file.relativePath}
                  </span>
                  <span
                    className={`text-xs px-2 py-0.5 rounded-full font-medium ${
                      file.action === 'create'
                        ? 'bg-green-100 text-green-700'
                        : 'bg-amber-100 text-amber-700'
                    }`}
                  >
                    {file.action}
                  </span>
                </button>
                {expandedFiles.has(file.relativePath) && (
                  <div className="px-4 pb-3 border-t">
                    <pre className="text-xs bg-gray-50 p-3 rounded mt-2 overflow-x-auto max-h-64 overflow-y-auto whitespace-pre-wrap">
                      {file.content || '(empty file)'}
                    </pre>
                  </div>
                )}
              </li>
            ))}
          </ul>
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t flex justify-end gap-3">
          <button
            onClick={onClose}
            disabled={isInjecting}
            className="px-4 py-2 text-sm text-gray-700 border rounded hover:bg-gray-50 disabled:opacity-50"
          >
            Cancel
          </button>
          <button
            onClick={onConfirm}
            disabled={isInjecting}
            className="px-4 py-2 text-sm text-white bg-blue-600 rounded hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
          >
            {isInjecting ? (
              <>
                <span className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full" />
                Injecting...
              </>
            ) : (
              'Inject'
            )}
          </button>
        </div>
      </div>
    </div>
  );
}
```

**Step 3: Modify Dashboard.tsx to add the inject button and modal**

```tsx
// Add to imports in Dashboard.tsx
import { useState } from 'react';
import { InjectPreviewModal } from '../components/InjectPreviewModal';
import { fetchInjectPreview, executeInjection } from '../lib/api';

// Inside the repo card component:
function RepoCard({ repo, onRepoUpdated }: { repo: Repo; onRepoUpdated: () => void }) {
  const [showPreview, setShowPreview] = useState(false);
  const [previewFiles, setPreviewFiles] = useState<InjectionFile[]>([]);
  const [previewPlatform, setPreviewPlatform] = useState('');
  const [isLoadingPreview, setIsLoadingPreview] = useState(false);
  const [isInjecting, setIsInjecting] = useState(false);

  const handleInjectClick = async () => {
    setIsLoadingPreview(true);
    try {
      const plan = await fetchInjectPreview(repo.id);
      setPreviewFiles(plan.files);
      setPreviewPlatform(plan.platform);
      setShowPreview(true);
    } catch (error) {
      // Show error toast
      showToast('error', error instanceof Error ? error.message : 'Failed to load preview');
    } finally {
      setIsLoadingPreview(false);
    }
  };

  const handleConfirmInject = async () => {
    setIsInjecting(true);
    try {
      const result = await executeInjection(repo.id);
      setShowPreview(false);
      if (result.success) {
        showToast('success', `Injected ${result.filesWritten.length} files`);
        onRepoUpdated(); // Refresh repo data to show updated injected_at
      } else {
        showToast('error', result.errors?.join(', ') ?? 'Injection failed');
      }
    } catch (error) {
      setShowPreview(false);
      showToast('error', error instanceof Error ? error.message : 'Injection failed');
    } finally {
      setIsInjecting(false);
    }
  };

  return (
    <div className="border rounded-lg p-4 shadow-sm">
      {/* Existing repo card content */}
      <h3 className="font-semibold text-lg">{repo.name}</h3>
      <p className="text-sm text-gray-500">{repo.path}</p>
      <p className="text-sm text-gray-500">Platform: {repo.platform}</p>

      {/* Injected timestamp */}
      {repo.injected_at && (
        <p className="text-xs text-gray-400 mt-1">
          Last injected: {new Date(repo.injected_at).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          })}
        </p>
      )}

      {/* Inject button */}
      <button
        onClick={handleInjectClick}
        disabled={isLoadingPreview}
        className="mt-3 px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
      >
        {isLoadingPreview ? 'Loading...' : 'Inject'}
      </button>

      {/* Preview modal */}
      <InjectPreviewModal
        isOpen={showPreview}
        onClose={() => setShowPreview(false)}
        onConfirm={handleConfirmInject}
        files={previewFiles}
        repoName={repo.name}
        platform={previewPlatform}
        isInjecting={isInjecting}
      />
    </div>
  );
}
```

**Step 4: Toast notification utility**

Use a simple toast pattern (or integrate with an existing toast library if present):

```typescript
// Simple toast helper â€” can be replaced with a library like react-hot-toast
function showToast(type: 'success' | 'error', message: string) {
  // Implementation depends on the toast system used.
  // Minimal approach: use a state variable + timeout to show/hide.
  console.log(`[${type}] ${message}`);
}
```

### 3.3 API Contract
This story consumes the API defined in STORY-004-06:

| Method | Path | Purpose |
|--------|------|---------|
| `GET` | `/api/repos/:repoId/inject/preview` | Fetch list of files to be injected |
| `POST` | `/api/repos/:repoId/inject` | Execute injection |

---

## 4. Definition of Done (The Gate)
- [ ] "Inject" button appears on every repo card in `Dashboard.tsx`.
- [ ] Clicking "Inject" fetches the preview and opens the `InjectPreviewModal`.
- [ ] Modal displays files with relative paths and create/overwrite action badges.
- [ ] Files can be expanded to show their content, and collapsed again.
- [ ] "Inject" confirm button sends POST, shows success/error toast, and closes modal.
- [ ] "Cancel" button closes modal without any API calls.
- [ ] `injected_at` timestamp is displayed on repo cards when present.
- [ ] Loading states are shown during preview fetch and injection execution.
- [ ] `src/client/lib/api.ts` includes `fetchInjectPreview` and `executeInjection` functions.
- [ ] TypeScript compiles with no errors (`npx tsc --noEmit`).
