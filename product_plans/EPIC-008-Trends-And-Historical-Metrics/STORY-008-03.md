---
id: STORY-008-03
parent_epic: EPIC-008
status: Draft
actor: Backend Developer
complexity: Medium (2-3 files)
---
# STORY-008-03: Trends API

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** REST API endpoints that serve trend data, raw metric history, and a full-scan trigger,
**So that** the Trends page can fetch computed trends and historical data for charting, and users can trigger new snapshots from the UI.

### 1.2 Detailed Requirements
- **Requirement 1**: Create a Fastify route plugin at `src/server/api/trends.ts` that registers trend-related routes.
- **Requirement 2**: Implement `GET /api/repos/:repoId/trends` that returns computed trend data (deltas, directions) for the specified repo. Default period: `30d`.
- **Requirement 3**: Accept a `period` query parameter (`7d`, `30d`, `90d`) and an optional `metric` query parameter to filter to a specific metric.
- **Requirement 4**: Implement `GET /api/repos/:repoId/trends/history` that returns raw metric snapshots for charting. Accept `period` query param to control the time window.
- **Requirement 5**: Implement `POST /api/repos/:repoId/scan` that triggers a full codebase analysis, captures a metric snapshot, and returns the snapshot data. This is an alias for "analyze entire repo + capture snapshot."
- **Requirement 6**: Return 404 for unknown repos, and handle `insufficientData` gracefully (return 200 with the `insufficientData: true` flag so the frontend can display a helpful message).
- **Requirement 7**: Validate the `period` query parameter — return 400 if an invalid value is provided.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Trends API

  Scenario: Get trend data with default period
    Given repo "repo-1" has multiple snapshots over the past month
    When I GET /api/repos/repo-1/trends
    Then the response status is 200
    And the body contains period "30d"
    And the body contains metrics array with trend data for all 8 metrics
    And the body contains history array for charting

  Scenario: Get trend data with custom period
    Given repo "repo-1" has snapshots over 90 days
    When I GET /api/repos/repo-1/trends?period=90d
    Then the response contains period "90d"
    And the history spans 90 days

  Scenario: Filter by specific metric
    Given repo "repo-1" has trend data
    When I GET /api/repos/repo-1/trends?metric=avgComplexity
    Then the metrics array contains only the avgComplexity trend

  Scenario: Insufficient data
    Given repo "repo-1" has only 1 snapshot
    When I GET /api/repos/repo-1/trends
    Then the response status is 200
    And the body has insufficientData: true

  Scenario: Get raw history for charting
    Given repo "repo-1" has 10 snapshots in the last 30 days
    When I GET /api/repos/repo-1/trends/history?period=30d
    Then the response contains 10 snapshot entries
    And each entry has timestamp and metrics

  Scenario: Run full scan
    Given repo "repo-1" exists
    When I POST /api/repos/repo-1/scan
    Then the analyzer runs on the entire repo
    And a new metrics snapshot is captured
    And the response contains the snapshot data

  Scenario: Invalid period parameter
    When I GET /api/repos/repo-1/trends?period=invalid
    Then the response status is 400
    And the body contains { error: "Invalid period. Use 7d, 30d, or 90d", code: "INVALID_PERIOD" }

  Scenario: Repo not found
    When I GET /api/repos/nonexistent/trends
    Then the response status is 404
```

### 2.2 Verification Steps
- [ ] `GET /api/repos/:repoId/trends` returns 200 with complete trend data.
- [ ] `period` query parameter controls the comparison window (7d, 30d, 90d).
- [ ] `metric` query parameter filters to a single metric.
- [ ] `GET /api/repos/:repoId/trends/history` returns raw snapshots for charting.
- [ ] `POST /api/repos/:repoId/scan` runs analysis and captures a snapshot.
- [ ] `insufficientData: true` returned when < 2 snapshots exist.
- [ ] 400 returned for invalid `period` values.
- [ ] 404 returned for unknown repos.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/api/trends.ts` (create)
- **Related Files**:
  - `src/server/analyzer/trends.ts` (STORY-008-02 — `computeTrends`, `TrendPeriod`)
  - `src/server/analyzer/snapshots.ts` (STORY-008-01 — `getSnapshots`, `captureSnapshot`)
  - `src/server/analyzer/engine.ts` (EPIC-005 — `runAnalysis`)
  - `src/server/db/queries.ts` (existing — `getRepoById`)
  - `src/server/index.ts` (existing — register the plugin)
- **New Files Needed**:
  - `src/server/api/trends.ts`

### 3.2 Technical Logic

**Step 1: Create Fastify plugin structure**

```typescript
// src/server/api/trends.ts
import { FastifyInstance } from 'fastify';
import { computeTrends, TrendPeriod } from '../analyzer/trends.js';
import { getSnapshots, captureSnapshot } from '../analyzer/snapshots.js';
import { runAnalysis } from '../analyzer/engine.js';
import { getRepoById } from '../db/queries.js';

interface RepoParams {
  repoId: string;
}

interface TrendsQuery {
  period?: string;
  metric?: string;
}

const VALID_PERIODS = new Set(['7d', '30d', '90d']);

export default async function trendRoutes(fastify: FastifyInstance) {
  // ... routes defined below
}
```

**Step 2: Implement GET /api/repos/:repoId/trends**

```typescript
// Inside trendRoutes:
fastify.get<{ Params: RepoParams; Querystring: TrendsQuery }>(
  '/api/repos/:repoId/trends',
  async (request, reply) => {
    const { repoId } = request.params;
    const { period: periodRaw, metric } = request.query;

    const repo = getRepoById(repoId);
    if (!repo) {
      return reply.status(404).send({
        error: 'Repository not found',
        code: 'REPO_NOT_FOUND',
      });
    }

    // Validate period
    const period = (periodRaw || '30d') as TrendPeriod;
    if (!VALID_PERIODS.has(period)) {
      return reply.status(400).send({
        error: 'Invalid period. Use 7d, 30d, or 90d',
        code: 'INVALID_PERIOD',
      });
    }

    const trendData = computeTrends(repoId, period);

    // Optionally filter to a single metric
    if (metric) {
      trendData.metrics = trendData.metrics.filter(m => m.name === metric);
    }

    return reply.send(trendData);
  }
);
```

**Step 3: Implement GET /api/repos/:repoId/trends/history**

```typescript
fastify.get<{ Params: RepoParams; Querystring: TrendsQuery }>(
  '/api/repos/:repoId/trends/history',
  async (request, reply) => {
    const { repoId } = request.params;
    const { period: periodRaw } = request.query;

    const repo = getRepoById(repoId);
    if (!repo) {
      return reply.status(404).send({
        error: 'Repository not found',
        code: 'REPO_NOT_FOUND',
      });
    }

    const period = (periodRaw || '30d') as TrendPeriod;
    if (!VALID_PERIODS.has(period)) {
      return reply.status(400).send({
        error: 'Invalid period. Use 7d, 30d, or 90d',
        code: 'INVALID_PERIOD',
      });
    }

    // Calculate the "since" date for the period
    const periodMs: Record<string, number> = {
      '7d':  7  * 24 * 60 * 60 * 1000,
      '30d': 30 * 24 * 60 * 60 * 1000,
      '90d': 90 * 24 * 60 * 60 * 1000,
    };
    const since = new Date(Date.now() - periodMs[period]).toISOString();

    const snapshots = getSnapshots(repoId, since);

    return reply.send({
      repoId,
      period,
      snapshots: snapshots.map(s => ({
        id: s.id,
        timestamp: s.timestamp,
        metrics: s.metrics,
      })),
    });
  }
);
```

**Step 4: Implement POST /api/repos/:repoId/scan**

```typescript
fastify.post<{ Params: RepoParams }>(
  '/api/repos/:repoId/scan',
  async (request, reply) => {
    const { repoId } = request.params;

    const repo = getRepoById(repoId);
    if (!repo) {
      return reply.status(404).send({
        error: 'Repository not found',
        code: 'REPO_NOT_FOUND',
      });
    }

    try {
      // Run full analysis
      const analysisReport = await runAnalysis(repo.path);

      // Capture snapshot (also done automatically in engine, but explicit here for clarity)
      const snapshot = captureSnapshot(repoId, analysisReport);

      // Update the repo's last_scan_at timestamp
      updateRepoScanTimestamp(repoId);

      return reply.send({
        message: 'Full scan completed',
        snapshot: {
          id: snapshot.id,
          timestamp: snapshot.timestamp,
          metrics: snapshot.metrics,
        },
        analysisReport,
      });
    } catch (err: any) {
      return reply.status(500).send({
        error: `Scan failed: ${err.message}`,
        code: 'SCAN_ERROR',
      });
    }
  }
);
```

**Step 5: Add helper to update repo scan timestamp**

```typescript
import { db } from '../db/schema.js';

function updateRepoScanTimestamp(repoId: string): void {
  const stmt = db.prepare(`
    UPDATE repos SET last_scan_at = ? WHERE id = ?
  `);
  stmt.run(new Date().toISOString(), repoId);
}
```

**Step 6: Register the plugin in the Fastify server**

```typescript
// In src/server/index.ts:
import trendRoutes from './api/trends.js';

await server.register(trendRoutes);
```

### 3.3 API Contract

**GET `/api/repos/:repoId/trends?period=30d&metric=avgComplexity`**

Response `200`:
```json
{
  "repoId": "repo-1",
  "period": "30d",
  "insufficientData": false,
  "metrics": [
    {
      "name": "avgComplexity",
      "current": 5.2,
      "previous": 6.0,
      "delta": -0.8,
      "deltaPercent": -13.3,
      "direction": "down"
    }
  ],
  "history": [
    {
      "timestamp": "2026-01-25T10:00:00.000Z",
      "metrics": { "avgComplexity": 6.0, "maxComplexity": 15, ... }
    },
    {
      "timestamp": "2026-02-23T10:00:00.000Z",
      "metrics": { "avgComplexity": 5.2, "maxComplexity": 12, ... }
    }
  ]
}
```

**GET `/api/repos/:repoId/trends/history?period=30d`**

Response `200`:
```json
{
  "repoId": "repo-1",
  "period": "30d",
  "snapshots": [
    { "id": 1, "timestamp": "2026-01-25T10:00:00.000Z", "metrics": { ... } },
    { "id": 2, "timestamp": "2026-02-01T10:00:00.000Z", "metrics": { ... } },
    { "id": 3, "timestamp": "2026-02-15T10:00:00.000Z", "metrics": { ... } }
  ]
}
```

**POST `/api/repos/:repoId/scan`**

Response `200`:
```json
{
  "message": "Full scan completed",
  "snapshot": {
    "id": 42,
    "timestamp": "2026-02-23T14:30:00.000Z",
    "metrics": {
      "avgComplexity": 5.2,
      "maxComplexity": 12,
      "duplicationPercentage": 8.3,
      "totalFiles": 145,
      "totalLines": 12500,
      "avgFileSize": 86,
      "errorPatternCount": 3,
      "dependencyCount": 22
    }
  },
  "analysisReport": { ... }
}
```

**Error responses:**
```json
{ "error": "Repository not found", "code": "REPO_NOT_FOUND" }
{ "error": "Invalid period. Use 7d, 30d, or 90d", "code": "INVALID_PERIOD" }
{ "error": "Scan failed: ...", "code": "SCAN_ERROR" }
```

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/api/trends.ts` exists and exports a Fastify plugin with trend routes.
- [ ] `GET /api/repos/:repoId/trends` returns computed trends with deltas and directions.
- [ ] `period` query parameter (7d, 30d, 90d) controls the comparison window; default is 30d.
- [ ] `metric` query parameter filters trends to a single metric.
- [ ] `GET /api/repos/:repoId/trends/history` returns raw snapshots for charting.
- [ ] `POST /api/repos/:repoId/scan` runs full analysis, captures snapshot, updates last_scan_at.
- [ ] 400 returned for invalid period values.
- [ ] 404 returned for unknown repos.
- [ ] `insufficientData: true` returned gracefully when < 2 snapshots.
- [ ] Plugin is registered in `src/server/index.ts`.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
