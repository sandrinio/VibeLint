---
id: STORY-008-06
parent_epic: EPIC-008
status: Draft
actor: Frontend Developer
complexity: Low (1 file)
---
# STORY-008-06: Dashboard Trend Indicators

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Frontend Developer,
**I want** small trend indicator arrows on the Dashboard repo cards showing complexity and duplication trends,
**So that** users can see at a glance whether their key metrics are improving or declining without navigating to the Trends page.

### 1.2 Detailed Requirements
- **Requirement 1**: Modify `src/client/pages/Dashboard.tsx` and `src/client/components/RepoCard.tsx` to display trend indicators on each repo card.
- **Requirement 2**: Show two trend indicators per repo card: Complexity trend and Duplication trend (the two most important quality metrics).
- **Requirement 3**: Fetch trend direction data from `GET /api/repos/:repoId/trends?period=7d` for each repo on the Dashboard. Use a lightweight fetch (only need the `metrics` array, not full history).
- **Requirement 4**: Display trend direction as small colored arrows: green down-arrow for improving (lower complexity/duplication), red up-arrow for worsening (higher complexity/duplication), gray dash for flat or no data.
- **Requirement 5**: If no trend data exists for a repo (no snapshots or `insufficientData: true`), display a gray dash (`--`) instead of arrows.
- **Requirement 6**: Trend indicators should not block the Dashboard from rendering — fetch them asynchronously after the repo list loads, and display dashes while loading.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Dashboard Trend Indicators

  Scenario: Repo card shows improving trends
    Given repo "repo-1" has avgComplexity trending down and duplicationPercentage trending down
    When the Dashboard renders
    Then the "repo-1" card shows a green down-arrow next to "Complexity"
    And a green down-arrow next to "Duplication"

  Scenario: Repo card shows worsening trends
    Given repo "repo-1" has avgComplexity trending up
    When the Dashboard renders
    Then the "repo-1" card shows a red up-arrow next to "Complexity"

  Scenario: Repo card shows flat trends
    Given repo "repo-1" has avgComplexity flat (< 1% change)
    When the Dashboard renders
    Then the "repo-1" card shows a gray dash next to "Complexity"

  Scenario: No trend data available
    Given repo "repo-2" has no snapshots
    When the Dashboard renders
    Then the "repo-2" card shows gray dashes for both Complexity and Duplication

  Scenario: Trend indicators load asynchronously
    Given the Dashboard is loading
    When repo cards render before trend data is fetched
    Then all trend indicators show gray dashes (loading state)
    And once trend data arrives, indicators update to arrows

  Scenario: Multiple repos fetch trends independently
    Given 3 repos exist on the Dashboard
    When the page loads
    Then trend data is fetched for each repo
    And each card shows its own trend indicators
```

### 2.2 Verification Steps
- [ ] Repo cards display two trend indicators: Complexity and Duplication.
- [ ] Green down-arrow shown for improving metrics (direction: "down" for lowerIsBetter metrics).
- [ ] Red up-arrow shown for worsening metrics (direction: "up" for lowerIsBetter metrics).
- [ ] Gray dash shown for flat trends or missing data.
- [ ] Dashboard renders immediately; trend indicators load asynchronously.
- [ ] No console errors or failed fetches when trend data is unavailable.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**:
  - `src/client/pages/Dashboard.tsx` (modify)
  - `src/client/components/RepoCard.tsx` (modify — or create if it doesn't exist yet as a separate component)
- **Related Files**:
  - `src/client/lib/api.ts` (existing — API client utility)
- **New Files Needed**: None (modifying existing files)

### 3.2 Technical Logic

**Step 1: Define the trend indicator type**

```typescript
// In Dashboard.tsx or a shared types file

type TrendDirection = 'up' | 'down' | 'flat';

interface RepoTrends {
  avgComplexity: TrendDirection;
  duplicationPercentage: TrendDirection;
}
```

**Step 2: Create a TrendIndicator sub-component**

```tsx
// Small inline component for trend arrows
function TrendIndicator({
  label,
  direction,
}: {
  label: string;
  direction: TrendDirection | null;  // null = loading/no data
}) {
  let icon: string;
  let colorClass: string;

  if (!direction || direction === 'flat') {
    icon = '\u2014';  // em dash
    colorClass = 'text-gray-400';
  } else if (direction === 'down') {
    // For lowerIsBetter metrics, down = improvement = green
    icon = '\u2193';  // down arrow
    colorClass = 'text-green-500';
  } else {
    // up = regression = red
    icon = '\u2191';  // up arrow
    colorClass = 'text-red-500';
  }

  return (
    <span className="flex items-center gap-1 text-xs" title={`${label} trend (7-day)`}>
      <span className="text-gray-500">{label}:</span>
      <span className={`font-bold ${colorClass}`}>{icon}</span>
    </span>
  );
}
```

**Step 3: Add trend fetching logic to Dashboard**

```tsx
// In Dashboard.tsx, add state and effect for trends:

const [repoTrends, setRepoTrends] = useState<Record<string, RepoTrends | null>>({});

// After repos are loaded, fetch trends for each repo
useEffect(() => {
  if (repos.length === 0) return;

  // Fetch trends for all repos in parallel
  repos.forEach(repo => {
    fetch(`/api/repos/${repo.id}/trends?period=7d`)
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if (!data || data.insufficientData) {
          setRepoTrends(prev => ({ ...prev, [repo.id]: null }));
          return;
        }

        // Extract directions for the two key metrics
        const metrics = data.metrics as Array<{
          name: string;
          direction: TrendDirection;
        }>;
        const complexity = metrics.find(m => m.name === 'avgComplexity');
        const duplication = metrics.find(m => m.name === 'duplicationPercentage');

        setRepoTrends(prev => ({
          ...prev,
          [repo.id]: {
            avgComplexity: complexity?.direction ?? 'flat',
            duplicationPercentage: duplication?.direction ?? 'flat',
          },
        }));
      })
      .catch(() => {
        setRepoTrends(prev => ({ ...prev, [repo.id]: null }));
      });
  });
}, [repos]);
```

**Step 4: Integrate TrendIndicator into RepoCard**

```tsx
// In the RepoCard component (or inline in Dashboard where repo cards are rendered):
// Add trend indicators below the existing repo info

interface RepoCardProps {
  repo: Repo;
  trends: RepoTrends | null;  // null = no data
}

function RepoCard({ repo, trends }: RepoCardProps) {
  return (
    <div className="border rounded-lg bg-white p-4 hover:shadow-md transition-shadow">
      {/* Existing repo info */}
      <h3 className="font-semibold text-lg">{repo.name}</h3>
      <p className="text-sm text-gray-500 truncate">{repo.path}</p>

      {/* Existing metadata (languages, last scan, etc.) */}
      {/* ... */}

      {/* Trend indicators — new addition */}
      <div className="flex items-center gap-4 mt-3 pt-3 border-t">
        <TrendIndicator
          label="Complexity"
          direction={trends?.avgComplexity ?? null}
        />
        <TrendIndicator
          label="Duplication"
          direction={trends?.duplicationPercentage ?? null}
        />
      </div>
    </div>
  );
}
```

**Step 5: Pass trends to RepoCard in Dashboard**

```tsx
// In Dashboard.tsx, where repo cards are rendered:
{repos.map(repo => (
  <RepoCard
    key={repo.id}
    repo={repo}
    trends={repoTrends[repo.id] ?? null}
  />
))}
```

### 3.3 API Contract
This story consumes the following endpoint (no new endpoints created):

| Method | Endpoint | Source Story |
|--------|----------|-------------|
| GET | `/api/repos/:repoId/trends?period=7d` | STORY-008-03 |

The endpoint returns a `TrendData` object. Only the `insufficientData` flag and `metrics[].direction` fields are used by this story.

---

## 4. Definition of Done (The Gate)
- [ ] `src/client/pages/Dashboard.tsx` is modified to fetch and display trend indicators.
- [ ] `src/client/components/RepoCard.tsx` (or equivalent inline component) shows Complexity and Duplication trend indicators.
- [ ] Green down-arrow displayed for improving metrics (direction "down").
- [ ] Red up-arrow displayed for worsening metrics (direction "up").
- [ ] Gray dash displayed for flat, missing, or insufficient trend data.
- [ ] Trend data fetched asynchronously — Dashboard renders immediately with dashes, updating when data arrives.
- [ ] No console errors when trend endpoints return 404 or insufficient data.
- [ ] No TypeScript compilation errors (`npx tsc --noEmit`).
