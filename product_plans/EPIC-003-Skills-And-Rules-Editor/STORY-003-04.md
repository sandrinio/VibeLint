---
id: STORY-003-04
parent_epic: EPIC-003
status: Draft
actor: Backend Developer
complexity: Medium (2-3 files)
---
# STORY-003-04: Skills CRUD API

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** a set of Fastify REST API routes for listing, reading, creating, updating, deleting, and resetting skills per repository,
**So that** the frontend Skills Editor can manage both built-in and custom skills for any connected repo.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/server/api/skills.ts` as a Fastify route plugin.
- **Requirement 2**: `GET /api/repos/:repoId/skills` — list all skills for a repo (defaults + custom overrides), returning an array of `{ name, category, content, isDefault, isModified }`.
- **Requirement 3**: `GET /api/repos/:repoId/skills/:name` — get a single skill's content. Check for a custom override first; fall back to the default template.
- **Requirement 4**: `PUT /api/repos/:repoId/skills/:name` — save custom skill content (create or update). Store in the `config` table as JSON with key pattern `skills:{repoId}:{name}`.
- **Requirement 5**: `POST /api/repos/:repoId/skills` — create a new custom skill (requires `name` and `content` in the request body). Must not collide with an existing default or custom skill name.
- **Requirement 6**: `DELETE /api/repos/:repoId/skills/:name` — delete a custom skill. Returns 400 if attempting to delete a built-in default (defaults cannot be deleted, only reset).
- **Requirement 7**: `POST /api/repos/:repoId/skills/:name/reset` — reset a skill to its default content by deleting the custom override from the `config` table. Returns 404 if the skill is not a built-in default.
- **Requirement 8**: Validate that `repoId` corresponds to an existing repo in the `repos` table. Return 404 if not found.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Skills CRUD API

  Background:
    Given a repo with id "repo-1" exists in the database
    And the template loader has default skills available

  Scenario: List skills returns defaults plus custom
    Given no custom skills exist for "repo-1"
    When I GET /api/repos/repo-1/skills
    Then the response status is 200
    And the body is an array of skill objects
    And each default skill has isDefault true and isModified false

  Scenario: List skills shows modified indicator
    Given a custom override exists for "general.md" in "repo-1"
    When I GET /api/repos/repo-1/skills
    Then the "general.md" entry has isModified true

  Scenario: Get a default skill
    Given no custom override exists for "typescript.md" in "repo-1"
    When I GET /api/repos/repo-1/skills/typescript.md
    Then the response status is 200
    And the body contains the default template content
    And isDefault is true

  Scenario: Get a custom-overridden skill
    Given a custom override with content "custom rules" exists for "typescript.md" in "repo-1"
    When I GET /api/repos/repo-1/skills/typescript.md
    Then the response status is 200
    And the body content is "custom rules"
    And isDefault is false

  Scenario: Save a custom skill override
    When I PUT /api/repos/repo-1/skills/typescript.md with body { "content": "my custom rules" }
    Then the response status is 200
    And the config table has key "skills:repo-1:typescript.md" with the custom content

  Scenario: Create a new custom skill
    When I POST /api/repos/repo-1/skills with body { "name": "my-skill.md", "content": "custom content" }
    Then the response status is 201
    And the config table has key "skills:repo-1:my-skill.md"

  Scenario: Create fails for duplicate name
    Given a custom skill "my-skill.md" exists for "repo-1"
    When I POST /api/repos/repo-1/skills with body { "name": "my-skill.md", "content": "content" }
    Then the response status is 409

  Scenario: Delete a custom skill
    Given a custom skill "my-skill.md" exists for "repo-1"
    When I DELETE /api/repos/repo-1/skills/my-skill.md
    Then the response status is 200
    And the config table no longer has key "skills:repo-1:my-skill.md"

  Scenario: Cannot delete a built-in default
    When I DELETE /api/repos/repo-1/skills/general.md
    Then the response status is 400
    And the body contains error "Cannot delete built-in skill"

  Scenario: Reset skill to default
    Given a custom override exists for "general.md" in "repo-1"
    When I POST /api/repos/repo-1/skills/general.md/reset
    Then the response status is 200
    And the config table no longer has key "skills:repo-1:general.md"
    And GET /api/repos/repo-1/skills/general.md returns default content

  Scenario: Reset fails for non-default skill
    Given a custom skill "my-skill.md" exists for "repo-1"
    When I POST /api/repos/repo-1/skills/my-skill.md/reset
    Then the response status is 404
    And the body contains error "not a built-in skill"

  Scenario: Invalid repo returns 404
    When I GET /api/repos/nonexistent/skills
    Then the response status is 404
```

### 2.2 Verification Steps
- [ ] `GET /api/repos/:repoId/skills` returns all default skills with `isDefault: true`.
- [ ] Custom overrides appear with `isModified: true` in the list.
- [ ] `GET /api/repos/:repoId/skills/:name` returns custom content when an override exists.
- [ ] `PUT` saves content to the `config` table and subsequent `GET` returns it.
- [ ] `POST` creates a new custom skill and rejects duplicates with 409.
- [ ] `DELETE` removes custom skills and rejects deletion of built-in defaults with 400.
- [ ] `POST .../reset` removes the custom override and restores default content.
- [ ] All routes return 404 for non-existent repos.
- [ ] TypeScript compiles with no errors.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/api/skills.ts` (create)
- **Related Files**:
  - `src/server/templates/loader.ts` (STORY-003-01, provides `loadTemplate`, `listTemplates`)
  - `src/server/db/queries.ts` (existing, provides `getConfig`, `setConfig`, `deleteConfig`)
  - `src/server/db/schema.ts` (existing, defines `config` table)
  - `src/server/index.ts` (existing, register route plugin)
- **New Files Needed**:
  - `src/server/api/skills.ts`

### 3.2 Technical Logic

**Step 1: Define types**

```typescript
// src/server/api/skills.ts

import { FastifyInstance, FastifyPluginOptions } from 'fastify';
import { loadTemplate, listTemplates, TemplateNotFoundError } from '../templates/loader.js';

/** Shape returned by all skill endpoints */
interface SkillResponse {
  name: string;
  category: string;
  content: string;
  /** true if content comes from the bundled template */
  isDefault: boolean;
  /** true if a custom override exists (only meaningful for built-in skills) */
  isModified: boolean;
}

/** Request body for PUT (update skill) */
interface UpdateSkillBody {
  content: string;
}

/** Request body for POST (create new skill) */
interface CreateSkillBody {
  name: string;
  content: string;
}

/** Route params */
interface RepoParams {
  repoId: string;
}

interface SkillParams extends RepoParams {
  name: string;
}
```

**Step 2: Implement the Fastify plugin**

```typescript
export default async function skillRoutes(
  fastify: FastifyInstance,
  _opts: FastifyPluginOptions,
): Promise<void> {

  // Helper: verify repo exists
  function repoExists(repoId: string): boolean {
    const row = fastify.db.prepare('SELECT id FROM repos WHERE id = ?').get(repoId);
    return !!row;
  }

  // Helper: config key pattern
  function skillKey(repoId: string, name: string): string {
    return `skills:${repoId}:${name}`;
  }

  // Helper: get custom skill from config table
  function getCustomSkill(repoId: string, name: string): string | null {
    const row = fastify.db
      .prepare('SELECT value FROM config WHERE key = ?')
      .get(skillKey(repoId, name)) as { value: string } | undefined;
    return row ? JSON.parse(row.value).content : null;
  }

  // Helper: list all custom skill keys for a repo
  function listCustomSkills(repoId: string): Map<string, string> {
    const prefix = `skills:${repoId}:`;
    const rows = fastify.db
      .prepare('SELECT key, value FROM config WHERE key LIKE ?')
      .all(`${prefix}%`) as { key: string; value: string }[];
    const map = new Map<string, string>();
    for (const row of rows) {
      const name = row.key.slice(prefix.length);
      map.set(name, JSON.parse(row.value).content);
    }
    return map;
  }

  // Helper: check if name is a built-in default
  function isBuiltInSkill(name: string): boolean {
    try {
      loadTemplate('skills', name);
      return true;
    } catch {
      return false;
    }
  }

  // ── GET /api/repos/:repoId/skills ──
  fastify.get<{ Params: RepoParams }>(
    '/api/repos/:repoId/skills',
    async (request, reply) => {
      const { repoId } = request.params;
      if (!repoExists(repoId)) return reply.status(404).send({ error: 'Repo not found' });

      const defaults = listTemplates('skills');
      const customs = listCustomSkills(repoId);

      const skills: SkillResponse[] = [];

      // Add defaults (with override check)
      for (const tpl of defaults) {
        const customContent = customs.get(tpl.name);
        skills.push({
          name: tpl.name,
          category: 'skills',
          content: customContent ?? tpl.content,
          isDefault: !customContent,
          isModified: !!customContent,
        });
        customs.delete(tpl.name); // Remove so we don't double-add
      }

      // Add pure custom skills (not overriding a default)
      for (const [name, content] of customs) {
        skills.push({
          name,
          category: 'skills',
          content,
          isDefault: false,
          isModified: false,
        });
      }

      return reply.send(skills);
    },
  );

  // ── GET /api/repos/:repoId/skills/:name ──
  fastify.get<{ Params: SkillParams }>(
    '/api/repos/:repoId/skills/:name',
    async (request, reply) => {
      const { repoId, name } = request.params;
      if (!repoExists(repoId)) return reply.status(404).send({ error: 'Repo not found' });

      // Check custom first
      const customContent = getCustomSkill(repoId, name);
      if (customContent !== null) {
        return reply.send({
          name,
          category: 'skills',
          content: customContent,
          isDefault: false,
          isModified: true,
        });
      }

      // Fall back to default
      try {
        const tpl = loadTemplate('skills', name);
        return reply.send({
          name: tpl.name,
          category: tpl.category,
          content: tpl.content,
          isDefault: true,
          isModified: false,
        });
      } catch (err) {
        if (err instanceof TemplateNotFoundError) {
          return reply.status(404).send({ error: `Skill not found: ${name}` });
        }
        throw err;
      }
    },
  );

  // ── PUT /api/repos/:repoId/skills/:name ──
  fastify.put<{ Params: SkillParams; Body: UpdateSkillBody }>(
    '/api/repos/:repoId/skills/:name',
    async (request, reply) => {
      const { repoId, name } = request.params;
      const { content } = request.body;
      if (!repoExists(repoId)) return reply.status(404).send({ error: 'Repo not found' });

      fastify.db
        .prepare('INSERT OR REPLACE INTO config (key, value) VALUES (?, ?)')
        .run(skillKey(repoId, name), JSON.stringify({ content }));

      return reply.send({ success: true, name });
    },
  );

  // ── POST /api/repos/:repoId/skills ──
  fastify.post<{ Params: RepoParams; Body: CreateSkillBody }>(
    '/api/repos/:repoId/skills',
    async (request, reply) => {
      const { repoId } = request.params;
      const { name, content } = request.body;
      if (!repoExists(repoId)) return reply.status(404).send({ error: 'Repo not found' });

      // Check for collision
      const existing = getCustomSkill(repoId, name);
      if (existing !== null || isBuiltInSkill(name)) {
        return reply.status(409).send({ error: `Skill already exists: ${name}` });
      }

      fastify.db
        .prepare('INSERT INTO config (key, value) VALUES (?, ?)')
        .run(skillKey(repoId, name), JSON.stringify({ content }));

      return reply.status(201).send({ success: true, name });
    },
  );

  // ── DELETE /api/repos/:repoId/skills/:name ──
  fastify.delete<{ Params: SkillParams }>(
    '/api/repos/:repoId/skills/:name',
    async (request, reply) => {
      const { repoId, name } = request.params;
      if (!repoExists(repoId)) return reply.status(404).send({ error: 'Repo not found' });

      if (isBuiltInSkill(name)) {
        return reply.status(400).send({ error: 'Cannot delete built-in skill. Use reset instead.' });
      }

      const result = fastify.db
        .prepare('DELETE FROM config WHERE key = ?')
        .run(skillKey(repoId, name));

      if (result.changes === 0) {
        return reply.status(404).send({ error: `Custom skill not found: ${name}` });
      }

      return reply.send({ success: true, name });
    },
  );

  // ── POST /api/repos/:repoId/skills/:name/reset ──
  fastify.post<{ Params: SkillParams }>(
    '/api/repos/:repoId/skills/:name/reset',
    async (request, reply) => {
      const { repoId, name } = request.params;
      if (!repoExists(repoId)) return reply.status(404).send({ error: 'Repo not found' });

      if (!isBuiltInSkill(name)) {
        return reply.status(404).send({ error: `${name} is not a built-in skill` });
      }

      fastify.db
        .prepare('DELETE FROM config WHERE key = ?')
        .run(skillKey(repoId, name));

      const tpl = loadTemplate('skills', name);
      return reply.send({
        name: tpl.name,
        category: tpl.category,
        content: tpl.content,
        isDefault: true,
        isModified: false,
      });
    },
  );
}
```

**Step 3: Register the plugin in the Fastify server**

In `src/server/index.ts`, add:

```typescript
import skillRoutes from './api/skills.js';

// Inside the server setup function:
fastify.register(skillRoutes);
```

**Step 4: Fastify decorator for database access**

The plugin assumes `fastify.db` is a decorated property providing the `better-sqlite3` database instance. This should already be set up in the server bootstrap (EPIC-001). If not, add a type declaration:

```typescript
// In a shared types file or at the top of skills.ts
declare module 'fastify' {
  interface FastifyInstance {
    db: import('better-sqlite3').Database;
  }
}
```

### 3.3 API Contract

| Method | Path | Request Body | Response | Status Codes |
|--------|------|-------------|----------|--------------|
| `GET` | `/api/repos/:repoId/skills` | — | `SkillResponse[]` | 200, 404 |
| `GET` | `/api/repos/:repoId/skills/:name` | — | `SkillResponse` | 200, 404 |
| `PUT` | `/api/repos/:repoId/skills/:name` | `{ content: string }` | `{ success: true, name }` | 200, 404 |
| `POST` | `/api/repos/:repoId/skills` | `{ name: string, content: string }` | `{ success: true, name }` | 201, 404, 409 |
| `DELETE` | `/api/repos/:repoId/skills/:name` | — | `{ success: true, name }` | 200, 400, 404 |
| `POST` | `/api/repos/:repoId/skills/:name/reset` | — | `SkillResponse` (default content) | 200, 404 |

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/api/skills.ts` exists and exports a Fastify plugin with all 6 routes.
- [ ] `GET /api/repos/:repoId/skills` returns defaults + custom skills with correct `isDefault`/`isModified` flags.
- [ ] `GET /api/repos/:repoId/skills/:name` returns custom override if it exists, default otherwise.
- [ ] `PUT` saves to the `config` table with key `skills:{repoId}:{name}`.
- [ ] `POST` creates new custom skills and rejects duplicates (409).
- [ ] `DELETE` removes custom skills and rejects built-in deletions (400).
- [ ] `POST .../reset` removes override and returns default content.
- [ ] All routes return 404 for non-existent repos.
- [ ] Plugin is registered in `src/server/index.ts`.
- [ ] TypeScript compiles with no errors (`npx tsc --noEmit`).
