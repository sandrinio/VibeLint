---
id: STORY-003-05
parent_epic: EPIC-003
status: Done
actor: Backend Developer
complexity: Medium (2-3 files)
---
# STORY-003-05: Rules CRUD API

## 1. The Spec (The Contract)

### 1.1 User Story
**As a** Backend Developer,
**I want** Fastify REST API routes for reading, updating, and resetting platform-specific rule files (CLAUDE.md, .cursorrules, .windsurfrules, AGENTS.md) and LESSONS.md per repository,
**So that** the frontend Rules Editor can display and manage the correct rule file type based on each repo's configured platform.

### 1.2 Detailed Requirements
- **Requirement 1**: Create `src/server/api/rules.ts` as a Fastify route plugin.
- **Requirement 2**: `GET /api/repos/:repoId/rules` — get all rules for a repo: the platform-specific rules file and LESSONS.md. The platform rule type is determined by the repo's `platform` field in the `repos` table.
- **Requirement 3**: `GET /api/repos/:repoId/rules/:type` — get a specific rule's content. Valid types: `claude-md`, `cursorrules`, `windsurfrules`, `agents-md`, `lessons-md`. Check for custom override first; fall back to the template.
- **Requirement 4**: `PUT /api/repos/:repoId/rules/:type` — save custom rule content. Store in `config` table with key pattern `rules:{repoId}:{type}`.
- **Requirement 5**: `POST /api/repos/:repoId/rules/:type/reset` — reset a rule to its default template by deleting the custom override.
- **Requirement 6**: Map rule types to template categories:
  - `claude-md` maps to `rules/claude-code/CLAUDE.md.template`
  - `cursorrules` maps to `rules/cursor/cursorrules.template`
  - `windsurfrules` maps to `rules/windsurf/windsurfrules.template`
  - `agents-md` maps to `rules/generic/AGENTS.md.template`
  - `lessons-md` maps to `config/LESSONS.md.template`
- **Requirement 7**: The `GET /api/repos/:repoId/rules` response includes a `platform` field and a `displayName` field (e.g., "CLAUDE.md" for Claude Code, ".cursorrules" for Cursor) so the frontend knows what to label the editor.
- **Requirement 8**: Validate that `repoId` exists and that `type` is a valid rule type. Return 404 or 400 respectively.

---

## 2. The Truth (Executable Tests)

### 2.1 Acceptance Criteria (Gherkin)
```gherkin
Feature: Rules CRUD API

  Background:
    Given a repo "repo-1" exists with platform "claude-code"
    And the template loader has rule templates available

  Scenario: List rules returns platform rules and LESSONS.md
    When I GET /api/repos/repo-1/rules
    Then the response status is 200
    And the body contains a "platformRule" object with type "claude-md"
    And the body contains a "lessonsRule" object with type "lessons-md"
    And the "platformRule" has displayName "CLAUDE.md"

  Scenario: List rules for Cursor platform
    Given a repo "repo-2" exists with platform "cursor"
    When I GET /api/repos/repo-2/rules
    Then the "platformRule" has type "cursorrules"
    And the "platformRule" has displayName ".cursorrules"

  Scenario: Get default CLAUDE.md rule
    When I GET /api/repos/repo-1/rules/claude-md
    Then the response status is 200
    And the body content is the default CLAUDE.md template
    And isDefault is true

  Scenario: Get custom-overridden rule
    Given a custom override exists for "claude-md" in "repo-1"
    When I GET /api/repos/repo-1/rules/claude-md
    Then the response status is 200
    And the body content is the custom content
    And isDefault is false

  Scenario: Save custom rule content
    When I PUT /api/repos/repo-1/rules/claude-md with body { "content": "my custom rules" }
    Then the response status is 200
    And the config table has key "rules:repo-1:claude-md"

  Scenario: Save LESSONS.md content
    When I PUT /api/repos/repo-1/rules/lessons-md with body { "content": "# My Lessons" }
    Then the response status is 200
    And the config table has key "rules:repo-1:lessons-md"

  Scenario: Reset rule to default
    Given a custom override exists for "claude-md" in "repo-1"
    When I POST /api/repos/repo-1/rules/claude-md/reset
    Then the response status is 200
    And subsequent GET returns default template content

  Scenario: Invalid rule type returns 400
    When I GET /api/repos/repo-1/rules/invalid-type
    Then the response status is 400
    And the body contains error "Invalid rule type"

  Scenario: Non-existent repo returns 404
    When I GET /api/repos/nonexistent/rules
    Then the response status is 404
```

### 2.2 Verification Steps
- [ ] `GET /api/repos/:repoId/rules` returns both platform rule and LESSONS.md with correct types.
- [ ] Platform rule type matches the repo's `platform` setting.
- [ ] `displayName` is correct for each platform (CLAUDE.md, .cursorrules, .windsurfrules, AGENTS.md).
- [ ] `GET /api/repos/:repoId/rules/:type` returns custom override when it exists, default template otherwise.
- [ ] `PUT` saves content to the `config` table.
- [ ] `POST .../reset` removes the override and restores the default template.
- [ ] Invalid rule types return 400; non-existent repos return 404.
- [ ] TypeScript compiles with no errors.

---

## 3. The Implementation Guide (AI-to-AI)

### 3.1 Context & Files
- **Primary Files**: `src/server/api/rules.ts` (create)
- **Related Files**:
  - `src/server/templates/loader.ts` (STORY-003-01, provides `loadTemplate`)
  - `src/server/db/queries.ts` (existing, database operations)
  - `src/server/db/schema.ts` (existing, `repos` table has `platform` column, `config` table for overrides)
  - `src/server/index.ts` (existing, register route plugin)
- **New Files Needed**:
  - `src/server/api/rules.ts`

### 3.2 Technical Logic

**Step 1: Define types and platform mapping**

```typescript
// src/server/api/rules.ts

import { FastifyInstance, FastifyPluginOptions } from 'fastify';
import { loadTemplate, TemplateNotFoundError } from '../templates/loader.js';

/** Valid rule types */
const VALID_RULE_TYPES = ['claude-md', 'cursorrules', 'windsurfrules', 'agents-md', 'lessons-md'] as const;
type RuleType = (typeof VALID_RULE_TYPES)[number];

/** Map rule type to template category and file name */
const RULE_TEMPLATE_MAP: Record<RuleType, { category: string; fileName: string }> = {
  'claude-md':     { category: 'rules/claude-code', fileName: 'CLAUDE.md.template' },
  'cursorrules':   { category: 'rules/cursor',      fileName: 'cursorrules.template' },
  'windsurfrules': { category: 'rules/windsurf',    fileName: 'windsurfrules.template' },
  'agents-md':     { category: 'rules/generic',     fileName: 'AGENTS.md.template' },
  'lessons-md':    { category: 'config',             fileName: 'LESSONS.md.template' },
};

/** Map platform (from repos table) to the corresponding rule type */
const PLATFORM_RULE_MAP: Record<string, RuleType> = {
  'claude-code': 'claude-md',
  'cursor':      'cursorrules',
  'windsurf':    'windsurfrules',
  'gemini-cli':  'agents-md',
  'antigravity': 'agents-md',
  'other':       'agents-md',
};

/** Map rule type to human-readable display name */
const RULE_DISPLAY_NAMES: Record<RuleType, string> = {
  'claude-md':     'CLAUDE.md',
  'cursorrules':   '.cursorrules',
  'windsurfrules': '.windsurfrules',
  'agents-md':     'AGENTS.md',
  'lessons-md':    'LESSONS.md',
};

/** Response shape for a single rule */
interface RuleResponse {
  type: RuleType;
  displayName: string;
  content: string;
  isDefault: boolean;
  isModified: boolean;
}

/** Response shape for GET /rules (all rules for a repo) */
interface RulesListResponse {
  platform: string;
  platformRule: RuleResponse;
  lessonsRule: RuleResponse;
}

interface RepoParams { repoId: string; }
interface RuleParams extends RepoParams { type: string; }
interface UpdateRuleBody { content: string; }
```

**Step 2: Implement the Fastify plugin**

```typescript
export default async function ruleRoutes(
  fastify: FastifyInstance,
  _opts: FastifyPluginOptions,
): Promise<void> {

  // Helper: get repo row
  function getRepo(repoId: string): { id: string; platform: string } | undefined {
    return fastify.db
      .prepare('SELECT id, platform FROM repos WHERE id = ?')
      .get(repoId) as { id: string; platform: string } | undefined;
  }

  // Helper: config key
  function ruleKey(repoId: string, type: string): string {
    return `rules:${repoId}:${type}`;
  }

  // Helper: get custom rule
  function getCustomRule(repoId: string, type: string): string | null {
    const row = fastify.db
      .prepare('SELECT value FROM config WHERE key = ?')
      .get(ruleKey(repoId, type)) as { value: string } | undefined;
    return row ? JSON.parse(row.value).content : null;
  }

  // Helper: load default template for a rule type
  function getDefaultContent(type: RuleType): string {
    const mapping = RULE_TEMPLATE_MAP[type];
    const tpl = loadTemplate(mapping.category, mapping.fileName);
    return tpl.content;
  }

  // Helper: build a RuleResponse
  function buildRuleResponse(repoId: string, type: RuleType): RuleResponse {
    const customContent = getCustomRule(repoId, type);
    if (customContent !== null) {
      return {
        type,
        displayName: RULE_DISPLAY_NAMES[type],
        content: customContent,
        isDefault: false,
        isModified: true,
      };
    }
    return {
      type,
      displayName: RULE_DISPLAY_NAMES[type],
      content: getDefaultContent(type),
      isDefault: true,
      isModified: false,
    };
  }

  // Helper: validate rule type
  function isValidRuleType(type: string): type is RuleType {
    return (VALID_RULE_TYPES as readonly string[]).includes(type);
  }

  // ── GET /api/repos/:repoId/rules ──
  fastify.get<{ Params: RepoParams }>(
    '/api/repos/:repoId/rules',
    async (request, reply) => {
      const { repoId } = request.params;
      const repo = getRepo(repoId);
      if (!repo) return reply.status(404).send({ error: 'Repo not found' });

      const platformRuleType = PLATFORM_RULE_MAP[repo.platform] ?? 'agents-md';

      const response: RulesListResponse = {
        platform: repo.platform,
        platformRule: buildRuleResponse(repoId, platformRuleType),
        lessonsRule: buildRuleResponse(repoId, 'lessons-md'),
      };

      return reply.send(response);
    },
  );

  // ── GET /api/repos/:repoId/rules/:type ──
  fastify.get<{ Params: RuleParams }>(
    '/api/repos/:repoId/rules/:type',
    async (request, reply) => {
      const { repoId, type } = request.params;
      const repo = getRepo(repoId);
      if (!repo) return reply.status(404).send({ error: 'Repo not found' });
      if (!isValidRuleType(type)) return reply.status(400).send({ error: `Invalid rule type: ${type}` });

      return reply.send(buildRuleResponse(repoId, type));
    },
  );

  // ── PUT /api/repos/:repoId/rules/:type ──
  fastify.put<{ Params: RuleParams; Body: UpdateRuleBody }>(
    '/api/repos/:repoId/rules/:type',
    async (request, reply) => {
      const { repoId, type } = request.params;
      const { content } = request.body;
      const repo = getRepo(repoId);
      if (!repo) return reply.status(404).send({ error: 'Repo not found' });
      if (!isValidRuleType(type)) return reply.status(400).send({ error: `Invalid rule type: ${type}` });

      fastify.db
        .prepare('INSERT OR REPLACE INTO config (key, value) VALUES (?, ?)')
        .run(ruleKey(repoId, type), JSON.stringify({ content }));

      return reply.send({ success: true, type });
    },
  );

  // ── POST /api/repos/:repoId/rules/:type/reset ──
  fastify.post<{ Params: RuleParams }>(
    '/api/repos/:repoId/rules/:type/reset',
    async (request, reply) => {
      const { repoId, type } = request.params;
      const repo = getRepo(repoId);
      if (!repo) return reply.status(404).send({ error: 'Repo not found' });
      if (!isValidRuleType(type)) return reply.status(400).send({ error: `Invalid rule type: ${type}` });

      fastify.db
        .prepare('DELETE FROM config WHERE key = ?')
        .run(ruleKey(repoId, type));

      return reply.send(buildRuleResponse(repoId, type));
    },
  );
}
```

**Step 3: Register the plugin in the Fastify server**

In `src/server/index.ts`:

```typescript
import ruleRoutes from './api/rules.js';

// Inside the server setup:
fastify.register(ruleRoutes);
```

**Step 4: Ensure the `repos` table has the `platform` column**

The `repos` table (from EPIC-001) should already have a `platform TEXT` column. Verify it exists:

```sql
-- Expected schema (already created in EPIC-001):
CREATE TABLE repos (
  id TEXT PRIMARY KEY,
  path TEXT NOT NULL,
  name TEXT NOT NULL,
  languages TEXT,       -- JSON array
  platform TEXT,        -- 'claude-code', 'cursor', 'windsurf', etc.
  injected_at TEXT,
  created_at TEXT,
  last_scan_at TEXT
);
```

### 3.3 API Contract

| Method | Path | Request Body | Response | Status Codes |
|--------|------|-------------|----------|--------------|
| `GET` | `/api/repos/:repoId/rules` | — | `RulesListResponse` | 200, 404 |
| `GET` | `/api/repos/:repoId/rules/:type` | — | `RuleResponse` | 200, 400, 404 |
| `PUT` | `/api/repos/:repoId/rules/:type` | `{ content: string }` | `{ success: true, type }` | 200, 400, 404 |
| `POST` | `/api/repos/:repoId/rules/:type/reset` | — | `RuleResponse` (default content) | 200, 400, 404 |

**Valid rule types**: `claude-md`, `cursorrules`, `windsurfrules`, `agents-md`, `lessons-md`

---

## 4. Definition of Done (The Gate)
- [ ] `src/server/api/rules.ts` exists and exports a Fastify plugin with all 4 routes.
- [ ] `GET /api/repos/:repoId/rules` returns the platform-specific rule and LESSONS.md based on the repo's `platform` field.
- [ ] `displayName` is correct per platform (CLAUDE.md, .cursorrules, .windsurfrules, AGENTS.md, LESSONS.md).
- [ ] `GET /api/repos/:repoId/rules/:type` returns custom override when it exists, default template otherwise.
- [ ] `PUT` saves custom rule content to the `config` table with key `rules:{repoId}:{type}`.
- [ ] `POST .../reset` removes the custom override and returns the default template content.
- [ ] Invalid rule types return 400; non-existent repos return 404.
- [ ] Plugin is registered in `src/server/index.ts`.
- [ ] TypeScript compiles with no errors (`npx tsc --noEmit`).
